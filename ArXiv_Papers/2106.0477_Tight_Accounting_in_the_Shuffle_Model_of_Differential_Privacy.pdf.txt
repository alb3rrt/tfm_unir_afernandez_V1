arXiv:2106.00477v1 [cs.CR] 1 Jun 2021

Tight Accounting in the Shuffle Model of Differential Privacy
Antti Koskela1, Mikko Heikkil¨a2 and Antti Honkela1
1 Helsinki Institute for Information Technology HIIT, Department of Computer Science, University of Helsinki, Finland
2 Helsinki Institute for Information Technology HIIT, Department of Mathematics and Statistics, University of Helsinki, Finland
Abstract
Shuffle model of differential privacy is a novel distributed privacy model based on a combination of local privacy mechanisms and a trusted shuffler. It has been shown that the additional randomisation provided by the shuffler improves privacy bounds compared to the purely local mechanisms. Accounting tight bounds, especially for multi-message protocols, is complicated by the complexity brought by the shuffler. The recently proposed Fourier Accountant for evaluating (, )-differential privacy guarantees has been shown to give tighter bounds than commonly used methods for non-adaptive compositions of various complex mechanisms. In this paper we show how to compute tight privacy bounds using the Fourier Accountant for multi-message versions of several ubiquitous mechanisms in the shuffle model and demonstrate looseness of the existing bounds in the literature.
1 Introduction
Our focus is on differential privacy (DP) in the shuffle model, a distributed privacy model which sits between the high trust-high utility centralised DP, and the low trust-low utility local DP (LDP). In the shuffle model, the individual results from local randomisers are only released through a trusted shuffler. This additional randomisation, known as amplification by shuffling, has been shown to result in better privacy bounds against adversaries without access to the unshuffled local results.
We consider both single and multi-message protocols, where by multi-message protocol we mean a protocol where the subsequent user-wise mechanisms depend on the same data set but are otherwise independent of each other, and at each round the results from the local randomisers are independently shuffled. A similar multi-message protocol definition has been considered, e.g., by Balle et al. (2020, recursive protocol).
In this paper we show how the privacy loss distribution (PLD) formalism and fast Fourier transform (FFT) based numerical accounting can be employed for tight privacy analysis of both single and multimessage shuffle DP mechanisms. To our knowledge, ours is the only existing method enabling tight privacy accounting for multi-message protocols in the shuffle model. We demonstrate that thus obtained bounds are always better, and often far superior, to the existing bounds from the literature.
By using the tight privacy bounds we can also evaluate how significantly adversaries with varying capabilities differ in terms of the resulting privacy bounds. That is, we can effectively quantify the value of information in terms of privacy by comparing tight privacy bounds under varying assumptions.
1

1.1 Our contribution
Our main contribution is to show how the PLD formalism combined with the Fourier accountant can be used in the shuffle model of DP for several common privacy mechanisms. This provides an efficient method for numerically calculating tight privacy bounds for shuffled mechanisms.
We show that our method is applicable both for single as well as for multi-message protocols. We demonstrate that our approach leads to better bounds, often significantly, than the existing ones in the literature.
We also show how tight privacy bounds can be used for evaluating the price of information in terms of privacy by comparing tight privacy bounds resulting from assuming adversaries with varying views to the protocol.
1.2 Related work
DP was originally defined in the central model assuming a trusted aggregator by Dwork et al. (2006), while the fully distributed LDP was formally introduced and analysed by Kasiviswanathan et al. (2011). Closely related to the shuffle model of DP, Bittau et al. (2017) proposed the Encode, Shuffle, Analyze framework for distributed learning, which uses the idea of trusted shuffler for enhancing privacy. The shuffle model of DP was formally defined by Cheu et al. (2019), who also provided the first separation result showing that the shuffle model is strictly between the central and the local models of DP. Characterising the exact nature of this separation has been the aim of many subsequent works as well, as demonstrated by a recent survey (Cheu, 2020).
There exists several papers on privacy amplification by shuffling, some of which are central to this paper. Erlingsson et al. (2019) showed that the introduction of a trusted shuffler amplifies the privacy guarantees against an adversary, who is not able to access the outputs from the local randomisers but only sees the shuffled output. Balle et al. (2019) improved the amplification results and introduced the idea of privacy blanket, which we also utilise in our analysis of k-randomised response in Section 5. We compare our bounds with those of Balle et al. (2019) in Section 5.1. Feldman et al. (2020) used a related idea of hiding in the crowd to improve on the previous results, while Girgis et al. (2021) generalised shuffling amplification further to scenarios with multiple messages and parties with more than one local sample under simultaneous communication and privacy restrictions. We use some results of Feldman et al. (2020) in the analysis of general LDP mechanisms and also compare our bounds with theirs in Section 6. It should be possible to use our approach in calculating tight privacy bounds also in the the setting considered by Girgis et al. (2021), but since their assumptions deviate markedly from the other ones, we leave this to further work.
2 Background
Before analysing the shuffled mechanisms we need to introduce some theory and notations. With apologies for conciseness, we start by defining DP and PLD, and finish with the Fourier accountant. For more details, we refer to (Koskela et al., 2021).
2.1 Differential privacy and privacy loss distribution
An input data set containing n data points is denoted as X = (x1, . . . , xn)  X n, where xi  X , 1  i  n. We say X and X are neighbours if we get one by substituting one element in the other (denoted X  X ).
2

Definition 1. Let  > 0 and   [0, 1]. Let P and Q be two random variables taking values in the same measurable space O. We say that P and Q are (, )-indistinguishable, denoted P (,) Q, if for every measurable set E  O we have
Pr(P  E)  e Pr(Q  E) +  and Pr(Q  E)  e Pr(P  E) + .

Definition 2. Let  > 0 and   [0, 1]. Mechanism M : X n  O is (, )-DP if for every X  X : M(X) (,) M(X ). We call M tightly (, )-DP, if there does not exist  <  such that M is (,  )-DP.
Definition 3. Let  > 0. Mechanism M : X  O is -LDP if for every pair of data points X, X  X : M(X) (,0) M(X ).
We consider discrete-valued mechanisms M which can be seen as mappings from X n to the set of discrete-valued random variables. The generalised probability density functions of M(X) and M(X ), denoted fX (t) and fX (t), respectively, are given by

fX (t) =

i aX,i · tX,i (t), fX (t) =

i

aX

,i

·

tX

(t),
,i

(2.1)

where t(·), t  Rd, denotes the Dirac delta function centred at t, and tX,i, tX ,i  Rd and aX,i, aX ,i  0. The privacy loss distribution is defined as follows.

Definition 4. Let M : X n  O, O  Rd, be a discrete-valued randomised mechanism and let fX (t) and fX (t) be generalised probability density functions as defined by (2.1). We define the generalised privacy loss distribution (PLD) X/X as

X/X (s) =

tX,i=tX ,j aX,i · si (s),

si = log

aX,i aX ,j

.

(2.2)

The following theorem by Koskela et al. (2021) shows that the tight (, )-bounds for compositions of non-adaptive mechanisms are obtained using convolutions of PLDs (see also Sommer et al., 2019).

Theorem 5. Consider an nc-fold non-adaptive composition of a mechanism M. The composition is tightly (, )-DP for () given by

() = max {X/X (), X /X ()},
X X

where



X/X () = 1 - 1 - X/X () nc +

(1 - e -s) X/X nc X/X (s) ds,



(2.3)

X/X () =

P(M(X) = ti)
{ti : P(M(X)=ti)>0, P(M(X )=ti)=0}

and X/X nc X/X denotes the nc-fold convolution of the density function X/X (an analogous expression holds for X /X ()).

In this work, finding the pair of outputs M(X) and M(X ) that give the maximum () will be clear from the context, and thus finding the tight (, )-bounds amounts to analysing a given pair of random variables P and Q corresponding to neighbouring data sets.

3

2.2 Fourier accountant
In order to find tight privacy bounds efficiently given PLDs, we use the Fourier accountant (Koskela et al., 2020, 2021). Similarly as Koskela et al. (2021), we place the PLD on a grid m = {z0, . . . , zm-1}  R, m  Z+, where zi = -L + iz, z = 2L/m. Suppose the distribution  of the PLD is of the form

(s) = i ai · si (s),

(2.4)

where ai  0 and -L  si  L - z for all i. The integral Es(s)[(1 - e -s)] then leads to the tight ()-value (see the Supplements). We define the grid approximations as

L(s) :=

m-1
i=0 ai · sLi (s),

R(s) :=

m-1
i=0 ai · sRi (s),

(2.5)

where

sLi = max{z  m : z  si}, sRi = min{z  m : z  si}.

We then get the following (Koskela et al., 2021) :

Lemma 6. Consider an nc-fold composition with the corresponding PLD  (as in Eq. 2.4). Let L() and R() correspondingly be determined by convolutions of L and R.Then for all  > 0 :

L()  ()  R().

Algorithm 1 depicts the Fourier Accountant (see Koskela et al. 2021 for more details). Using it, we compute strict ()-bounds as follows: using values L > 0 and m  Z+, we form a grid m and place the PLD  on m to obtain L and R. We then approximate L() and R() using Alg. 1. The error analysis provided by Koskela et al. (2021) bounds the error incurred by Alg. 1 and leads to strict upper
and lower bounds for (). When the upper and lower bounds coincide, we know that the bound is tight
for the chosen level of precision.

Algorithm 1 Fourier accountant algorithm for discrete-valued mechanisms

Input: generalised distribution  of the form (2.4), such that m is even and si = -L+iz, 0  i  m-1,

z = 2L/m, number of compositions nc.

Set

a = a0

...

am-1 T ,

D=

. 0 Im/2
Im/2 0

Evaluate the convolutions using FFT:

bnc = D F -1 F (Da) nc .

Approximate ():

()  1 - (1 - X/X ())nc +

n-1 1 - e -(-L+ z) bnc ,
=

 = min{  N : -L + z > }.

In the next sections we construct the PLD  for different shuffling mechanisms. This means that in each case we search a pair of random variables P and Q that lead to a tight (, )-DP bound.
4

3 From single message to multi-message protocols

Before analysing any concrete mechanisms, we first give a simple argument showing how to calculate tight privacy bounds for multi-message shuffle protocols based on the neighbouring random variables calculated for the single-message case.

Theorem 7. Let M be a DP mechanism in the shuffle model of DP s.t. the (, )-guarantees are exactly determined by the (, )-indistinguishability of random variables P and Q corresponding to the neighbouring data sets. Then the multi-message protocol given by running M on a fixed data set for nc rounds is (, )-DP if nc-wise compositions of P and Q are (, )-indistinguishable, i.e., if

(P, . . . , P ) (,) (Q, . . . , Q).

nc times

nc times

Proof. Since the data set and the mechanism M are fixed (implying that the shufflers and the local randomisers are fully independent over the rounds), the multi-message protocol corresponds to nc nonadaptive compositions of the mechanism M. Looking at M as a mapping from the data space to the set of random variables, the resulting random variables are the same P or Q for each round as the mechanism and the data are fixed. Therefore, (P, . . . , P ) (,) (Q, . . . , Q) implies that the non-adaptive nc-wise composition of M is (, )-DP.

4 Shuffled binary randomised response

We first analyse shuffled binary randomised response (2-RR) to demonstrate concretely how to obtain

tight privacy bounds. The pair of distributions P and Q leading to a tight (, )-bound is obtained

by considering the following worst-case: let the neighbouring data sets be X, X  {0, 1}n, where all

elements in X are 0's, and in X one element is 1. Seeing the shuffler output is equivalent to seeing

the total perturbed sum. Considering an 0-LDP binary randomised response, each bit is flipped with

probability

p

=

e

1 0 +1

.

Thus,

for

the

number

of

1's,

the

analyser

is

observing

two

distributions

P2RR  Bin n, p and Q2RR = Q1 + Q2,

(4.1)

where Q1  Bin n - 1, p and Q2  Bern 1 - p . By the post-processing property of differential privacy, the total mechanism is (, )-DP if P2RR (,) Q2RR.

4.1 PLD for the shuffled binary randomised response

To find tight (, )-DP bound for 2-RR, we first determine the PLD for P2RR and Q2RR as follows (see also Koskela et al., 2021, Section 6.2). The neighbouring distributions are given by

nn

fP (t) =

i

i=0

n-1

fQ(t) = p ·

i=0

pi(1 - p)n-ii(t),

n-1 i

n-1
pi(1 - p)n-1-ii(t) + (1 - p) ·

i=0

n-1 i

pi(1 - p)n-1-ii+1(t).

5

Then, we see from Def. (4) that the PLD Q/P is of the form

Q/P (s) =

n
i=0 ai · si (s),

ai = fQ(i),

si

=

log

fQ fP

(i) (i)

.

Moreover, we see from the definition given in Eq. (2.3) that P/Q() = 0. Determining the privacy loss distribution P/Q can be done analogously. We can then directly apply the Fourier accountant to P/Q and Q/P to obtain the tight (, )-bound.

5 Shuffled k-randomised response

Balle et al. (2019) give a protocol for n parties to compute a private histogram over the domain [k] in
the single-message shuffle model. The randomiser is parameterised by a probability , and consists of a
k-ary randomised response mechanism (k-RR) that returns the true value with probability 1 - . Denote this k-RR randomiser by RP,Hk,n and the shuffling operation by S. Thus, we are studying the privacy of the shuffled randomiser M = S  RP,Hk,n.
Consider first the proof of Balle et al. (2019, Thm. 3.1). Assuming without loss of generality that the differing data element between X and X , X, X  [k]n, is xn, the (strong) adversary As used by Balle et al. (2019, Thm. 3.1) is defined as follows:

Definition 8. Let M = S  RP,Hk,n be the shuffled k-RR mechanism, and w.l.o.g. let the differing element be xn. We define adversary As as an adversary with the view
ViewAMs (X) = (x1, . . . , xn-1),   {0, 1}n, (y(1), . . . , y(n)) ,

where  is a binary vector identifying which parties answered randomly, and  is a uniformly random permutation applied by the shuffler.

Assuming w.l.o.g. that the differing element xn = 1 and xn = 2, the proof then shows that for any

possible view V

of the adversary As,

P(ViewA Ms (X)=V ) P(ViewA Ms (X )=V )

=

n1 n2

,

where

ni

denotes

the

number

of

messages

received by the server with value i after removing from the output Y any truthful answers submitted by

the first n - 1 users. Moreover, it is shown that the corresponding random variables

N1  Ps and N2  Qs,

where





Ps = Bin

n - 1, k

+ 1,

and

Qs = Bin

n - 1, k

.

(5.1)

Thus, ViewAMs (X) (,) ViewAMs (X ) if Ps (,) Qs. Balle et al. (2019) showed that for adversary As the shuffled mechanism M = S  RP,Hk,n is (, )-DP

for any k, n  N,   1 and   (0, 1] such that  = max

14·k·log(2/) (n-1)·2

,

27·k (n-1)·

.

5.1 Tight bounds for varying adversaries using Fourier accountant
By the reasoning of the proof of Balle et al. (2019, Thm. 3.1) and by the post-processing property, for adversary As (see Def. 8), Ps (,) Qs for Ps and Qs given in Eq. (5.1) implies that the shuffled k-RR mechanism M = S  RP,Hk,n is (, )-DP. We can therefore immediately calculate tight bounds for the

6

k-RR mechanism RP,Hk,n for adversary As using Fourier accountant by considering the aforementioned pair of random variables.
Having tight privacy bounds also enables us to evaluate exactly how much different assumptions on the adversary cost us in terms of privacy. For example, instead of the adversary As we can analyse a weaker adversary Aw, who has extra information only on the first n - 1 parties, defined as follows:
Definition 9. Let M = S  RP,Hk,n be the shuffled k-RR mechanism, and w.l.o.g. let the differing element be xn. Adversary Aw is an adversary with the view
ViewAMw (X) = (x1, . . . , xn-1),   {0, 1}n-1, (y(1), . . . , y(n)) ,

where  is a binary vector identifying which of the first n - 1 parties answered randomly, and  is a uniformly random permutation applied by the shuffler.

Note that compared to the stronger adversary As formalised in Def. 8 the difference is only in the
vector . We write b = i i, and B for the corresponding random variable in the following. The next theorem gives the random variables we need to calculate privacy bounds for adversary Aw:

Theorem 10. Assume w.l.o.g. differing elements xn = 1, xn = 2, and adversary Aw as given in Def. 9. To find a tight DP bound for M = S  RP,Hk,n we can equivalently analyse the random variables Pw, Qw defined as
 Pw = P1 + P2, P1  (1 - ) · N1|B, P2  k · (B + 1),
 Qw = Q1 + Q2, Q1  (1 - ) · N2|B, Q2  k · (B + 1),

where

B  Bin(n - 1, ), NiB|B  Bin(B, 1/k), i = 1, . . . , k, N1|B = N1B|B + Bern(1 -  + /k) and N2|B = N2B|B + Bern(/k).

Proof. Notice that for k-RR, seeing the shuffler output is equivalent to seeing the total counts for each

class resulting from applying the local randomisers to X or X . The adversary Aw can remove all

truthfully reported values by client j, j  [n - 1]. Denote the observed counts after this removal by

ni, i = 1, . . . , k, so

k i=1

ni

=

b + 1.

Using

standard

techniques

and

deferring

the

details

to

the

Appendix

we now have

P(ViewAMw (X) = V )

k
= P(N1 = n1, . . . , Ni = ni - 1, . . . , Nk = nk|b) · P(RP,Hk,n(xn) = i) · P(B = b)

i=1

b

b(1 - )n-1-b



= n1, n2, . . . , nk

kb

n1(1 - ) + k (b + 1) ,

where the second equation comes from the fact that the random values in k-RR follow a Multinomial

distribution.

Noting

then

that

P(RP,Hk,n(xn) = i) = (1 -  +

 k

)

when

i

=2

and

 k

otherwise,

repeating

7

essentially the same steps gives

P(ViewAMw (X ) = V )

k
= P(N1 = n1, . . . , Ni = ni - 1, . . . , Nk = nk|b) · P(RP,Hk,n(xn) = i) · P(B = b)

i=1

b

b(1 - )n-1-b



= n1, n2, . . . , nk

kb

n2(1 - ) + k (b + 1) .

Looking at ratio of the two final probabilities we have

PV ViewA Mw (X)

P(ViewAMw (X) = V ) P(ViewAMw (X ) = V )



e

=P

N1|B N2|B

· ·

(1 (1

- -

) )

+ +

 k

(B

 k

(B

+ +

1) 1)



e

,

where we write Ni|B, i  {1, 2} for the random variable Ni conditional on B. This shows that for DP bounds, the adversaries' full view is equivalent to only considering the joint distribution of Ni, B, i  {1, 2}, and we can therefore analyse the neighbouring random variables

Pw = P1 + P2, Qw = Q1 + Q2,

P1  (1 - ) · N1|B, Q1  (1 - ) · N2|B,

 P2  k · (B + 1),
 Q2  k · (B + 1).

(5.2)

Writing nBi for the count in class i resulting from the noise sent by the n - 1 parties, from k-RR definition we also have

B  Bin(n - 1, ) and NiB|B  Bin(B, 1/k), i = 1, . . . , k. As V  ViewAMw (X), we finally have
N1|B = N1B|B + Bern(1 -  + /k) and N2|B = N2B|B + Bern(/k).

(5.3) (5.4)

The distributions (5.3) and (5.4) determine the neighbouring distributions Pw and Qw given in (5.2) which completes the proof.

Figure 1 shows an empirical comparison of the tight bounds obtained with Fourier accountant assuming the stronger adversary As, which leads to the neighbouring random variables Ps, Qs from (5.1), or the weaker adversary Aw, corresponding to Pw, Qw from Thm 10, together with the loose analytic bounds from Balle et al. (2019, Thm. 3.1). As shown in the Figure, the tight bounds are considerably better than the analytic one. There is also a clear difference in the tight bounds resulting from assuming either the strong adversary As or the weaker Aw. The analytic bound can be used with multi-message protocols via advanced composition (Dwork and Roth, 2014). We defer this comparison to the Supplement.

6 General shuffled 0-LDP mechanisms
Feldman et al. (2020) consider general 0-LDP local randomisers combined with a shuffler. The analysis is based on decomposing individual LDP contributions to mixtures of data dependent part and noise,

8

2.5

FA, Ps and Qs, nc = 16

FA, Ps and Qs, nc = 4

FA, Ps and Qs, nc = 1

2.0

FA, Pw and Qw, nc = 16

FA, Pw and Qw, nc = 4

FA, Pw and Qw, nc = 1

1.5

Balle et al., Thm 3.1, nc = 1

1.0

0.5

10-7

10-6

10-5 

10-4

10-3

Figure 1: Shuffled single and multi-message k-randomised response: tight bounds are significantly better than the existing analytic one. Tight (, )-DP bounds obtained using the Fourier accountant (FA) for different number of messages nc, and the loose analytical bound from Balle et al. (2019, Thm. 3.1) for a single message. We apply FA to distributions Ps and Qs of equation (5.1), and to Pw and Qw of Thm 10; both are tight bounds under the assumed adversary. FA with Ps, Qs and nc = 1 is the tight bound with the same assumptions as used in the loose analytic bound. Total number of users n = 1000, probability of randomising for each user  = 0.25, and k = 4. To obtain the upper bounds using FA, we used parameter values L = 20 and m = 107.

9

which leads to finding (, )-bound for the 2-dimensional distributions (see Remark 3.5 of Feldman et al.,

2020)

P = (A + , C - A) and Q = (A, C - A + ),

(6.1)

where

C  Bin(n - 1, e -0 ),

A



Bin(C,

1 2

)

and

  Bern

e 0 e 0 +1

,

(6.2)

n  N, p  [0, 1]. We can therefore get bounds for general shuffled (0, 0)-LDP mechanisms with the Fourier accountant by finding the PLD for the distributions P, Q in Eq. (6.1). Note that even though our (, )-bound is tight for P and Q, since the bound applies to any shuffled (0, 0)-LDP mechanism it need not be tight for a specific mechanism like the shuffled k-RR. In the Supplements we give also comparisons of the tight bounds obtained with P and Q of (6.1) and with those of the weak k-RR adversary (Sec. 5).

6.1 PLD for shuffled (, 0)-LDP mechanisms

As already noted, we can find the PLD for general shuffled (0, 0)-LDP mechanisms by analysing the

random variables P, Q in Eq. (6.1). Since this is straight-forward but the details are messy, we simply

state the result here and give the details in the Supplement.

Denoting

q

=

, e 0
e 0 +1

we

see

that

the

distributions

in

(6.1)

are

given

by

the

mixture

distributions

P = q · P1 + (1 - q) · P0, and Q = q · Q1 + (1 - q) · P0,

(6.3)

where

P1 = (A + 1, C - A), P0 = (A, C - A), Q1 = (A, C - A + 1).

(6.4)

From the auxiliary lemma B.1 given in the Supplements we get the following expressions needed for determining the PLD P/Q:

Lemma 11. Let P and Q be defined as in (6.3). Then, when b > 0,

Moreover, for all a,

P(P P(Q

= =

(a, b)) (a, b))

=

q

· q

a b

+

(1

-

q) e -0
1-e -0

n-a-b 2b

+

(1

-

q)

e -0 1-e -0

n-a-b 2b

.

(6.5)

P(P

=

(a, 0))

=

q

·

P(P1

=

(a, 0)) + (1

- q)

· P(P0

=

(a, 0)) .

P(Q = (a, 0))

(1 - q) · P(P0 = (a, 0))

(6.6)

By Lemma B.3 of the Supplements, we have that when a > 0 (and j = a - 1, i = a + b - 1),

e -0 n - a - b

n-1

P(P = (a, b)) =

q + (1 - q) · 1 - e -0

2a

· i

i j

pi

(1

-

p)n-1-i

1 2i

.

(6.7)

When a = 0, we directly see from (6.4) that P(P1 = (a, b)) = 0 and n-1
P(P = (a, b)) = (1 - q) · P(P0 = (0, b)) = (1 - q) · b

p

b
(1 - p)n-1-b.

2

(6.8)

Using (6.7) and (6.8) we determine the probabilities P(P = (a, b)) and obtain the PLD

P/Q(s) =

P(P
a,b

=

(a, b)) · sa,b (s),

(6.9)

10

where sa,b = log

P(P =(a,b)) P(Q=(a,b))

is given by Lemma 11. Moreover, we see from (6.1) and (6.2) that

P/Q() =

P(P = (a, b)) = P(A +  = n) =

{(a,b) : P(Q=(a,b))=0)}

1 n-1 e -(n-2)0

2

e 0 + 1 .

Determining Q/P and Q/P () can be carried out analogously. Then, using the PLDs P/Q and Q/P and the probabilities P/Q() and Q/P (), tight numerical bounds are obtained.

6.2 Efficient grid approximation using Hoeffding's inequality and total complexity

The PLD (6.9) has O(n2) terms and thus placing the mass on a numerical grid m in the Fourier Accountant becomes expensive for large values of the discretisation parameter m. Using an appropriate tail bound for the binomial distribution, we can neglect part of the mass and simply add it to . As A is conditioned on C, we use a tail bound on C to reduce the number of terms. We use Hoeffding's inequality which for C  Bin(n - 1, p) states that for c > 0,

P C  (p - c)(n - 1)  exp - 2(n - 1)c2 , P C  (p + c)(n - 1)  exp - 2(n - 1)c2 .

Requiring that the neglected mass is smaller than some prescribed tolerance  (e.g.  = 10-12), we

consider the set Sc = [max 0, (p - c)(n - 1) , min n - 1, (p + c)(n - 1) ], where c =

log 2/ 2(n-1)

,

and

make an approximation i,j  iS when forming the PLD (6.9) (notice the change of variables (a, b)  (i, j) in Section 6.1). Moreover, as A  Bin(C, 1/2), when summing over j's we can make a

similar approximation. We see that these approximations drop the complexity of forming the PLD from

O(n2) to O(n · log 2/ ). Experimentally, we found that the cost of forming the PLD dominated the cost

of FFT already for n = 1000.

6.3 Experimental comparison to the numerical method of Feldman et al. (2020)
Figure 2 shows a comparison between the PLD approach and the numerical method proposed by Feldman et al. (2020). We see that for a single message the results given by this method are not far from the results given by the Fourier Accountant (FA). This is expected as their method aims for giving an accurate upper bound for the so-called hockey-stick divergence between P and Q, which is equivalent to what FA does. However, the method of Feldman et al. (2020) only works for single-message protocols, whereas FA also gives tight bounds for multi-message protocols. In the Supplements we give results also for the cases n = 105, 106. We emphasise here that FA gives strict upper (, )-bounds. One deficit of our approach is the slightly increased computational cost: in case of a single-message protocol, evaluating tight bounds for n = 106 took approximately 4 times longer than using the method of Feldman et al. (2020), taking approximately one minute on a standard CPU. As the main cost of our approach consists of forming the PLD, the overhead cost of computing guarantees for compositions is small.

7 Discussion
We have showed how Fourier accounting can be used to calculate tight upper and lower bounds for various (, )-DP mechanisms and different adversaries in the shuffle model. An alternative approach would be

11

10-1

10-3

10-5



10-7

10-9 10-11

Numerical method by Feldman et al. FA, nc = 1 FA, nc = 2 FA, nc = 3 FA, nc = 4

0.2

0.4

0.6

0.8

1.0

Figure 2: Evaluation of () for general single and multi-message shuffled (0, 0)-LDP mechanisms: for
single message protocols the numerical method by Feldman et al. (2020) is close to the tight bounds from
FA (nc = 1). Their method is not directly applicable to multi-message protocols, for which FA also gives tight bounds. Number of users n = 104 and the LDP parameter 0 = 4.0. To obtain the upper bounds using FA, we used parameter values L = 20 and m = 107.

12

to use the R´enyi differential privacy (Mironov, 2017). However, as illustrated by Koskela et al. (2020, 2021), for non-adaptive compositions the PLD formalism generally leads to considerably tighter bounds, especially when a small number of compositions is considered.
Our tight numerical bounds are often significantly better than the existing analytical bounds taken from the literature. We emphatically do not claim that (loose) analytical bounds are bad or irrelevant as such; numerical methods do not show optimality or limits of DP algorithms, and numerical accounting comes with a built-in trade-off between tightness of the bounds and the amount of compute available. Our main overarching argument is rather that we also need to care about the constants and consider if the assumed adversary models are suitable for the task at hand. DP makes visible and quantifies the unavoidable trade-off between utility and privacy, but too loose bounds or adversaries with too much or too little power skew this trade-off resulting in unhelpful or simply wrong conclusions.
Acknowledgements
This work has been supported by the Academy of Finland [Finnish Center for Artificial Intelligence FCAI and grant 325573] and by the Strategic Research Council at the Academy of Finland [grant 336032].
13

References
Balle, B., Bell, J., Gasc´on, A., and Nissim, K. (2019). The privacy blanket of the shuffle model. In Annual International Cryptology Conference, pages 638­667. Springer.
Balle, B., Bell, J., Gasc´on, A., and Nissim, K. (2020). Private summation in the multi-message shuffle model. In Proceedings of the 2020 ACM SIGSAC Conference on Computer and Communications Security, pages 657­676.
Bittau, A., Erlingsson, U´ ., Maniatis, P., Mironov, I., Raghunathan, A., Lie, D., Rudominer, M., Kode, U., Tinnes, J., and Seefeld, B. (2017). Prochlo: Strong privacy for analytics in the crowd. In Proceedings of the 26th Symposium on Operating Systems Principles, pages 441­459.
Cheu, A. (2020). Differential privacy in the shuffle model: A survey of separations. Available at https: //www.ccis.northeastern.edu/home/albertcheu/survey-aug18.pdf.
Cheu, A., Smith, A., Ullman, J., Zeber, D., and Zhilyaev, M. (2019). Distributed differential privacy via shuffling. In Annual International Conference on the Theory and Applications of Cryptographic Techniques, pages 375­403. Springer.
Dwork, C., McSherry, F., Nissim, K., and Smith, A. (2006). Calibrating noise to sensitivity in private data analysis. In Proc. TCC 2006, pages 265­284.
Dwork, C. and Roth, A. (2014). The algorithmic foundations of differential privacy. Found. Trends Theor. Comput. Sci., 9(3­4):211­407.
Erlingsson, U´ ., Feldman, V., Mironov, I., Raghunathan, A., Talwar, K., and Thakurta, A. (2019). Amplification by shuffling: From local to central differential privacy via anonymity. In Proceedings of the Thirtieth Annual ACM-SIAM Symposium on Discrete Algorithms, pages 2468­2479. SIAM.
Feldman, V., McMillan, A., and Talwar, K. (2020). Hiding among the clones: A simple and nearly optimal analysis of privacy amplification by shuffling. arXiv preprint arXiv:2012.12803.
Girgis, A., Data, D., Diggavi, S., Kairouz, P., and Suresh, A. T. (2021). Shuffled model of differential privacy in federated learning. In International Conference on Artificial Intelligence and Statistics, pages 2521­2529. PMLR.
Kasiviswanathan, S. P., Lee, H. K., Nissim, K., Raskhodnikova, S., and Smith, A. (2011). What can we learn privately? SIAM Journal on Computing, 40(3):793­826.
Koskela, A., J¨alk¨o, J., and Honkela, A. (2020). Computing tight differential privacy guarantees using FFT. In International Conference on Artificial Intelligence and Statistics, pages 2560­2569. PMLR.
Koskela, A., J¨alk¨o, J., Prediger, L., and Honkela, A. (2021). Tight differential privacy for discrete-valued mechanisms and for the subsampled gaussian mechanism using FFT. In International Conference on Artificial Intelligence and Statistics, pages 3358­3366. PMLR.
Mironov, I. (2017). R´enyi differential privacy. In 2017 IEEE 30th Computer Security Foundations Symposium (CSF), pages 263­275.
Sommer, D. M., Meiser, S., and Mohammadi, E. (2019). Privacy loss classes: The central limit theorem in differential privacy. Proceedings on Privacy Enhancing Technologies, 2019(2):245­269.
14

A More detailed derivation of the probabilities for k-ary RR

Recall from Section 5.1 of the main text: we consider the case where the adversary sees a vector  of

length n - 1 identifying clients who submit only noise, except for the client with the differing element,

and write b = i i. The adversary can remove all truthfully reported values by the clients [n - 1].

Denote the observed counts after removal by ni, i = 1, . . . , k, so

k i=1

ni

=

b

+

1,

and

write

R

for

the

local randomiser. We now have

P(ViewAMw (x) = V )

k

= P(N1 = n1, . . . , Ni = ni - 1, Ni+1 = ni+1, . . . , Nk = nk|B) · P(R(xn) = i) · P(B = b)

i=1

b =
n1 - 1, n2, . . . , nk

1 b · (1 -  +  ) · b(1 - )n-1-b . . .

k

k

k

b

+

i=2 n1, . . . , ni - 1, ni+1, . . . , nk

1 b ·  · b(1 - )n-1-b kk

b

b(1 - )n-1-b



k

= n1, n2, . . . , nk

kb

n1(1 -  + k ) + ni k
i=2

b

b(1 - )n-1-b





= n1, n2, . . . , nk

kb

n1(1 -  + k ) + (b + 1 - n1) k

b

b(1 - )n-1-b



= n1, n2, . . . , nk

kb

n1(1

-

)

+

(b k

+

1)

.

Noting

that

P(R(xn) = i) = (1 -  +

 k

)

when

i=2

and

 k

otherwise,

repeating

essentially

the

above

steps gives

P(ViewAMw (x ) = V )

k

= P(N1 = n1, . . . , Ni = ni - 1, Ni+1 = ni+1, . . . , Nk = nk|B) · P(R(xn) = i) · P(B = b)

i=1

b

b(1 - )n-1-b



= n1, n2, . . . , nk

kb

n2(1

-

)

+

(b k

+

1)

.

B Auxiliary results for Section 6

We here give the proofs for the auxiliary results used in Section 6. Recall from Section 6: we consider the 2-dimensional distributions

P = (A + , C - A) and Q = (A, C - A + ),

(B.1)

where

C  Bin(n - 1, e -0 ),

A



Bin(C,

1 2

)

and

  Bern

e 0 e 0 +1

,

(B.2)

15

n  N, p  [0, 1]. Denoting p = e -0 , this means that

P(C = i) =

n - 1 pi(1 - p)n-1-i i

and

P(A = j|C = i) =

i j

1 2i .

Denoting

q

=

, e 0
e 0 +1

we

see

that

the

distributions

in

(B.1)

are

given

by

the

mixture

distributions

P = q · P1 + (1 - q) · P0

(B.3)

and

Q = q · Q1 + (1 - q) · P0,

(B.4)

where

P1 = (A + 1, C - A), P0 = (A, C - A), Q1 = (A, C - A + 1).

(B.5)

To determine the probability ratios of P and Q in Lemma 11 of the main text, we need the following auxiliary result.

Lemma B.1. When b > 0 and 0  a + b  n, we have: a
P(P1 = (a, b)) = b · P(Q1 = (a, b)) and
e -0 n - a - b P(P0 = (a, b)) = 1 - e -0 2b · P(Q1 = (a, b)). Proof. For the first part, we see that P1 = (a, b) if and only if A = a - 1 and C = a + b - 1. Since

a+b-1 1 P(A = a - 1 | C = a + b - 1) = a - 1 2a+b-1

a a+b-1 1

=· b

a

2a+b-1

a = b · P(A = a | C = a + b - 1),

we see that

P(P1 = (a, b)) = P(C = a + b - 1) · P(A = a - 1 | C = a + b - 1) a
= P(C = a + b - 1) · b · P(A = a | C = a + b - 1) a
= b · P(Q1 = (a, b)).

For the second part, we use the fact that

a+b 1 a+b 1 a+b-1

P(A = a | C = a + b) =

a

2a+b =

b

·· 2

a

a+b = 2b · P(A = a | C = a + b - 1)

1 2a+b-1

16

and for i > 0,

P(C = i) =

n - 1 pi(1 - p)n-1-i = n - i

i

i

n-i p = i · 1 - p · P(C = i - 1),

n-1 i-1

· p · pi-1(1 - p)n-1-(i-1) 1-p

to find that

P(P0 = (a, b)) = P(C = a + b) · P(A = a | C = a + b)
e -0 1 n - a - b = 1 - e -0 2 b · P(C = a + b - 1) · P(A = a | C = a + b - 1)
e -0 n - a - b = 1 - e -0 · 2b · P(Q1 = (a, b)).

(B.6)

From Lemma B.1 we get the following expression for the log ratios of P and Q. Lemma B.2. Let P and Q be defined as in (B.3) and (B.4), with q = e -0 . Then, when b > 0,

When b = 0, for all a:

P(P P(Q

= =

(a, b)) (a, b))

=

q

· q

a b

+

(1

-

q) e -0
1-e -0

n-a-b 2b

+

(1

-

q)

e -0 1-e -0

n-a-b 2b

.

(B.7)

P(P

=

(a, b))

=

q

·

P(P1

=

(a, b)) + (1

- q)

·

P(P0

=

(a, b)) .

P(Q = (a, b))

(1 - q) · P(P0 = (a, b))

Moreover, when b = 0 and a > 0,

P(P

=

(a, b))

=

q

·2

·

a n-a

·

1-p p

+

(1 - q) ,

P(Q = (a, b))

(1 - q)

and when b = a = 0,

P(P = (a, b)) = 1. P(Q = (a, b))

Proof. The relation (B.7) follows by substituting the expressions of Lemma B.1 to

(B.8)

P(P

=

(a, b))

=

q

· P(P1

=

(a, b)) + (1 - q) · P(P0

=

(a, b)) .

P(Q = (a, b)) q · P(Q1 = (a, b)) + (1 - q) · P(P0 = (a, b))

Looking at the expressions (B.3) and (B.4), using the fact that A  C, we see that when b = 0, for all a,

P(Q1 = (a, 0)) = 0,

(B.9)

17

from which (B.8) follows. When 0 < a < n, using (B.6), we find that

P(P1 = (a, 0)) = P(A = a - 1 | C = a - 1) · P(C = a - 1)

1 a-1

= 2

· P(C = a - 1)

1 a-1 a 1 - p

= 2

·

·

n-a

p

· P(C = a)

1 a a 1-p

=2· 2

·

·

n-a

p

· P(C = a)

a 1-p

=2·

·

n-a

p

· P(A = a | C = a) · P(C = a)

a 1-p

=2·

·

n-a

p

· P(P0 = (a, 0)).

(B.10)

From (B.9) and (B.10) we see that when b = 0 (and 0 < a < n),

P(P = (a, n)) = q · P(P1 = (a, b)) + (1 - q) · P(P0 = (a, b))

P(Q = (a, n))

(1 - q) · P(P0 = (a, b))

=

q

·2·

a n-a

·

1-p p

+ (1

- q) .

(1 - q)

(B.11)

Finally, when a = b = 0, P(Q1 = (a, 0)) = P(P1 = (a, 0)) = 0, showing the last claim.

The

PLD

P /Q

is

determined

by

the

probabilities

P(P

=

(a, b)

and

the

log

ratios

log

P(P =(a,b) P(Q=(a,b)

given

by

Lemma B.1. Furthermore, all these expressions can be determined with P(P0 = (a, b)) and P(P1 = (a, b)),

which can be directly seen from (B.5), (B.2) and Lemma B.1:

Lemma B.3. With change of variables (a, b) = (j + 1, i - j) (i.e., C = i and A = j), we have

n-1 P(P1 = (a, b)) = i

i j

pi(1

-

p)n-1-i

1 2i

,

and when a > 0,

e -0 n - a - b P(P0 = (a, b)) = 1 - e -0 2a P(P1 = (a, b)).

C Experiments

When running experiments using the numerical method proposed by Feldman et al. (2020), we always
used the parameter value S = 1 which gives the most accurate results. To obtain the upper bounds using FA, we always used parameter values L = 20 and m = 107.

C.1 The Shuffled k-Randomised Response (Balle et al., 2019)
We first illustrate the benefits of computing tight bounds using FA in case of k-RR and a strong adversary (distributions Ps and Qs). This is the case considered by Balle et al. (2019). They give the following result for the (, )-guarantees of the shuffled k-RR:

18

Theorem C.1. The shuffled mechanism M = S  RP,Hk,n is (, )-DP for any k, n  N,   1 and   (0, 1] such that

14 · k · log (2/) 27 · k

 = max

(n - 1) · 2

, (n - 1) · 

.

In order to compare the ()-values determined by this bound (for a fixed probability ) and those

given by the Fourier accountant, we first express  as a function of  and . Let   1 and   2 · e -2.

Then,

we

see

that

14·k·log(2/) (n-1)·2



27·k (n-1)·

if

and

only

if





2

·

e-

27 14

,

and

therefore

for

all





1

and





2

·

e -2,

the

-value

in

Thm.

C.1

is

chosen

as



=

14·k·log(2/) (n-1)·2

.

Then,

14 · k · log (2/)

=

.

(n - 1) · 

(C.1)

Figure 3 compares the DP bounds obtained by FA and the bound determined by (C.1). FA gives considerably tighter bounds than the analytical expressions by Balle et al. (2019).

3.5

Fourier Accountant

Fourier Accountant

Balle et al. (2019), Thm 3.1

1.0

Balle et al. (2019), Thm 3.1

3.0

2.5

0.8

2.0

1.5

1.0

0.5

10-7

10-6

10-5

10-4



10-3

10-2

(a) Here n = 103,  = 0.1, k = 5.

0.6

0.4

0.2

0.0 10-7

10-6

10-5

10-4



10-3

10-2

(b) Here n = 104,  = 0.1, k = 5.

Figure 3: Comparison of the DP bounds obtained with FA and the Blanket approach (i.e. the distributions Ps and Qs) and the analytic bound of Thm. C.1.

C.1.1 Multi-message version i.e. compositions of k-RR Next, we illustrate the benefits we obtain from using the Fourier accountant vs. using Thm. C.1 combined with the basic composition result, which states that nc-wise composition of (, )-DP mechanism is (nc, nc)-DP (Figure 4).
C.2 Experiments for Clones - approach, n = 105 and n = 106
In Figures 5 and 6 we evaluate () for a single call of the shuffling mechanism using the numerical method by Feldman et al. (2020), and for nc number of non-adaptive compositions (nc = 1, 2, 3, 4) using the Fourier Accountant applied to a pair of distributions P and Q defined in Section 6.
19

Fourier Accountant, nc = 1

4

Fourier Accountant, nc = 2

Fourier Accountant, nc = 4

Balle et al. (2019) Thm 3.1 + Basic Comp., nc = 1

3

Balle et al. (2019) Thm 3.1 + Basic Comp., nc = 2

Balle et al. (2019) Thm 3.1 + Basic Comp., nc = 4

2

1

0 10-7

10-6

10-5

10-4 

10-3

10-2

Figure 4: Here n = 10000,  = 0.1, k = 5, number of compositions 1, 2, 4. Compare the FA - upper bound and the one given by Thm. C.1 combined with the basic composition theorem which states that nc-wise composition of (, )-DP mechanism is (nc, nc)-DP.

10-1

10-2

10-3



10-4

10-5

Numerical method by Feldman et al.

FA, nc = 1

10-6

FA, nc = 2 FA, nc = 3

10-7

FA, nc = 4

0.2

0.4

0.6

0.8

1.0

Figure 5: Here number of users n = 105 and the LDP parameter 0 = 7.0.

20



10-1

10-2

10-3

10-4

10-5

10-6 Numerical method by Feldman et al.

10-7

FA, nc = 1 FA, nc = 2

10-8

FA, nc = 3 FA, nc = 4

0.2

0.4

0.6

0.8

1.0

Figure 6: Here number of users n = 106 and the LDP parameter 0 = 9.0.

C.3 Experimental Comparison, Improvements to (Feldman et al., 2020, Thm 3.1) by tight (, )-accounting
Theorem 3.1 of (Feldman et al., 2020) gives the following bound for the shuffling mechanism combined with an 0-DP local randomiser (denoting p = e -0 ) :

8 log 4/ 8

  log 1 +

pn

+, pn

i.e.,

   4 · exp -

(e 

-

1

-

8 pn

 ) pn

2 .

8

(C.2)

In Figures 7 and 8 we compare the analytical bound (C.2) to the tight bound given by FA and the pair of distributions P and Q given in Section 6.

21



10-1

10-3

10-5

10-7

10-9 10-11 10-13 10-15
10-1

Fourier accountant, nc = 1 Fourier accountant, nc = 2 Fourier accountant, nc = 4 Thm. 3.1, Feldman et al. + Basic Comp., nc = 1 Thm. 3.1, Feldman et al. + Basic Comp., nc = 2 Thm. 3.1, Feldman et al. + Basic Comp., nc = 4
100

Figure 7: Here n = 104, 0 = 4.0. The bound of (Feldman et al., 2020, Thm. 3.5) combined with the basic composition result which states that nc-wise composition of (, )-DP mechanism is (nc, nc)-DP vs. the upper bounds given by the Fourier Accountant.



10-1

10-3

10-5

10-7

10-9 10-11 10-13 10-15
10-1

Fourier accountant, nc = 1 Fourier accountant, nc = 2 Fourier accountant, nc = 4 Thm. 3.1, Feldman et al. + Basic Comp., nc = 1 Thm. 3.1, Feldman et al. + Basic Comp., nc = 2 Thm. 3.1, Feldman et al. + Basic Comp., nc = 4
100

Figure 8: Here n = 106, 0 = 9.0. The bound of (Feldman et al., 2020, Thm. 3.5) combined with the basic composition result which states that nc-wise composition of (, )-DP mechanism is (nc, nc)-DP vs. the upper bounds given by the Fourier Accountant.

22

We next use the advanced composition theorem (Dwork and Roth, 2014) which states that nc compositions of (, )-DP mechanism is ( , nc +  )-DP for
 = 2nc log(1/ ) + nc(e  - 1),
as it gives tighter bounds for larger nc.



10-1

10-3

10-5

10-7

10-9 10-11 10-13 10-15
10-1

Fourier accountant, nc = 1 Fourier accountant, nc = 8 Fourier accountant, nc = 64 Thm. 3.1, Feldman et al. + Adv.Comp.Thm., nc = 1 Thm. 3.1, Feldman et al. + Adv.Comp.Thm., nc = 8 Thm. 3.1, Feldman et al. + Adv.Comp.Thm., nc = 64

100

101

102

Figure 9: Here n = 106, 0 = 9.0. The bound of (Feldman et al., 2020, Thm. 3.5) combined with the advanced composition theorem vs. the upper bounds given by the Fourier Accountant.

C.4 Comparison of the Clones and Blanket - approaches for k-RR

Consider next k-randomised response local randomiser with 0-LDP. This means that, each user chooses to send a randomised response with probability

k

=

.

e 0 + k - 1

We compare the (, )-bounds obtained by considering

1. The approach of Balle et al. (2019) (Blanket). This bound depends on k.

2. The approach of Feldman et al. (2020) (Clones). This bound is independent of k.

We see from Figure 10, that often the 'Blanket'-bound is better, more so for larger 0 and n. We see that the amplification is weaker for larger k, an observation also supported by (Balle et al., 2019, Fig. 3).

23

Fourier Accountant, Blanket, k = 2

0.5

Fourier Accountant, Blanket, k = 2

0.5

Fourier Accountant, Blanket, k = 3

Fourier Accountant, Blanket, k = 3

Fourier Accountant, Blanket, k = 4

Fourier Accountant, Blanket, k = 4

Fourier Accountant, Blanket, k = 8

0.4

Fourier Accountant, Blanket, k = 8

0.4

Fourier Accountant, Blanket, k = 16

Fourier Accountant, Blanket, k = 16

Fourier Accountant, Clones

Fourier Accountant, Clones

0.3

0.3

0.2

0.2

0.1

0.1

10-7

10-6

10-5

10-4



10-3

10-2

(a) n = 103, 0 = 1.0.

10-7

10-6

10-5

10-4



10-3

10-2

(b) n = 104, 0 = 4.0.

Figure 10: Comparison of the DP bounds obtained with FA and the Blanket approach (i.e. the distribu-

tions Ps and Qs of Section 5) and with the Clones approach (the distributions P and Q of Section 6). For

the

Blanket

approach,

we

set

the

parameter



as



=

k exp(0 )+k-1

as

that

gives

an

0-LDP

randomiser.

Numerical experiments illustrate that the guarantees provided by the Blanket approach weaken as k

grows. This observation is verified also by (Balle et al., 2019, Fig. 3).

24

