Draft version June 2, 2021 Typeset using LATEX twocolumn style in AASTeX631

arXiv:2106.00281v1 [astro-ph.IM] 1 Jun 2021

Effects of Spatial Discretization in Lyman- Line Radiation Transfer Simulations
Peter Camps ,1 Christoph Behrens,2 Maarten Baes ,1 Anand Utsav Kapoor ,1 and Robert Grand3
1Sterrenkundig Observatorium, Universiteit Gent, Krijgslaan 281, B-9000 Gent, Belgium 2Institut fu®r Astrophysik, Georg-August Universit®at Go®ttingen, Friedrich-Hund-Platz 1, 37075 Go®ttingen, Germany
3Max-Planck-Institut fu®r Astrophysik, Karl-Schwarzschild-Straﬂe 1, 85748 Garching, Germany
Submitted to ApJ
ABSTRACT We describe the addition of Lyman- resonant line transfer to our dust continuum radiation transfer code SKIRT, verifying our implementation with published results for spherical problems and using some self-designed three-dimensional setups. We specifically test spatial discretization through various grid types, including hierarchical octree grids and unstructured Voronoi tessellations. We then use a radiation transfer post-processing model for one of the spiral galaxies produced by the Auriga cosmological zoom simulations to investigate the effect of spatial discretization on the synthetic observations. We find that the calculated Lyman- line profiles exhibit an extraordinarily strong dependence on the type and resolution of the spatial grid, rendering the results untrustworthy at best. We attribute this effect to the large gradients in the hydrogen density distribution over small distances, which remain significantly under-resolved in the input model. We therefore argue that further research is needed to determine the required spatial resolution of a hydrodynamical simulation snapshot to enable meaningful Lyman- line transfer post-processing.

Keywords: Lyman-alpha galaxies (978) -- Interstellar line emission (844) -- Interstellar scattering (854) -- Radiative transfer simulations (1967) -- Hydrodynamical simulations (767) -- Computational methods (1965) -- Publicly available software (1864)

1. INTRODUCTION
Understanding the formation and evolution of galaxies is one of the most complex and challenging problems in modern astrophysics. In the past decade, cosmological hydrodynamical simulations have greatly improved and have become a mainstream tool in this endeavor (for a general overview, see Somerville & Dav¥e 2015; Vogelsberger et al. 2020a). Current state-of-the-art cosmological hydrodynamical simulations like EAGLE (Schaye et al. 2015; Crain et al. 2015), IllustrisTNG (Pillepich et al. 2018) and SIMBA (Dav¥e et al. 2019) can largely reproduce the observed statistical properties of the galaxy population and galaxy scaling relations in the Local Universe and up to moderate redshifts. This indicates that our overall understanding of galaxy evolution is reasonable.
The power of cosmological hydrodynamics simulations and our confidence in the conclusions and predictions
Corresponding author: Peter Camps peter.camps@ugent.be

based upon them increases with the level of correspondence between observations and model predictions. It is therefore important to make reliable and unbiased comparisons between observations and simulations. Consensus is growing that forward modeling is a very suitable approach (Jonsson et al. 2010; Trayford et al. 2017). Forward modeling requires post-processing of the hydrodynamical simulations. The output of the simulations, typically a set of particles or cells representing the properties of the different components in the galaxy, needs to be converted to synthetic observables such as fluxes, images, spectra, or polarization maps. Subsequently one confronts the synthetic observations to actual data, or one compares physical properties inferred from both data sets in an identical way.
Forward modeling is a complex problem: all relevant emission processes of the different galaxy components need to be included, as well as the radiation transfer (RT) from the emitting sources through the intervening medium. A key aspect to consider is the attenuation and re-emission of starlight by interstellar dust. Attenuation by dust can completely alter the emission of a galaxy at ultraviolet and optical wavelengths, and

2

Camps et al.

thermal emission by dust dominates a galaxy's spectral energy distribution in the infrared and sub-millimeter wavelength range (Ciesla et al. 2014; Viaene et al. 2016; Galliano et al. 2018). Forward modeling hence requires detailed dust RT calculations, a nontrivial undertaking (Steinacker et al. 2013). In the past few years, several advanced tools for the forward modeling of simulated galaxies including dust have been developed (e.g., Jonsson 2006; Robitaille 2011; Baes et al. 2011; Reissl et al. 2016; Narayanan et al. 2021). These tools have been applied to generate synthetic ultraviolet to sub-millimeter observations for many cosmological hydrodynamics simulations in order to test their fidelity or make detailed observational predictions (Torrey et al. 2015; Camps et al. 2016, 2018; Trayford et al. 2017; Liang et al. 2018; Rodriguez-Gomez et al. 2019; Ma et al. 2019; Baes et al. 2020; Trcka et al. 2020; Vogelsberger et al. 2020b; Shen et al. 2020).
A powerful test for cosmological hydrodynamical simulations is the comparison of properties that were not included in the calibration process. A particularly interesting diagnostic is the interstellar gas component in galaxies. Interstellar gas is subject to gravity, hydrodynamic forces and radiative processes, and typically spans many orders in density, temperature and ionization fraction. Several teams have generated synthetic Hi and CO observations for galaxies from cosmological hydrodynamical simulations and compared these to the observed cold gas properties of nearby galaxies (e.g., Bah¥e et al. 2016; Crain et al. 2017; Marinacci et al. 2017; Diemer et al. 2019; Inoue et al. 2020; Dav¥e et al. 2020). Similarly, the Lyman- (Ly) line of neutral hydrogen is a particularly interesting tool for studying active galactic nuclei and star-forming galaxies in the local universe, as well as at high redshifts (Hayes 2015, 2019; Ouchi et al. 2020, and references therein).
The Ly line is a resonant line and the interstellar and circumgalactic medium are usually optically thick to Ly photons. This implies that we need specialized RT tools to generate synthetic Ly observations for simulated galaxies. The physics of Ly RT are well understood and relatively straightforward (e.g., Dijkstra 2019). The most challenging aspect about Ly RT is the huge range in optical depth, often up to 106 or more. Dealing with such optical depths in an efficient way requires RT codes with massive parallelization and smart optimization schemes. Over the past two decades, several such codes have been developed (e.g., Dijkstra et al. 2006; Tasitsiomi 2006; Laursen et al. 2009; Yajima et al. 2012; Smith et al. 2015; Abe et al. 2018; Michel-Dansac et al. 2020). Many of these codes have been used to predict the shape of the Ly line or the surface brightness distribution of the Ly emission from simulated galaxies (for some recent examples, see Gronke & Bird 2017; Behrens et al. 2019; Michel-Dansac et al. 2020; Mitchell et al. 2021).

In this paper, we present the implementation of Ly RT in SKIRT1 (Baes et al. 2011; Camps & Baes 2015, 2020). SKIRT was originally developed as a fully threedimensional Monte Carlo dust RT code, and has been extensively used to generate synthetic ultraviolet to submillimeter broadband images, spectral energy distributions and polarization maps for both idealized galaxies (Baes et al. 2003; Gadotti et al. 2010; De Geyter et al. 2014; Lee et al. 2016; Peest et al. 2017) and for galaxies extracted from cosmological hydrodynamical simulations (Saftly et al. 2015; Camps et al. 2016, 2018; Trayford et al. 2017; Liang et al. 2018; Behrens et al. 2018; Rodriguez-Gomez et al. 2019; Vogelsberger et al. 2020b; Kapoor et al. 2021). While several advanced codes for Ly RT already exist, the extension of SKIRT towards Ly RT has a number of important benefits. First, SKIRT is equipped with a library of flexible input models (Baes & Camps 2015), routines to import the output from various kinds of hydrodynamical simulations (Camps & Baes 2015), and a hybrid parallelization strategy (Verstocken et al. 2017; Camps & Baes 2020). A range of advanced spatial grids for discretizing the medium is implemented in SKIRT, including methods to efficiently traverse photons through these grids (Camps et al. 2013; Saftly et al. 2013, 2014). The Ly RT implementation in SKIRT automatically inherits all of these features, making it ideally suited to post-process any hydrodynamical simulation. Second, this approach allows users to investigate the effects of dust and Ly RT self-consistently using a single code, as opposed to dealing with multiple codes and configuration mechanisms (see, e.g., Behrens et al. 2019).
Besides describing the implementation, we present an investigation of the sensitivity of Ly RT calculations on the spatial discretization of the medium. While testing the SKIRT Ly RT routine on a galaxy imported from a medium-resolution hydrodynamical simulation snapshot, it became clear that the calculated synthetic Ly line profiles depend very strongly on the resolution and type of spatial discretization used for the RT phase. The variations were so substantial that it seemed futile to try and fine-tune the model or calibrate it by comparison to observations. Instead we decided to investigate the cause of these discrepancies, and report on these findings and their implications.
This paper is structured as follows. In Sect. 2 we describe the key elements of the Ly implementation in our code. In Sect. 3 we validate our implementation against published results for static, expanding and contracting spheres, and we verify that the Ly implementation properly cooperates with the existing spatial grids and import features of our code. In Sect. 4 we pro-
1
The open-source SKIRT code is registered at the ASCL with the code entry ascl:1109.003. Documentation and other information can be found at www.skirt.ugent.be.

Spatial Discretization in Ly RT

3

duce synthetic Ly profiles for our full imported galaxy model. In Sect. 5 we then break the model down in various ways to discover the cause of the spatial grid dependencies. We discuss the implications of our findings and offer suggestions for further research. In Sect. 6 we summarize and conclude.
2. IMPLEMENTATION
As mentioned in the introduction, the SKIRT code (see footnote 1) historically implements dust continuum RT for a wide range of configurable input models including built-in and imported components. The version most recently described in the literature, SKIRT 9 (Camps & Baes 2020), supports kinematics and allows including gas media in addition to dust. We have now added the capability to perform RT simulations of the resonant Ly line. All of the tests conducted for this paper have been run with the extended standard version of the code without the need for any additional programming or (re-)compilation.2
In this section we summarize the Ly resonant line RT implementation in SKIRT. Because the Ly physics and numerical methods have been extensively described in the literature, we limit that part of the discussion to a brief summary and some relevant references. We do, however, indicate how the Ly implementation fits into the overall SKIRT framework. We furthermore focus the discussion on the features used for this paper. More information is available on the SKIRT web site (see footnote 1).
Configuration --To configure a Ly simulation, the user specifies an input model defining the properties of radiation sources and media, including neutral hydrogen and possibly dust, in addition to detectors and discretization options such as spectral and spatial grids. All of this information gets bundled in a SKIRT parameter file that may refer to external files, for example containing snapshot data produced by a hydro-dynamical simulation.
Velocities --The model coordinate system in SKIRT corresponds to the model's overall rest frame. All bulk velocities for sources and media are defined relative to this frame. For simplicity, the models in this paper are placed at zero redshift and do not include wavelength shifts caused by cosmic expansion, which become important when tracing radiation at wavelengths near the Ly line through the circumgalactic or intergalactic medium.
Sources --SKIRT offers point sources and extended sources defined through built-in geometries or imported from particle or cell-based snapshot data. A Ly related emission spectrum (defined in the local bulk velocity frame) can be assigned to these sources in several ways.
2 Using git commit a99452423889 in the master branch of the SKIRT code hosted at www.github.com/SKIRT/SKIRT9

The most basic option emits all photon packets at the Ly line center,  = 1215.67 ∞A, which can be useful for some benchmark setups. More realistically, the user can specify a Gaussian distribution around the Ly line center corresponding to, for example, the thermal motion of the emitting hydrogen atoms at a given gas temperature or to the velocity dispersion within the population of sources represented by a given entity. The luminosity of the source can be specified in absolute terms or derived indirectly from the ionizing portion of another spectrum. For example, consider a set of imported particle sources each representing a single stellar population. Each particle gets assigned an emission spectrum interpolated from a template library based on its age, metallicity, and initial mass. SKIRT can then convert a user-configured fraction of the ionizing radiation in that spectrum to Ly emission. In other words, the spectrum short of the ionization threshold ion = 911.75 ∞A is proportionally decreased and the corresponding integrated luminosity is emitted instead at the Ly line center or as a Gaussian spectrum around the Ly line center.
Media --The RT media can similarly be defined through built-in geometries or imported from snapshot data. In addition to the local density and bulk velocity, a neutral hydrogen medium component specifies the gas temperature, and a dust medium component specifies the properties of the dust grain population.
Photon cycle --The Monte Carlo photon cycle used in SKIRT and many other RT codes is amply documented elsewhere (see, e.g., the review by Steinacker et al. 2013). In our updated implementation, the overall mechanisms and specifically the interactions of photon packets with dust have not changed. SKIRT uses forced scattering (Cashwell & Everett 1959), which serves predominantly to optimize the simulation of models with limited optical depth. This technique requires that, after each scattering event, the complete photon packet path up to the model boundary is calculated to determine the escape fraction. Because photon packets close to Ly line center can experience a vast number of scattering events in a very small region of space, calculating these complete paths slows down the simulation. We therefore implemented a variation on the photon cycle that does not employ forced scattering and which is used by default for Ly simulations.
This leads to a straightforward Monte Carlo RT procedure (Steinacker et al. 2013). After each emission or scattering event, a random optical depth is drawn from an exponential distribution and the next interaction point is determined by progressing the photon packet through the discretized medium until that optical depth has been reached. If the photon packet exits the simulation domain before this happens, it is terminated. Otherwise, the next scattering event is simulated, updating the packet's direction and wavelength as needed, and the iteration continues. If the simulation

4

Camps et al.

includes multiple media (e.g., hydrogen and dust), the scattering medium is randomly selected based on the relative opacities at the event location. In the case of dust, the weight of the photon packet is adjusted to account for absorption (Niccolini et al. 2003). In any case, at each emission and scattering event, a properly adjusted peel-off photon packet (Yusef-Zadeh et al. 1984) is sent to each of the instruments for detection (see paragraph Peel-off later in this section).
Cross section --As documented by several authors (e.g., Dijkstra et al. 2006; Tasitsiomi 2006; Smith et al. 2015), the Ly scattering cross section (x, T ) as a function of the dimensionless photon frequency x = x(, T ) of a hydrogen gas at given temperature T is obtained from the convolution of the single-atom scattering cross section profile with the Maxwell-Boltzmann velocity distribution of the atoms and can be written as

(x, T ) = ,0(T ) H(av(T ), x)

(1)

where H(av, x) is the Voigt function and where the cross section at the line center ,0, the Voigt parameter av, and the dimensionless photon frequency x all depend on the temperature of the gas. Please refer to A for more detailed definitions.
We use the approximation for the Voigt function provided by Smith et al. (2015) in their Appendix A1. According to these authors and as confirmed by MichelDansac et al. (2020), this approximation is accurate to within one per cent for all x as long as av < 0.03, which for the calculation of the Ly cross section corresponds to any gas temperature above the present-day cosmic microwave background temperature. The accuracy improves substantially for higher gas temperatures.

Frequency shift --Following other authors (e.g., Dijkstra et al. 2006; Tasitsiomi 2006; Smith et al. 2015), we ignore energy transfer through recoil and assume that the energy of the photon before and after the Ly scattering event is identical in the frame of the interacting atom. To calculate the photon's Doppler shift into and out of the atom frame, however, we need to randomly select an atom velocity from the appropriate probability distributions. Assuming a Maxwell-Boltzmann velocity distribution, the two atom velocity components perpendicular to the incoming photon direction have a Gaussian probability distribution, which can be sampled using standard methods.
The probability distribution of the parallel component is proportional to both the Gaussian atom velocity distribution and the Ly scattering cross section for a single atom, reflecting the preference for photons to be scattered by atoms to which they appear close to resonance. This leads to

e-u2

P (u|x)  (u - x)2 + a2v

(2)

where x is the dimensionless frequency of the incoming photon and u is the similarly scaled parallel atom velocity component. To sample from this distribution, we use the rejection method first described by Zheng & Miralda-Escud¥e (2002) with refinements offered by Smith et al. (2015) and Michel-Dansac et al. (2020).
Phase function --To determine the outgoing direction of the photon packet after a scattering event, we need to select a random scattering angle  from the appropriate phase function. Ly scattering takes one of two forms: isotropic scattering, which can be sampled trivially, or dipole scattering (also called Rayleigh scattering) with a phase function P (µ)  cos2  + 1, which can also be easily sampled. Following Dijkstra & Loeb (2008), we use a simple recipe for selecting the appropriate phase function depending on whether the incoming photon frequency is in the core or in the wings of the single-atom Ly line cross section. We treat all wing scattering events and 1/3 of all core scattering events as dipole, and the remaining 2/3 core scattering events as isotropic. For the purpose of this recipe, the scattering event is considered to occur in the core if the incoming dimensionless photon frequency (in the frame of the interacting atom) satisfies |x| < xcore = 0.2. SKIRT also supports polarized Ly scattering, but in this paper all radiation is assumed to be unpolarized.
Peel-off --SKIRT uses the peel-off technique (YusefZadeh et al. 1984) to accumulate synthetic observations in the user-configured instruments. For each emission and scattering event, a distinct peel-off photon packet is sent towards each instrument, properly biased to compensate for moving it into the observer direction as opposed to the direction of the random-walk photon packet that travels through the medium. Peel-off packets experience regular extinction along the path to the instrument but do not generate further scattering events. For Ly scattering, we ensure that all peel-off photon packets for a particular scattering event use the same atom velocity and phase function as the corresponding random-walk photon packet, improving consistency and reducing calculation time. Even so, given the large number of Ly scattering events, calculating the peel-off paths and their optical depths can easily dominate the simulation time, especially in the presence of multiple instruments.
Acceleration --In optically thick media, the number of Ly scattering events to be simulated can be reduced by artificially forcing photon packets into the wing of the line profile. This approximation can be acceptable because the mean free path length between the skipped scattering events is extremely small and the effects of the phase function on the scattering direction are essentially randomized by the large number of events. SKIRT implements two such core skipping acceleration schemes inspired by those proposed by Ahn et al. (2002); Dijk-

Spatial Discretization in Ly RT

5

F (arbitrary units)

T = 101 K, 0 = 105

T = 101 K, 0 = 106

8

T = 101 K, 0 = 107

T = 104 K, 0 = 107

6

4

2

0

75

50

25 x0

25

50

75

Figure 1. The radiation spectrum emerging from a static uniform neutral hydrogen sphere with a central point source emitting at the Ly line center, as a function of the dimensionless frequency x(T ). Results are shown for four combinations of gas temperature and radial optical depth at the Ly center. Solid lines indicate SKIRT output; dotted lines indicate the corresponding analytical approximation given by Eq. (3). All curves are normalized so that they enclose the same surface area and are scaled to correspond with figure 1 of Dijkstra et al. (2006).

stra et al. (2006); Laursen et al. (2009) and Smith et al. (2015). However, to avoid any effects of these approximations on our results, all simulations for this paper were performed without core skipping acceleration.

3. VALIDATION
3.1. Static sphere
Inspired by the work by Neufeld (1990) for a planeparallel slab, Dijkstra et al. (2006) presented an analytical approximation for the radiation spectrum J(x) emerging from a static, uniform neutral hydrogen sphere with a central point source emitting at the Ly line center, i.e.

J(x) 

x2 , (3)

1 + cosh 23/27(x3/av0)

where x(T ) is the dimensionless frequency, av(T ) is the Voigt parameter, 0(T ) is the radial optical depth of the sphere at the Ly line center, and T is the temperature of the gas. The approximation becomes more accurate for large values of av0  NHi/T , with NHi the radial hydrogen number column density (see Eq. A8).
Fig. 1 shows this analytical approximation (dotted lines) and the corresponding SKIRT output (solid lines) for a gas temperature of 10 K and the three optical depth

values shown by Dijkstra et al. (2006). We add a fourth combination with a higher temperature to verify that SKIRT handles other temperature values as well. It is apparent from the figure that the numerical and analytical solutions indeed converge for higher densities at constant gas temperature. Also, the discrepancies between the numerical and analytical solutions are essentially identical to those shown by Dijkstra et al. (2006).
3.2. Expanding and contracting sphere
Tasitsiomi (2006) extends the test model to an expanding or contracting sphere, calculating and presenting the emerging spectra for a number of different configurations. Fig. 2 shows these solutions (dotted lines) as well as the corresponding SKIRT solutions (solid lines). All models include a uniform neutral hydrogen sphere at a temperature of T = 2 ◊ 104 K and with a radial number column density of NHi = 2 ◊ 1018 cm-2 (left column panels) or NHi = 2 ◊ 1020 cm-2 (right column panels). The radial velocity of the expanding and contracting spheres is set to ±200 km/s at the edge and scales proportionally with radius. Solutions are provided for two configurations of the sources: a central point source (top row) or uniform emission throughout the sphere (bottom row). In both cases, photons are emitted at the Ly line center in the rest frame of the emitting atom. This leads to a Gaussian spectral profile in the bulk rest frame of the gas with a dispersion corresponding to the thermal motion, or vth/ 2  12.85 km/s.
There is an excellent match between the SKIRT and Tasitsiomi (2006) solutions for the configurations with a central point source (top row of Fig. 2). The configurations with uniform emission (bottom row) show slightly larger discrepancies, especially for the higher density sphere, which is more computationally challenging. Given the limited spectral resolution of the Tasitsiomi (2006) solutions, however, we feel that the match is sufficiently close to validate the correctness of the SKIRT implementation.
3.3. Spatial grids
For all but the most trivial input models, a numerical RT simulation requires a discretization of the spatial domain. In SKIRT, as in many codes, all physical quantities are assumed to be uniform within each cell of the grid used for this purpose. An appropriate spatial grid balances two requirements: the grid must sufficiently resolve the physical quantities in the model while keeping memory usage and computation time within acceptable limits. To help achieving this goal, SKIRT implements various spatial grid types including regular spherical, cylindrical and Cartesian grids (Camps & Baes 2015), hierarchical octree and binary tree grids (Saftly et al. 2013, 2014), and unstructured Voronoi grids (Camps et al. 2013). To verify that the Ly implementation properly works in this context, Fig. 3 shows results for

6
1.0 NHI = 2 ◊ 1018 cm 2 central source
0.8

Camps et al.

static expanding contracting

NHI = 2 ◊ 1020 cm 2 central source

F (arbitrary units)

0.6

0.4

0.2

0.0 1.0 NHI = 2 ◊ 1018 cm 2
uniform emission 0.8

NHI = 2 ◊ 1020 cm 2 uniform emission

F (arbitrary units)

0.6

0.4

0.2

0.0

15 10

5 x0

5

10 15

60

40

20

x0

20 40 60

Figure 2. The radiation spectrum emerging from a static (green), contracting (orange) or expanding (blue) uniform neutral hydrogen sphere with a central point source (top row) or with uniform emission throughout the sphere (bottom row), for two values of the radial number column density (left and right columns), as a function of the dimensionless frequency x(T ). The gas temperature is T = 2 ◊ 104 K and all photons are emitted at the Ly line center in the rest frame of the emitting atom. Solid lines indicate SKIRT output; dotted lines indicate the corresponding results taken from Tasitsiomi (2006). The curves in each panel are scaled so that the top of the highest curve lies at unity.

three input models, each simulated with three different spatial grids.
The leftmost panel of Fig. 3 shows the radiation spectrum emerging from a uniform static neutral hydrogen sphere with a central point source similar to the models used in Sect. 3.1, with T = 106 K and 0 = 105. The first simulation uses a one-dimensional (1D) spherical grid with just a single cell, which is possible because of the spherical symmetry of the model and its uniform temperature and density. The second simulation uses a hierarchical octree grid in Cartesian coordinates with about 1.2 million cells constructed so as to optimally resolve the surface of the sphere. The third simulation uses a Voronoi tessellation (Voronoi 1908) with 0.7 million cells, constructed from seeds that are randomly sampled from a uniform distribution in the cube enclosing the sphere.
The middle panel of Fig. 3 shows the radiation spectrum emerging from a thin contracting shell with a

central point source emitting at the Ly line center. The spherically symmetric neutral hydrogen shell has a physical thickness of 1/15 of its outer radius, with a radial optical depth across the shell of 0 = 105 and a gas temperature of T = 105 K. The radial velocity of the contracting shell is set to -200 km/s at the outer edge and scales proportionally with radius. The emerging Ly line profile has a fairly complex shape caused by the combination of kinematics and reflections within the shell. For this model, the first simulation uses a three-dimensional (3D) Cartesian grid with 256 uniformly spaced cells along each coordinate axis, for a total of more than 16 million cells. The second simulation uses a hierarchical octree grid with about 0.5 million cells constructed so as to optimally resolve the surfaces of the shell. The third simulation uses a Voronoi tessellation with 0.5 million cells, constructed from seeds that are randomly sampled from the gas density distribution in the model. In other words, cells are placed preferen-

F (arbitrary units)

Spatial Discretization in Ly RT

7

Static sphere

Contracting shell

Clumpy box

1.0

Spherical

Octree

0.8

Voronoi

Cartesian Octree Voronoi

Cartesian Octree Voronoi

0.6

0.4

0.2

0.0

4

20

2

44

[≈]

2

0

[≈]

24 3 2 10
[≈]

Figure 3. Radiation spectrum emerging from a static sphere (left), a thin contracting shell (middle), and a contracting cube with clumpy gas density (right), each discretized with various spatial grids (with essentially identical results). The spectra are shown as a function of wavelength delta from the Ly line center, i.e.  =  - . Details of the configurations are provided in Sect. 3.3. The curves in each panel are scaled so that the top of the highest curve lies at unity.
100

10 1

10 2

Input

Cartesian

Octree

Voronoi

10 3

Figure 4. Cuts through the hydrogen density of a small region in the clumpy cube for which solutions are provided in the rightmost panel of Fig. 3. The width of the region is about 30 per cent of the width of the cube. The leftmost panel shows the theoretical input distribution. The subsequent panels show the same distribution after discretization with, respectively, a regular Cartesian grid, a hierarchical octree grid, and an unstructured Voronoi grid. The density values are scaled arbitrarily, but using the same factor for all panels.

tially on and near the thin shell as opposed to in the central void.
The rightmost panel of Fig. 3 shows the radiation spectrum emerging in three orthogonal directions from a contracting cube with clumpy neutral hydrogen density and a central point source emitting at the Ly line center. The intention is to provide a synthetic model with a more realistic density distribution than the uniform models discussed earlier. The gas temperature is still uniform across the cube, at a value of T = 105 K. The average optical depth at the Ly resonance from the center of the cube to one of its edges is 0 = 106. The spatial distribution of the gas, however, is highly non-uniform. It is constructed by introducing spherical over-densities in three consecutive passes at decreasing scales (respectively 50, 20 and 10 per cent of cube's

width) using SKIRT's clumpy geometry decorator (Baes & Camps 2015). The dynamic range of the density values spans over three orders of magnitude (95 per cent of the values is within 3 dex). The radial velocity of the contracting cube is set to -200 km/s at a radius corresponding to the half-width of the cube, and scales proportionally with radius.
A cut through a portion of the cube's density distribution is shown in the leftmost panel of Fig. 4. The other panels in that figure show the same cut after the density distribution has been discretized with the grids used in the three simulations shown in the rightmost panel of Fig. 3. The first simulation uses a Cartesian grid with 128 uniformly spaced cells along each coordinate axis, for a total of slightly over 2 million cells. The second simulation uses a hierarchical octree grid with

8

Camps et al.

about 2 million cells constructed so that cells are subdivided to a deeper level in higher-density regions as compared to cells in lower-density regions. The third simulation uses a Voronoi tessellation with 2 million cells, constructed from seeds that are randomly sampled from the gas density distribution in the model. In both the octree and Voronoi grids, higher-density regions are thus more highly resolved than lower-density regions.
For each of the models shown in Fig. 3, the three simulations using different spatial grids produce essentially identical results. This provides sufficient comfort that the various grid implementations in SKIRT properly cooperate with the new Ly line transfer implementation and that the code works for 3D models as well as for the standard spherical test setups.
3.4. Import
SKIRT includes mechanisms to import external density distributions that are represented through smoothed particles (SPH) or discretized using recursively refined meshes (AMR) or Voronoi tessellations. Although the import functionality is largely disconnected from the photon cycle, we need to ensure that neutral gas density distributions can be properly imported in the context of a Ly line transfer simulation.
For example, we prepare a data file defining a uniform sphere corresponding to the first input model discussed in Sect. 3.3 (Fig. 3, leftmost panel). The density distribution in this import file is discretized on a Voronoi tessellation with 0.1 million cells using seeds that are randomly sampled from a uniform distribution within a cube enclosing the sphere. We perform two simulations for this imported model. The first simulation employs the imported Voronoi tessellation for RT without change. The second simulation re-grids the density distribution on an octree grid with 1.2 million cells. Both simulations produce results (not shown) that are essentially indistinguishable from those plotted in the leftmost panel of Fig. 3. This and other similar tests provide evidence that the import module properly cooperates with the new Ly line transfer implementation.
4. Ly LINE PROFILES OF SIMULATED GALAXIES
We now consider a more realistic input model based on one of the simulated galaxies in the Auriga project (Grand et al. 2017). Auriga includes a number of cosmological magneto-hydrodynamical zoom simulations of the formation of galaxies in isolated Milky Way mass dark halos performed using the Voronoi-grid-based moving-mesh code AREPO (Springel 2010). We use the redshift-zero snapshot of the disk galaxy in the halo identified as Au5, with a stellar mass of 6.7 ◊ 1010 M and a barred spiral structure. We select this galaxy because it seems representative of the set presented by Grand et al. (2017), both in terms of morphology and resolution (number of cells). We extract stellar and

dust-related data from the snapshot largely as described by Kapoor et al. (2021), who produce dust-extincted spectra and images for the Auriga galaxies, and we additionally extract Ly-related data for our input model. As we will see, the specifics do not really matter for the purposes of this paper, so we provide just a brief summary of the procedure here.
We use a RT simulation box 80 kpc across in each direction, with the galaxy centered in the box and its rotation axis aligned with the z axis. For the Au5 galaxy at redshift zero, the gas in this box is discretized on about 0.54 million Voronoi cells with seeds that are automatically placed so as to roughly maintain a constant mass resolution (Springel 2010). The Auriga simulations do not separately trace dust, so we employ a heuristic to include dust in our SKIRT input model. We add diffuse dust to all cells containing star-forming gas using a dust-to-metal ratio of 0.2 and assuming a THEMIS dust model (Jones et al. 2017). We also include neutral atomic hydrogen gas in all cells according to the gas properties in the snapshot data, largely following Marinacci et al. (2017).
Specifically, the overall hydrogen abundance and the temperature are taken directly from the cell properties. For non-star-forming cells, the neutral hydrogen fraction is determined from the ionization fraction calculated by the cooling module (Vogelsberger et al. 2013) used in the Auriga simulations. The high-density gas in cells eligible for star formation, however, is described by a simplified two-phase ISM model (Springel & Hernquist 2003) that does not provide a reliable neutral fraction. For our purposes, we simply assume that all the hydrogen gas in these cells is neutral, leading to a slight overestimation. The atomic hydrogen fraction in each cell is determined using the Gnedin & Kravtsov (2011) recipe as also applied by Marinacci et al. (2017).
We then artificially reduce the neutral atomic hydrogen density obtained as described in the previous paragraph by a factor of 100 to allow our Ly simulations to run in acceptable time without the need for core skipping acceleration (see the last paragraph of Sect. 2). Fig. 5 shows horizontal and vertical cuts through the resulting hydrogen density distribution, as well as an optical depth map at the Ly resonance as seen from the galactic center.
Star particles with an age above 10 Myr are assigned an emission spectrum from the Bruzual & Charlot (2003) template library based on their age, metallicity and mass. Young star particles (below 10 Myr) are instead assigned a spectrum from the MAPPINGS III family (Groves et al. 2008), which also models the effects of dust enveloping the star-forming cores. For both types of sources, following Dijkstra (2014), 68 percent of the hydrogen-ionizing radiation in the spectrum is converted to Ly emission. The bulk velocities for all source particles and media cells are also carried forward from the snapshot data to our input model.

Spatial Discretization in Ly RT

9

xy

xz

F (arbitrary units)

10 11 10 9 10 7 10 5 10 3
nHI [cm 3]

101 102 103 104 105 106
0

Figure 5. Cuts through the hydrogen density (two left panels) and optical depth map at the Ly resonance (right panel) of the spiral galaxy model derived from the Au5 simulation. The cuts along the galactic plane (xy) and along a vertical coordinate plane (xz) are 80 kpc across, covering the complete spatial domain of the model. The optical depth map uses Mollweide projection to show the complete sky as seen from the galactic center. The calculated optical depth values take into account the gas density and temperature along the path corresponding to each pixel.

0.8

0.7

0.6

0.5

0.4

0.3

0.2

0.1

0.0

2

x
1.0 0.8 0.6

Nimcelplsorted 1 ◊ 106 5 ◊ 106 4 ◊ 107

y 4.0
3.5 3.0 2.5 2.0

0.4

1.5

0.2

1.0 0.5

0

2

[≈]

0.0

2

0

2

[≈]

0.0

2

z

0

2

[≈]

Figure 6. Ly line profile superposed on the continuum radiation emerging from an imported spiral galaxy model in the direction of each of the coordinate axes, with the z-axis coinciding with the galaxy rotation axis. The flux values are scaled arbitrarily, but using the same factor for all panels. The model includes stellar continuum and Ly emission, neutral hydrogen gas, dust, and kinematics for all components. More details are provided in Sect. 4 and Fig. 5. Each panel shows results from simulations with four different spatial grids: the imported Voronoi grid with 0.54 million cells and three Voronoi grids with a larger number of cells. Each configuration is run twice (solid and dashed lines) using different pseudo-random number sequences to estimate the Monte Carlo noise in the results.

Fig. 6 shows the spatially integrated Ly line profiles calculated by SKIRT for this model in the direction of each of the coordinate axes (one direction per panel). Each direction/panel shows results from simulations with four different spatial grids: the Voronoi grid with 0.54 million cells on which the input model is defined, and three Voronoi grids with a larger number of cells. In the latter case, the generating seeds are randomly sampled from the hydrogen density distribution of the input model and the medium properties are resampled on the internal grid before performing the RT simulation. To verify that the results are not signifi-

cantly affected by Monte Carlo noise, each configuration is simulated twice (solid and dashed lines) using different pseudo-random number sequences.
It is immediately obvious from Fig. 6 that the shape and magnitude of the calculated line profiles depend greatly on the spatial grid being used. In fact, the profiles produced by the resampled grids seem to be almost unrelated to the profile produced by the original, imported grid. As the number of grid cells rises, the resampled discretization approaches the original discretization, so one would expect the calculated line profile to converge to that of the original grid as well. This

F (arbitrary units)

10

Camps et al.

1.0 Dust
0.8

x 1.0
0.8

Nimcelplsorted 1 ◊ 106 5 ◊ 106

y

7

6

5

z

0.6

0.6

4 ◊ 107

4

0.4

0.4

3

2

0.2

0.2

1

0.0

0.0

0

Hydrogen
0.4

x 0.8

y
8

z

0.3

0.6

6

0.2

0.4

4

F (arbitrary units)

0.1

0.2

2

0.0

2

0.0

0[≈]

2

2

0[≈]

2

0 2

0[≈]

2

Figure 7. Radiation spectrum emerging from simplified versions of the Au5 galaxy model shown in Figs. 6 and 5. The flux values are scaled arbitrarily, but using the same factor for all panels in the same row. The top row model lacks hydrogen but includes the dust, sources and kinematics of the original model. The bottom row model has the hydrogen density distribution of the original model but with uniform temperature, zero bulk velocity, no dust, and just a single central Ly point source. More details are provided in Sect. 5.1. As in Fig. 6, each panel shows results from simulations with different spatial grids: the imported Voronoi grid with 0.54 million cells and three grids with a larger number of cells. In this figure however, the solid lines indicate Voronoi grids and the dashed lines indicate octree grids (with approximately the same number of cells).

is not evident in the profiles in Fig. 6. Even if one would consider the behavior of the resampled-grid profiles as a trend toward the original-grid profile, several orders of magnitude more cells would clearly be needed to sufficiently approach the original discretization for the simulation results to converge.
This finding is somewhat disconcerting. In our work with dust continuum RT models, we never experienced such a strong dependence on the precise discretization of the spatial domain (although an appropriate grid is obviously important for correct results). In the next section, we further investigate the cause of these large discrepancies.
5. DISCUSSION
5.1. Origin of the sensitivity to spatial discretization
The SKIRT model discussed in the previous section is fairly complex, containing all elements that might lead to realistic results after further fine-tuning and calibration of the snapshot data extraction and model setup procedure. However, the strong sensitivity to the spa-

tial grid makes it impossible to even contemplate such fine-tuning. An obvious question is whether, perhaps, we introduced too many elements at the same time ≠ even if SKIRT is routinely successfully applied to dust continuum models of similar complexity. To address this question, we study two models in which we include a subset of the original Au5 model components.
For the first partial model, we remove the hydrogen but include the Ly emission, dust, and kinematics exactly as they are in the full model. This results in a dust extinction-only model with the peculiarity that the wavelength range is limited to a narrow range around the Ly line center. The second partial model includes just a single source embedded in a static body of neutral hydrogen at a uniform temperature. The hydrogen density distribution is extracted from the simulated Au5 galaxy and reduced by a factor of 100 as in Sect. 4 and as illustrated in Fig. 5. The bulk velocities are set to zero and the gas temperature is set to the uniform value of 106 K across the simulation box. The model contains no dust and no imported sources. Instead, a single point

Spatial Discretization in Ly RT

11

source emitting at the Ly line center is placed in the center of the simulation box.
Fig. 7 shows the spectra calculated by SKIRT for these models in the direction of each of the coordinate axes. Similar to Fig. 6, each panel/direction shows results from simulations with different spatial grids: the imported Voronoi grid with 0.54 million cells and three grids with a larger number of cells. In Fig. 7, however, the solid lines indicate Voronoi grids with seeds sampled from the dust or hydrogen density distribution, depending on the model, and the dashed lines indicate octree grids with approximately the same number of cells.
The panels in the top row of Fig. 7 show the results for the dust-only model. As expected, the spectra calculated for the various grids essentially overlap. Any differences are of the same order as the statistical noise of the Monte-Carlo method. The form of the line profile is now determined by the bulk velocities of the sources at emission and the dust during scattering events.
On the other hand, the panels in the bottom row of Fig. 7 show the results for the drastically simplified static hydrogen-only model. It is clear from the figure that the strong dependence of the calculated line profiles on the spatial grid persists in this model, although the positions of the peaks now seem to be consistently reproduced by all grids. The discrepancies follow a similar trend for both grid types, i.e. unstructured Voronoi or hierarchical octree grids. The line profiles calculated with consecutively more resolved resampled grids seem to converge towards those calculated with the original imported grid, while this was much less evident in the full model (Fig. 6). We attribute the lack of convergence in the full model to the extra complexity introduced by the spatial structure of the bulk velocities and gas temperature. Also, the current SKIRT implementation uses a less sophisticated mechanism for determining the velocity and temperature in each of the resampled grid cells. While the dust density is averaged over 200 points in the input distribution, randomly chosen across the new cell volume, the velocity and temperature are sampled at just a single location, the geometric center of the new cell. This may help explain the lack of convergence in the full model. However, since the discrepancies between the original and resampled grids persist even when the velocity and temperature fields are constant, this issue does not affect our conclusions.
Because of the high optical depths and the correspondingly short free path lengths in the central regions of our model, relatively few photons escape directly from these dense regions. Consequently, the form of the synthetically observed line profiles might be dominated by the structure of the gas density in the outskirts of our model, where the spatial grids are less resolved. We therefore run yet another model (without actually showing the results here) in which we remove the gas from all cells outside of an ellipsoid tightly enclosing the central regions. The line profile discrepancies persist also for this

model, although they are somewhat less pronounced. We thus conclude that the discretization dependency must be caused by the structure of the density distribution imported from the simulated Au5 galaxy, even for the relatively better resolved central regions.
It turns out that the hydrogen number density values imported from the Au5 snapshot span nine orders of magnitudes (95 per cent of the values lie within 9 dex). This is a vastly larger dynamic range than the three orders of magnitudes found for the synthetic clumpy distribution discussed in Sect. 3.3 and illustrated in Fig. 4. Furthermore, the number density for adjacent grid cells in the original, imported Voronoi grid often differs by several orders of magnitude and in some cases even by more than six orders of magnitude. It thus seems that the input density distribution is insufficiently resolved for the Ly RT simulations to produce consistent results.
5.2. Total Ly luminosity
Our analysis so far has focused on the Ly line profiles emerging from our models. For some types of studies, however, the quantity of interest is the total Ly luminosity integrated over the line profile. It is therefore relevant to examine the effect of spatial resolution in our simulations on this quantity. Because the axes in our Figs. 6 and 7 have linear scale, the area under each of the curves (after subtracting the continuum level) is an appropriate proxy for the total line luminosity.
For our full Au5 model, shown in Fig. 6, the regridded simulations reproduce a luminosity smaller than the imported-grid simulations by up to 25 per cent for the x- and y-axis sight lines, and by up to a factor of 3 for the z-axis sight line. For our partial Au5 model containing just static hydrogen, shown in the bottom row of Fig. 7, we find somewhat smaller discrepancies: the total luminosity from the re-gridded simulations is up to 20 per cent smaller for the x and y views, and up to 75 per cent larger for the z view. These results indicate that the total luminosity values calculated for various spatial discretization options are also not converged, although the situation seems less dramatic than when considering the spectrally resolved line profile.
We further note that the total line luminosity depends significantly on the line of sight. Using the importedgrid simulation results as a reference, the z-axis luminosity is more than twice that for the x and y axes in our full model (Fig. 6), and almost five times larger in our partial model (Fig. 7). These differences are much larger than the discrepancies caused by spatial discretization effects in our simulations. They can be understood by variations in the Ly optical depth along the sight lines and, in general, the importance of the 3D geometry.
5.3. Implications
The key difference between the simplified Au5 model (Fig. 5, bottom row) and our earlier clumpy box test

12

Camps et al.

model (Fig. 4), for which there are no noticeable grid effects, is the dynamic range of the hydrogen density values. In the Au5 model, these values span 9 orders of magnitude, compared to 3 in the clumpy box. The smallest cells in the Voronoi grid extracted from the snapshot for the Au5 model are approximately 50 pc across (measured as the cubic root of the cell volume). The density values for some adjacent cell pairs differ by more than 6 orders of magnitude. Properly resolving these extremely steep gradients would need much smaller cells, likely on a sub-parsec scale.
We thus argue that the hydrogen density distribution produced by the Auriga simulations for Au5 is insufficiently resolved, possibly by several orders of magnitude, for Ly RT post-processing simulations to produce consistent results. While we have not verified this, the situation is almost certainly similar for the other Auriga galaxies, which have a number of resolution elements up to only about twice as many as Au5. In fact, our findings lead us to suspect that most if not all present-day cosmological zoom simulations of Milky-Way sized objects would not have sufficient resolution to overcome this problem.
There is yet another consideration. We ran all simulations for this paper without core skipping acceleration (see Sect. 2) and we artificially reduced the hydrogen density for our Au5 model by a factor of 100 (see Sect. 4) to reduce run times. Still, several of the Au5 simulations consumed about 104 core hours. Using the original Au5 hydrogen density, according to our tests, would increase the execution time by more than two orders of magnitude. While this is within reach of current highperformance computer systems, running a large number of such simulations would become cumbersome. A core skipping scheme could significantly reduce the run time, but might also introduce significant inaccuracies. From our limited tests, it appears that selecting appropriate parameters for the acceleration scheme in complex models such as Au5 is nontrivial. It would inevitably involve a form of convergence testing to find an acceptable balance between speed and accuracy. More importantly, one would need to somehow disambiguate the effects of the acceleration scheme and those of the spatial discretization.
It goes without saying that meaningful Ly RT postprocessing of individual galaxies requires hydrodynamical simulations to resolve the relevant physical processes within molecular clouds, or to provide appropriate subgrid recipes as a substitute. In addition, however, we argue that further research is needed to determine the spatial resolution required to properly represent the steep gradients and dynamic range in the physical quantities involved. While certain resolution issues have been noted on scales above 1 kpc (see, e.g., Behrens et al. 2018), to our knowledge, this has not been addressed in previous work on the resolved galaxy scales discussed here. The standard 1D setups (Neufeld 1990; Dijkstra

et al. 2006; Tasitsiomi 2006) often used to validate Ly codes (e.g., Verhamme et al. 2006; Laursen et al. 2009; Behrens & Niemeyer 2013; Smith et al. 2015; MichelDansac et al. 2020; Seon & Kim 2020), or similar 1D benchmark setups for molecular line transfer (e.g., van Zadelhoff et al. 2002), fall short in this context, simply because they do not exhibit the spatial complexity, density gradients and dynamic range underlying the discretization issues we uncovered. A good approach would be to design a 3D setup that does incorporate such features, perhaps reminiscent of our clumpy box, and to study it using multiple Ly RT codes. Our participation in a similar dust RT benchmark effort (Gordon et al. 2017) has shown that comparing the output from several codes for such a well-defined setup, and investigating any discrepancies, can be very informative. For example, the study hinted that the Monte Carlo technique used in nearly all dust RT codes fails to properly handle high optical depths, which was confirmed in follow-up studies (Camps & Baes 2018; Krieger & Wolf 2020). In addition to hopefully yielding answers to the spatial resolution problem raised here, a 3D Ly benchmark setup could be used to validate other or new implementations of Ly line transfer for complex geometries.
6. SUMMARY
In this work we describe the recent implementation of Ly resonant line transfer in our RT code SKIRT. We verify its operation for the spherically symmetric setups introduced by Dijkstra et al. (2006) and Tasitsiomi (2006) and for some more general 3D setups constructed through SKIRT's built-in geometries or imported from external input. We specifically test the various spatial discretization mechanisms offered by SKIRT, including regular Cartesian grids, hierarchical octree grids, and unstructured Voronoi tessellations.
We then build a Ly RT post-processing model for the redshift-zero snapshot of the Au5 spiral galaxy produced by the Auriga cosmological zoom simulations (Grand et al. 2017). This model includes stellar continuum emission with a fraction of the ionizing radiation converted to Ly emission, neutral atomic hydrogen (at a reduced density for practical reasons), dust, and kinematics for all sources and media. Fig. 6 presents Ly line profiles emerging in three directions from this model, calculated by SKIRT using four spatial grids with varying resolution. The shape and magnitude of the line profiles varies greatly depending on the grid, rendering the results untrustworthy at best. Further investigation, illustrated in Fig. 7, reveals that a dust-only model does not show any discrepancies between the results for various grids, while a static hydrogen-only model with the same density distribution as the full Au5 model continues to suffer from a severe sensitivity to the type and resolution of the spatial discretization.
The key difference between the simplified Au5 model (Fig. 5) and our earlier clumpy box test model (Fig. 4),

Spatial Discretization in Ly RT

13

for which there are no noticeable grid effects, is the dynamic range of the hydrogen density, causing steep gradients that are unresolved by the spatial grid of the simulation. We argue that the hydrogen density distribution produced by the Auriga simulations, and probably by most if not all present-day cosmological zoom simulations of Milky-Way sized objects, do not have sufficient resolution to overcome this problem. We therefore suggest that further research is needed to determine the required spatial resolution of such a hydrodynamical simulation snapshot to enable meaningful Ly RT post-processing. Once this requirement has been met, it becomes possible to devise and fine-tune appropriate core skipping acceleration schemes and parameters.

ACKNOWLEDGMENTS
AUK acknowledges the financial support of the Flemish Fund for Scientific Research (FWO-Vlaanderen), research projects G039216N and G030319N.
This work used the DiRAC@Durham facility managed by the Institute for Computational Cosmology on behalf of the STFC DiRAC HPC Facility (www.dirac.ac.uk). The equipment was funded by BEIS capital funding via STFC capital grants ST/K00042X/1, ST/P002293/1, ST/R002371/1 and ST/S002502/1, Durham University and STFC operations grant ST/R000832/1. DiRAC is part of the National e-Infrastructure.

APPENDIX

A. Ly SCATTERING CROSS SECTION

For the sake of completeness, we provide more detailed definitions of the various quantities involved in the calculation of the Ly scattering cross section.
Considering a neutral hydrogen gas at temperature T , and assuming a Maxwell-Boltzmann velocity distribution, the characteristic thermal velocity vth is given by

vth =

2kBT mp

(A1)

where kB is the Boltzmann constant and mp is the proton mass. The dimensionless frequency variable x is then defined as

x =  -  c  vth

(A2)

where  = c/ is the regular frequency variable,  = c/ is the frequency at the Ly line center,  = 1215.67 ∞A is the wavelength at the Ly line center, and c is the speed of light in vacuum.
The convolution of the single-atom cross section with the Maxwell-Boltzmann velocity distribution yields the following expression for the velocity-weighted Ly scattering cross section (x, T ) of a hydrogen gas at temperature T as a function of the dimensionless photon frequency x:

(x, T ) = ,0(T ) H(av(T ), x)

(A3)

where the cross section at the Ly line center ,0(T ) is

given by

,0(T )

=

32av(T ) 2

(A4)

the Voigt parameter av(T ) is given by

av(T )

=

A 4

c vth

(A5)

with A = 6.25 ◊ 108 s-1 the Einstein A-coefficient of the Ly transition; and the Voigt function H(av, x) is defined by

H(av, x)

=

av 

 e-y2 dy

e-x2

-

(y - x)2

+ a2v





av x2

core wings

(A6)

which is normalized so that H(av, 0)  1 for av 1. The optical depth 0 at the Ly line center along a
path with neutral hydrogen number column density NHi is given by 0 = NHi ,0. With the above definitions, it is easy to derive the following relations with a pro-

portionality factor that depends solely on physical con-

stants:

 ,0  av  1/ T

(A7)

av0  NHi/T

(A8)

14

Camps et al.

REFERENCES

Abe, M., Suzuki, H., Hasegawa, K., et al. 2018, MNRAS, 476, 2664, doi: 10.1093/mnras/sty233
Ahn, S.-H., Lee, H.-W., & Lee, H. M. 2002, ApJ, 567, 922, doi: 10.1086/338497
Baes, M., & Camps, P. 2015, Astronomy and Computing, 12, 33, doi: 10.1016/j.ascom.2015.05.006
Baes, M., Verstappen, J., De Looze, I., et al. 2011, The Astrophysical Journal Supplement Series, 196, 22, doi: 10.1088/0067-0049/196/2/22
Baes, M., Davies, J. I., Dejonghe, H., et al. 2003, MNRAS, 343, 1081, doi: 10.1046/j.1365-8711.2003.06770.x
Baes, M., Trcka, A., Camps, P., et al. 2020, MNRAS, 494, 2912, doi: 10.1093/mnras/staa990
Bah¥e, Y. M., Crain, R. A., Kauffmann, G., et al. 2016, MNRAS, 456, 1115, doi: 10.1093/mnras/stv2674
Behrens, C., & Niemeyer, J. 2013, A&A, 556, A5, doi: 10.1051/0004-6361/201321172
Behrens, C., Pallottini, A., Ferrara, A., Gallerani, S., & Vallini, L. 2018, MNRAS, 477, 552, doi: 10.1093/mnras/sty552
--. 2019, MNRAS, 486, 2197, doi: 10.1093/mnras/stz980 Bruzual, G., & Charlot, S. 2003, MNRAS, 344, 1000,
doi: 10.1046/j.1365-8711.2003.06897.x Camps, P., & Baes, M. 2015, Astronomy and Computing,
9, 20, doi: 10.1016/j.ascom.2014.10.004 --. 2018, ApJ, 861, 80, doi: 10.3847/1538-4357/aac824 --. 2020, Astronomy and Computing, 31, 100381,
doi: 10.1016/j.ascom.2020.100381 Camps, P., Baes, M., & Saftly, W. 2013, A&A, 560, A35,
doi: 10.1051/0004-6361/201322281 Camps, P., Trayford, J. W., Baes, M., et al. 2016, MNRAS,
462, 1057, doi: 10.1093/mnras/stw1735 Camps, P., Trcka, A., Trayford, J., et al. 2018, ApJS, 234,
20, doi: 10.3847/1538-4365/aaa24c Cashwell, E. D., & Everett, C. J. 1959, A practical manual
on the Monte Carlo method for random walk problems, International tracts in computer science and technology and their application (Oxford: Pergamon Press) Ciesla, L., Boquien, M., Boselli, A., et al. 2014, A&A, 565, A128, doi: 10.1051/0004-6361/201323248 Crain, R. A., Schaye, J., Bower, R. G., et al. 2015, MNRAS, 450, 1937, doi: 10.1093/mnras/stv725 Crain, R. A., Bah¥e, Y. M., Lagos, C. d. P., et al. 2017, MNRAS, 464, 4204, doi: 10.1093/mnras/stw2586 Dav¥e, R., Angl¥es-Alca¥zar, D., Narayanan, D., et al. 2019, MNRAS, 486, 2827, doi: 10.1093/mnras/stz937 Dav¥e, R., Crain, R. A., Stevens, A. R. H., et al. 2020, MNRAS, 497, 146, doi: 10.1093/mnras/staa1894

De Geyter, G., Baes, M., Camps, P., et al. 2014, MNRAS, 441, 869, doi: 10.1093/mnras/stu612
Diemer, B., Stevens, A. R. H., Lagos, C. d. P., et al. 2019, MNRAS, 487, 1529, doi: 10.1093/mnras/stz1323
Dijkstra, M. 2014, PASA, 31, e040, doi: 10.1017/pasa.2014.33
--. 2019, Saas-Fee Advanced Course, 46, 1, doi: 10.1007/978-3-662-59623-4 1
Dijkstra, M., Haiman, Z., & Spaans, M. 2006, ApJ, 649, 14, doi: 10.1086/506243
Dijkstra, M., & Loeb, A. 2008, MNRAS, 386, 492, doi: 10.1111/j.1365-2966.2008.13066.x
Gadotti, D. A., Baes, M., & Falony, S. 2010, MNRAS, 403, 2053, doi: 10.1111/j.1365-2966.2010.16243.x
Galliano, F., Galametz, M., & Jones, A. P. 2018, ARA&A, 56, 673, doi: 10.1146/annurev-astro-081817-051900
Gnedin, N. Y., & Kravtsov, A. V. 2011, ApJ, 728, 88, doi: 10.1088/0004-637X/728/2/88
Gordon, K. D., Baes, M., Bianchi, S., et al. 2017, A&A, 603, A114, doi: 10.1051/0004-6361/201629976
Grand, R. J. J., Go¥mez, F. A., Marinacci, F., et al. 2017, MNRAS, 467, 179, doi: 10.1093/mnras/stx071
Gronke, M., & Bird, S. 2017, ApJ, 835, 207, doi: 10.3847/1538-4357/835/2/207
Groves, B., Dopita, M. A., Sutherland, R. S., et al. 2008, ApJS, 176, 438, doi: 10.1086/528711
Hayes, M. 2015, PASA, 32, e027, doi: 10.1017/pasa.2015.25 --. 2019, Saas-Fee Advanced Course, 46, 319,
doi: 10.1007/978-3-662-59623-4 4 Inoue, S., Yoshida, N., & Yajima, H. 2020, MNRAS, 498,
5960, doi: 10.1093/mnras/staa2744 Jones, A. P., Ko®hler, M., Ysard, N., Bocchio, M., &
Verstraete, L. 2017, A&A, 602, A46, doi: 10.1051/0004-6361/201630225 Jonsson, P. 2006, MNRAS, 372, 2, doi: 10.1111/j.1365-2966.2006.10884.x Jonsson, P., Groves, B. A., & Cox, T. J. 2010, MNRAS, 403, 17, doi: 10.1111/j.1365-2966.2009.16087.x Kapoor, A. U., Camps, P., Baes, M., et al. 2021, MNRAS, in preparation Krieger, A., & Wolf, S. 2020, arXiv e-prints, arXiv:2011.14905. https://arxiv.org/abs/2011.14905 Laursen, P., Razoumov, A. O., & Sommer-Larsen, J. 2009, ApJ, 696, 853, doi: 10.1088/0004-637X/696/1/853 Lee, D., Baes, M., Seon, K.-I., et al. 2016, MNRAS, 463, 2912, doi: 10.1093/mnras/stw2201 Liang, L., Feldmann, R., Faucher-Gigu`ere, C.-A., et al. 2018, MNRAS, 478, L83, doi: 10.1093/mnrasl/sly071

Spatial Discretization in Ly RT

15

Ma, X., Hayward, C. C., Casey, C. M., et al. 2019, MNRAS, 487, 1844, doi: 10.1093/mnras/stz1324
Marinacci, F., Grand, R. J. J., Pakmor, R., et al. 2017, MNRAS, 466, 3859, doi: 10.1093/mnras/stw3366
Michel-Dansac, L., Blaizot, J., Garel, T., et al. 2020, A&A, 635, A154, doi: 10.1051/0004-6361/201834961
Mitchell, P. D., Blaizot, J., Cadiou, C., et al. 2021, MNRAS, 501, 5757, doi: 10.1093/mnras/stab035
Narayanan, D., Turk, M. J., Robitaille, T., et al. 2021, ApJS, 252, 12, doi: 10.3847/1538-4365/abc487
Neufeld, D. A. 1990, ApJ, 350, 216, doi: 10.1086/168375 Niccolini, G., Woitke, P., & Lopez, B. 2003, A&A, 399, 703,
doi: 10.1051/0004-6361:20021761 Ouchi, M., Ono, Y., & Shibuya, T. 2020, ARA&A, 58, 617,
doi: 10.1146/annurev-astro-032620-021859 Peest, C., Camps, P., Stalevski, M., Baes, M., &
Siebenmorgen, R. 2017, A&A, 601, A92, doi: 10.1051/0004-6361/201630157 Pillepich, A., Springel, V., Nelson, D., et al. 2018, MNRAS, 473, 4077, doi: 10.1093/mnras/stx2656 Reissl, S., Wolf, S., & Brauer, R. 2016, A&A, 593, A87, doi: 10.1051/0004-6361/201424930 Robitaille, T. P. 2011, A&A, 536, A79, doi: 10.1051/0004-6361/201117150 Rodriguez-Gomez, V., Snyder, G. F., Lotz, J. M., et al. 2019, MNRAS, 483, 4140, doi: 10.1093/mnras/sty3345 Saftly, W., Baes, M., & Camps, P. 2014, A&A, 561, A77, doi: 10.1051/0004-6361/201322593 Saftly, W., Baes, M., De Geyter, G., et al. 2015, A&A, 576, A31, doi: 10.1051/0004-6361/201425445 Saftly, W., Camps, P., Baes, M., et al. 2013, A&A, 554, A10, doi: 10.1051/0004-6361/201220854 Schaye, J., Crain, R. A., Bower, R. G., et al. 2015, MNRAS, 446, 521, doi: 10.1093/mnras/stu2058 Seon, K.-i., & Kim, C.-G. 2020, ApJS, 250, 9, doi: 10.3847/1538-4365/aba2d6 Shen, X., Vogelsberger, M., Nelson, D., et al. 2020, MNRAS, 495, 4747, doi: 10.1093/mnras/staa1423 Smith, A., Safranek-Shrader, C., Bromm, V., & Milosavljevi¥c, M. 2015, MNRAS, 449, 4336, doi: 10.1093/mnras/stv565

Somerville, R. S., & Dav¥e, R. 2015, ARA&A, 53, 51, doi: 10.1146/annurev-astro-082812-140951
Springel, V. 2010, MNRAS, 401, 791, doi: 10.1111/j.1365-2966.2009.15715.x
Springel, V., & Hernquist, L. 2003, MNRAS, 339, 289, doi: 10.1046/j.1365-8711.2003.06206.x
Steinacker, J., Baes, M., & Gordon, K. D. 2013, ARA&A, 51, 63, doi: 10.1146/annurev-astro-082812-141042
Tasitsiomi, A. 2006, ApJ, 645, 792, doi: 10.1086/504460 Torrey, P., Snyder, G. F., Vogelsberger, M., et al. 2015,
MNRAS, 447, 2753, doi: 10.1093/mnras/stu2592 Trayford, J. W., Camps, P., Theuns, T., et al. 2017,
MNRAS, 470, 771, doi: 10.1093/mnras/stx1051 Trcka, A., Baes, M., Camps, P., et al. 2020, MNRAS, 494,
2823, doi: 10.1093/mnras/staa857 van Zadelhoff, G. J., Dullemond, C. P., van der Tak,
F. F. S., et al. 2002, A&A, 395, 373, doi: 10.1051/0004-6361:20021226 Verhamme, A., Schaerer, D., & Maselli, A. 2006, A&A, 460, 397, doi: 10.1051/0004-6361:20065554 Verstocken, S., Van De Putte, D., Camps, P., & Baes, M. 2017, Astronomy and Computing, 20, 16, doi: 10.1016/j.ascom.2017.05.003 Viaene, S., Baes, M., Bendo, G., et al. 2016, A&A, 586, A13, doi: 10.1051/0004-6361/201527586 Vogelsberger, M., Genel, S., Sijacki, D., et al. 2013, MNRAS, 436, 3031, doi: 10.1093/mnras/stt1789 Vogelsberger, M., Marinacci, F., Torrey, P., & Puchwein, E. 2020a, Nature Reviews Physics, 2, 42, doi: 10.1038/s42254-019-0127-2 Vogelsberger, M., Nelson, D., Pillepich, A., et al. 2020b, MNRAS, 492, 5167, doi: 10.1093/mnras/staa137 Voronoi, G. 1908, Journal fu®r die reine und angewandte Mathematik, 134, 198 Yajima, H., Li, Y., Zhu, Q., & Abel, T. 2012, MNRAS, 424, 884, doi: 10.1111/j.1365-2966.2012.21228.x Yusef-Zadeh, F., Morris, M., & White, R. L. 1984, ApJ, 278, 186, doi: 10.1086/161780 Zheng, Z., & Miralda-Escud¥e, J. 2002, ApJ, 578, 33, doi: 10.1086/342400

