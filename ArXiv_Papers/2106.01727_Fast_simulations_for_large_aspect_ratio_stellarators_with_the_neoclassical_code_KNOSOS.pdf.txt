arXiv:2106.01727v1 [physics.plasm-ph] 3 Jun 2021

Fast simulations for large aspect ratio stellarators with the neoclassical code KNOSOS
J L Velasco1, I Calvo1, F I Parra2, V d'Herbemont2,3, H M Smith4, D Carralero1, T Estrada1 and the W7-X team
1 Laboratorio Nacional de Fusi´on, CIEMAT, Madrid, Spain 2 Rudolf Peierls Centre for Theoretical Physics, University of Oxford, Oxford, United Kingdom 3 Mines ParisTech, Paris, France 4 Max-Planck Institut fu¨r Plasmaphysik, Greifswald, Germany E-mail: joseluis.velasco@ciemat.es
4 June 2021
Abstract. In this work, a new version of KNOSOS is presented. KNOSOS is a low-collisionality
radially-local, bounce-averaged neoclassical code that is extremely fast, and at the same time, includes physical effects often neglected by more standard codes: the component of the magnetic drift that is tangent to the flux-surface and the variation of the electrostatic potential on the flux-surface. An earlier version of the code could only describe configurations that were sufficiently optimized with respect to neoclassical transport. KNOSOS can now be applied to any large aspect ratio stellarator, and its performance is demonstrated by means of detailed simulations in the configuration space of Wendelstein 7-X.
1. Introduction
An accurate calculation of radial neoclassical transport is important for both tokamaks and stellarators. In tokamaks, deviations of the magnetic field from axisymmetry (caused, for example, by ripple due to the finite number of coils or by resonant magnetic perturbations) can result in significant neoclassical damping of the toroidal rotation [1]. In stellarators, their intrinsically three-dimensional configurations leads to specific neoclassical transport regimes (see e.g. [2, 3]) that produce radial energy transport comparable, and often larger, than its turbulent counterpart [4]. Although typically less demanding than gyrokinetic codes, the computational cost of neoclassical simulations is crucial for a thorough characterization of transport in three-dimensional configurations, especially at low plasma collisionalities. In this work we present a new version of KNOSOS [5] (KiNetic Orbit-averaging SOlver for Stellarators), a freely-available open-source code that provides a fast computation of low collisionality neoclassical transport in three-dimensional magnetic confinement devices by rigorously solving the

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

2

radially local bounce-averaged drift kinetic equation coupled to the quasineutrality equation. Apart from its remarkable speed, KNOSOS [5] includes physics often neglected in neoclassical codes, such as the effect of the component of the magnetic drift that is tangent to magnetic surfaces and the component of the electrostatic potential that varies on the magnetic surface, 1 [6] (only recently did stellarator neoclassical codes start to calculate 1, and at a large computational cost). The latter quantity can have a strong impact on the radial transport of highly-charged impurities in threedimensional magnetic configurations [7]. The fast calculation of the bounce averaged main ion distribution with KNOSOS opens the door to a fast evaluation of neoclassical impurity transport using recently-derived analytical expressions [8, 7].
An earlier version of KNOSOS [5] relied on closeness to omnigeneity (i.e., to perfect optimization with respect to neoclassical transport) to model neoclassical transport with a radially local equation. The new version of the code implements and solves the local equations derived in [9], valid for stellarators of large aspect ratio and arbitrary degree of neoclassical optimization as long as the radial electric field is not too small (see below). The rest of the paper is organized as follows: in section 2, the motivation and goals are discussed in detail. Section 3 presents the equations, whose implementation is described in section 4 and employed in the examples of section 5. In section 5.1 we show that, where applicable, the new version of KNOSOS reproduces the results of DKES, being orders of magnitude faster (a comparison of the equations solved by KNOSOS and DKES is made in Appendix A). In section 5.2 we illustrate how, when the radial electric field is small, by retaining the effect of the component of the magnetic drift that is tangent to magnetic surfaces, KNOSOS can describe the superbana-plateau transport regime of stellarators close to omnigeneity. Section 6 summarizes the results and outlines several planned applications of KNOSOS.

2. Motivation and goal

Since the general goal of this work is to provide a fast and accurate calculation of

neoclassical transport of stellarators at low collisionality, in this section we provide a

brief overview of the relevant transport regimes in the large aspect ratio limit (a more

detailed discussion can be found e.g. in [2, 3, 10]). To that end, figure 1 represents

the radial transport on a flux-surface of a stellarator configuration as a function of the

collisionality  = R/(v) and the normalized radial electric field Er/(v B ). Here,  is the collision frequency, R the major radius,  is the rotational transform, v is the

velocity, Er is the radial electric field and B is the average magnetic field strength on the flux-surface. The level of transport is represented by the so-called monoenergetic

transport coefficient D11, which is related to the radial energy flux by



Qb 

dvFM,bbD11 .

(1)

0

A precise definition of D11 can be found in [2, 5].

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

3

Figure 1: Monoenergetic radial transport coefficient D11 as a function of the collisionality and normalized radial electric field. The higher collisionality cases have been calculated with DKES, and the lower collisionality ones, with KNOSOS (in the large aspect ratio limit, as in section 5.1).
At high collisionality, a stellarator configuration displays the same neoclassical transport regimes as an axisymmetric tokamak: Pfirsch-Schlu¨ter and plateau. However, due to its intrinsic three-dimensionality, its low-collisionality neoclassical regimes are stellarator specific: for 3/2  / , with  = /R the normalized Larmor radius,
= a/R the inverse aspect ratio and a the stellarator minor radius, the plasma is in the 1/ regime; for smaller collisionalities,  / , the  or  regimes dominate transport [9]. All these regimes can be computed with standard neoclassical codes such as DKES [11]. There are, however, two limitations to what codes like DKES can do.
First, for small  (and Er of standard size) the distribution function becomes increasingly localized in phase space. For this reason, while the high collisionality regimes are easy to calculate numerically, the calculation of the  or  fluxes comes at a large computational cost. In the case of the 1/ regime, this limitation has been circumvented by using a code, NEO [12], that efficiently solves a bounce-averaged driftkinetic equation specific of the 1/ regime of stellarators. However, no equivalently fast code exists for the  and  regimes for general stellarator geometry (fast codes such as GSRAKE [13, 2] and NEO-2 [14] can be applied to particular geometries). The lack of a fast neoclassical code for such regimes has an impact on the availability of stellarator optimization strategies (stellarator optimization is the term employed to describe the

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

4

tailoring of the magnetic configuration to meet a certain series of criteria). Minimization of neoclassical transport, a standard optimization criterion, usually targets the 1/ flux [15]: the transport of electrons (that are in the 1/ regime) is reduced; this causes a negative Er that indirectly reduces the transport of ions (that are expected to be in the  or  regimes). Although this optimization strategy has proven to be successful (e.g. in the design of the stellarator Wendelstein 7-X), addressing directly the  or  flux as well could lead to more efficient approaches, which could be beneficial when additional criteria (such as magnetohydrodinamic stability, reduced turbulence...) exist.
Second, the above-mentioned regimes are obtained by solving a drift kinetic equation that neglects the component of the magnetic drift that is tangent to the flux-surface in the particle orbits [2]. While this is correct if the aspect ratio 1/ is large and Er has the standard size (Er  T /(ae), with T the temperature and e the elementary charge; more precise definitions of "standard size" and "small" Er will be provided in sections 5.1 and 5.2), there exist scenarios in which this drift-kinetic equation is not accurate. Examples of this are compact stellarators (stellarators with values of 1/ down to 2.5 have been designed [16]) or plasma scenarios with electron temperature significantly greater than the ion temperature. An extreme example of this is the crossover region in plasmas displaying electron root (Er > 0) in the core and ion root (Er < 0) closer to the edge, see e.g. [17]. In these situations, for  , an additional regime may appear [3], the superbanana-plateau regime. However, because of the lack of tangential magnetic drift, codes as such DKES will incorrectly predict a 1/ regime. The collisionality range where this happens is roughly indicated by a dashed closed line in figure 1.
The goal of this work is twofold: first, to show that the equations now implemented in KNOSOS produce fast and accurate calculations of neoclassical transport for large aspect ratio stellarators at low collisionality and radial electric field of standard size; second, to provide examples of accurate (provided that the magnetic configuration is close to omnigeneity) computations at low collisionality and small radial electric field.

3. Equations
We will employ spatial coordinates that are aligned with the magnetic field B. The flux-surfaces are labelled by  = |t|, where 2t is the toroidal magnetic flux, and  =  -  labels magnetic field lines on the surface. Here,  and  are Boozer angles and  is the rotational transform. Finally, l is the arc length along the magnetic field line. As for velocity phase space, we will employ the magnitude of the velocity v = |v|, the pitch-angle coordinate  =v2 /(v2B) and the sign of the parallel velocity  = v /v. As usually, v = v · B/B = v 1 - B and v = v2 - v2.
In order to compute radial neoclassical transport at low collisionality, we need to calculate, for each bulk species b, gb(, , , v): the deviation of the distribution function from a Maxwellian FM,b for trapped particles (i.e. for those whose parallel velocity becomes zero at some point of their orbit). We need to solve the following

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

5

partial differential equation:

lb2 dl lb1 |v |

B vM,b + B vE

·  ( + |J ) gb -

lb2 lb1

dl |v |

Cblin[gb

]

=

=-

lb2 lb1

dl |v | (vM,b

+ vE) · bFM,b ,

(2)

complemented with gb = 0 at the boundary between trapped and passing particles. In

this equation, the coefficients are integrals over l, at constant  and , between bounce

points lb1 and lb2, defined as the positions where v = 0:

1

B(, lb1) = B(, lb2) =  .

(3)

On the right-hand side of equation (2),

b

=

 nb nb

+

 Tb Tb

mbv2 - 3 2Tb 2

+ Zbe0 Tb

(4)

is a combination of thermodynamical forces,

Cblin[gb]

=

,bv|| v2B



v||gb

(5)

is the linearized pitch-angle collision operator, and

vM,b

=

mbv2 Zbe

1 - B 2

B × B B3

vE

=

-

 × B B2

(6)

are the magnetic and E × B drifts. In these equations, as usual, mb is the mass,

Zbe is the charge, Tb is the temperature and nb is the density. The electrostatic

potential  = 0() + 1(, , l) needs to be estimated by solving the ambipolarity and

quasineutrality equations (these equations are written explicitly in [10, 5] and remain

valid for large aspect ratio stellarators) consistently with the drift-kinetic equation.

Here, 0 is the piece of  that does not depend on the angular coordinates. Finally, the

term with

|J  -

lb2 lb1

dl |v

|

B

B lb2 dl
lb1 |v |

(7)

ensures that the particle orbits conserve the second adiabatic invariant

 lb2

J(, , v, ) = 2v dl 1 - B .

(8)

lb1

This can be checked by employing the identities

B

=

-

2 v2b J

B

=

-

2 v2b J ,

(9)

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

6

where the orbit average of a function f is defined as

1 f=

lb2 dl f (, , l, v, , )

(10)

vb  lb1

1 - B

in the trapped region and

2 b = v

lb2
dl 

1

lb1

1 - B

(11)

is the bounce time.

Let us end this section by laying out the assumptions made for the derivation of

equation (2) (details are discussed rigorously in [3, 9]). At low collisionality, the motion

of trapped particles along B (i.e. in the l coordinate) is much faster than collisions.

In this limit, the distribution function becomes independent of arc-length l and the

coefficients of the equation are integrals over l between the bounce points. This is

therefore an ansatz that is specific of a bounce-averaged code for radial transport. The

collisions in equation (2) are modelled by means of a pitch-angle collision operator,

which is common to DKES and all the other monoenergetic codes in [2], and is valid for

trapped particles if the magnetic configuration has large aspect ratio, 1.

Finally, there are two limits in which neoclassical transport can be modelled

accurately by a drift kinetic equation which only describes trapped particles and that

is radially-local (i.e. does not contain terms proportional to gb, like for example the drift-kinetic equation solved in [18]), such as equation (2). First, when the configuration

is close enough to omnigeneity. The previous version of KNOSOS [5] made use of this limit.

Second, when, additionally to 1, Er is of standard size [9]. In Appendix A we show that, in this limit, equation (2) is equivalent to the drift-kinetic equation solved by DKES.

The version of KNOSOS presented in this work solves numerically equation (2), and

is therefore valid in these two limits and in particular can now describe large aspect

ratio stellarators irrespectively of its degree of optimization for Er of standard size. The implementation of equation (2) is discussed in section 4 and its application in the two

limits is demonstrated in sections 5.1 and 5.2, respectively. This discussion and the

content of the rest of the paper is outlined in table 1.

4. Numerical solution of equation (2)

In this section we provide an overview of how equation (2) is solved. The same implementation will be valid for the two limits in which the equation will be employed. In particular, most of what was discussed in section 3 of [5] for stellarators close to omnigeneity remains valid, and in this section we will focus mainly on what has changed. We start by providing a more explicit expression of equation (2):

IvM, (,

)

+

 0 vd,b

IvE

,

(,

)

( + |J ) gb

-

,b vd,b



[I

(,

)gb]

=

-

1 IvM, (, ) + vd,b IvE, (, )

FM,bb ,

(12)

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

7

starting point implemented in
valid for ...in two limits
applicability
in this limit equation (2) leads to
derived in employed first in can describe regimes main improvement
w.r.t. DKES relevant for
exemplified in

equation (2)

section 4

low collisionality, 1 and...

Er of standard size Er  Tb/(a Zbe)

closeness to omnigeneity

most stellarator scenarios

applied by all local codes

when Er Tb/(a Zbe)

equation (31) [9]
[9] andthis work 1/,  and  fast computation

equation (32)

[3, 10]



[5]

1/,  and superbanana-plateau

superbanana-plateau

stellarator optimization section 5.1

characterization of high Ti experiments section 5.2

Table 1: Summary of assumptions and applicability of equation (2).

with

IvE,

= t

lb2


dl

,

lb1 1 - B

IvM, =

lb2


dl

lb1 1 - B

1 - B 2

t

 B B

+

B B B|B

- B + B|

B







,

IvE, =

lb2 lb1

 dl 1 - B

B 1 - B 1 |B + B|

,

IvM, = I =

lb2


dl

1 - B

lb1 lb2

1 - B 
 1 - B

2

dl

,

lb1

B

BB - BB B|B + B|

,

|J = -

lb2
dl 

B

lb1

1 - B

lb2 dl B

.

lb1

1 - B

(13)

Here, B = 0, B and B are the covariant components of B in Boozer coordinates

B = B + B + B ,

(14)

with B = 0 in the low- approximation. The radial coordinate  is a parameter in equation (13), and radially-local
independent calculations can thus be performed at different flux-surfaces of a magnetic configuration. Similarly, the magnitude of the velocity v is a parameter, and so-called

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

8

Figure 2: Construction of the angular grid (see text) for a flux surface of Wendelstein 7-X (top); zoom (bottom).

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

9

monoenergetic calculations can be performed separately for a range of values of v; then,

quantities such as the radial energy flux can be computed efficiently by Gauss-Laguerre

integration on v of the corresponding solutions, as discussed at the end of section 3.3

of [5].

The main difference between KNOSOS and other neoclassical codes is that l is not

a variable: gb is independent of the arc­length and the coefficients of equation (13) are bounce-integrals, whose fast and accurate integration by means of an extended

midpoint rule is discussed in detail in section 3.2 and the appendices of [5]. Furthermore,

the dependence of transport on the magnetic configuration and the species has been

separated in equation (13). The integrals of equation (13) depend on the former, while

the latter is encapsulated in

vd,b



mbv2 Zbe

,

(15)

together with ,b, FM,b and b (these three quantities contain as well information of the kinetic profiles). For this reason, the integrals of equation (13) need to be calculated

once and can then be employed in subsequent calculations for other species or plasma

parameters.

The resulting drift-kinetic equation is thus a differential equation in two variables,

 and . In the next two subsections, we describe how the bidimensional grid is

constructed, and how the drift-kinetic equation is discretized.

4.1. New spatial grid
The distribution function gb, as well as the coefficients that need to be computed to solve the drift-kinetic equation, are evaluated in a discrete set of points (, ). In this subsection we summarize how these points are selected. The pitch angle variable is discretized exactly as in [5]: we employ a uniform grid with N + 1 values between 1  1/Bmax and N+1  1/Bmin, being Bmax and Bmin the maximum and minimum of B on the flux-surface respectively. N+1 will be a ghost point where the boundary conditions at the bottom of the well are imposed. It must be noted that, in a nonomnigenous stellarator, the magnetic field well depth depends on , an so does the maximum reachable value of . For an arbitrary field line there may exist less points than N+1 in the  grid (when this is the case, the role of ghost point will be played by a grid point with smaller index). As in [5], when integrating in , we will use the extended trapezoidal rule.
We use figure 2 (top), which shows one example of stellarator flux surface (of the standard Wendelstein 7-X configuration, discussed in section 5.1) to describe how the angular grid is now built. First, a field line is followed until it completes a large number (of the order of 100) of toroidal periods, N. Along this line, the yellow points are selected with uniform spacing in the toroidal angle, starting at  = 0. This spacing is (2/N )/Nl, being Nl a power of 2 comparable to N (this will be useful for a fast computation of the Fourier transform, needed when solving quasineutrality). Next,

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

10

periodicity is employed to project all these grid points onto the first toroidal period. The result is a bidimensional grid in  and l, of size N × Nl, as shown in figure 2 (bottom) in light blue. It is aligned with the field lines and (except for values of  close to a rational surface) samples correctly a toroidal period (in general, non uniformly in ). This is a procedure similar to the one employed e.g. by NEO [12]. In the previous version of KNOSOS, several field lines, uniformely distributed in , were followed, instead of one.
This new discretization facilitates an improved sampling of the region of phase space where barely trapped particles live, which can be necessary for an accurate calculation of the  and  regimes at low collisionality. The green circles of figure 2 correspond to maxima of the magnetic field strength along the magnetic field line. Most trapped particles are so in a major well that coincides with one field period (black continuous arrow). In other words, their bounce points lb1 and lb2 are two consecutive green points, separated toroidally by a characteristic angular distance  2/N . This distance will be smaller for large values of , close to the bottom of the magnetic well. Conversely, particles with relatively small  will have their bounce points separated by several toroidal periods. The field-line segment that constitutes the spatial grid has been chosen so that the value of B at the two extremes is as close as possible to Bmax (in a nonrational flux-surface, B at the two extremes could be exactly equal to Bmax only after an infinite number of toroidal turns). As a consequence of this, those particles with  close enough to 1/Bmax will bounce back and forth between the two extremes of the segment (part of the trajectory is marked by the black dashed arrow). These particles are trapped with their bounce points separated N toroidal field periods. If we have chosen a long enough segment, the trajectory practically samples the whole flux-surface, and we can set this  to be the boundary between trapped and passing, i.e., gb = 0 for these particles. Particles with smaller  will be considered to be passing, and will not contribute to radial transport.
To conclude this subsection, we note that several ripple wells, indicated by grey arrows, have been found in the example of figure 2 (grey arrows). As a consequence of this, at a given  and , several wells may exist (i.e., several pairs of lb1 and lb2), and an additional integer label w needs to be employed for them. Altogether, three integers can be used to label any point (i, j, w) of this grid: i runs from 1 to N, j from 1 to N and w = I, II... is an integer that labels wells for a given  and . At a given point, we define gi,j,w  gb(i, j, w), I,i,j,w  I(i, j, w), and the same applies to any function of the phase space (in order to ease the notation, gi,j,w does not contain a species index).

4.2. New discretization of the orbits
In section 4.1 we have built the grid in variables  and . The final step in the discretization of the drift-kinetic equation is how we approximate the derivatives of gb of equation (12) at each point of this grid.

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

11

Three different kinds of terms need to be discretized: the boundary conditions, the

collision operator and the orbits. The two former contain only derivatives in  at fixed

, and have not changed with respect to [5], where they were explained in detail. Things

are different with the orbits, since both the drift-kinetic equation and the grid are now

slightly different. This term reads

IvM, (,

)

+

 0 vd,b

IvE

,

(,

)

( + |J ) gb .

(16)

As written in equation (16), this term contains derivatives in  (at constant ) and

 (at constant ) and, at an arbitrary point, non-centered finite differences with first-

order accuracy are used. For a given flux surface, for each solution of the drift-kinetic

equation, the sign of the coefficient in front of gb (i.e. the direction of the flow in the

 direction) indicates whether forward or backward differences are employed, i.e.

gb|i,j,w

=

gi+1,j,w i+1

- -

gi,j,w i

or

gb|i,j,w

=

gi,j,w i

- -

gi-1,j,w i-1

.

(17) (18)

The same applies to gb, where forward differences

gb|i,j,w

=

gi,j+1,w j+1

- gi,j,w - j

(19)

or backward differences

gb|i,j,w

=

gi,j,w j

- gi,j-1,w - j-1

(20)

are used depending on the sign of the flow and of |J . The direction of the flow depends

on the plasma parameters, species, and . For this reason, during the first stages of

the neoclassical calculation, all the above discretizations are calculated. Then, for any

particular subsequent calculation (for instance, ions in the presence of a given value of

Er) and for each , the appropriate combination of the pre-calculated discretizations is employed at different points of phase-space.

An sketch of the  grid is depicted in figure 3 (top). In this example, for small

and large values of , equations (17) and (18) can be employed (except at 1 and N, where periodicity needs to be imposed, see below). However, things are different in the

vicinity of i0. When moving from small values of  up to i0, B becomes larger than

1/j for some values of l. As a consequence of this, the orbit breaks into two orbits, one

in region I and the other one in region II. Continuity of gb is imposed there to discretize

the forward derivative at i0 - 1,

gb|i0-1,j,I

=

gi0,j,I i0

- gi0-1,j,I - i0-1

=

gi0,j,II - gi0-1,j,I i0 - i0-1

,

(21)

and the backward derivative at i0,

gb|i0,j,I

=

gi0,j,I i0

- gi0-1,j,I - i0-1

,

 gb |i0 ,j,I I

=

gi0,j,II - gi0-1,j,I i0 - i0-1

.

(22)

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

12

Figure 3: Top: sketch of grid in  space at fixed . The derivatives with respect to  at constant  are discretized as in equations (17) and (18) except close to the limits of the grid (1 and N) and to bifurcations (e.g. i0). Bottom: sketch of grid in  space at larger  (the grid at smaller  is plotted for reference in dashed thin blue line). i1 is a point where the backward derivative is discretized as discussed in equation (29).
At values of  immediately above i0, equations (17) and (18) are again valid (and applied separately at regions I and II). However, there is a value of , at which regions I and II merge again into a single well labelled again I. There, expressions equivalent to equations (21) and (22) need to be employed.

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

13

Periodicity in  is easily imposed by replacing equation (17) at i = N with

gb|N,j,w

=

g1,j,w - gN,j,w 2 + 1 - N

,

(23)

and equation (18) at i = 1 with

gb|1,j,w

=

g1,j,w - gN,j,w 2 + 1 - N

.

(24)

Close to the boundary between passing and trapped, at j = 2, equation (20) needs to

be complemented with the boundary condition

gb|i,1,w = 0 ,

(25)

which yields

gb|i,2,w

=

gi,2,w 2 - 1

.

(26)

At the bottom, for the field line where B reaches the minimum value on the flux-surface,

the regularity condition reads



[I gb] |i,N,w

=

-I,i,N-1,w

(N

gi,N,w +1 - N

-
-1

gi,N-2,w )(N - N

-2)

,

(27)

where we have employed that gb is zero at exactly the bottom of the well, j = N + 1,

and gi,N+1,w (which is defined on a region of phase-space of vanishing volume) does not need to be computed. Additionally, because  [Igb] |i,N,w is not written explicitly in terms of a second order derivative, its discretization extends beyond nearest neighbours.

For field lines where the minimum of B is larger, similar contour conditions can be

written, that avoid having to evaluate equation (19) at points j such that gi,j+1,w is not defined.

This problem is not restricted to the bottom of the well or to the derivative with

respect to . While in an omnigenous magnetic field, the contours of minimum B on a

flux surface encircle (toroidally, poloidally, or helically) the plasma, this is not the case

for a generic stellarator, where local minima of B exist on the flux surface. Close to these

minima, moving in  at constant large  is not always possible, as these trajectories may not exist, and the same happens with moving in  at constant  even if j > N - 1. This situation is illustrated in figure 3 (bottom), at i1, where equation (18) cannot be employed. A model was used in [5] for dealing with these points, but here we can do

that rigorously by recalling that equation (16) can be interpreted as a derivative in 

at constant J. Then, one can use equation (18) but replacing gi1-1,j,w with a linear interpolation

gb|i1,j,w

=

gi1,j,w

-

W gi1-1,j0+1,w - (1 i1 - i1-1

-

W )gi1-1,j0,w

,

where j0 and W in the linear interpolation have been chosen so that

(28)

J (i1-1, j, w) = W J (i1-1, j0+1, w) + (1 - W )J (i1-1, j0, w)

(29)

and, if possible,

J (i1-1, j0+1, w) < J (i1-1, j, w) < J (i1-1, j0, w)

(30)

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

14

in order to favour interpolation over extrapolation (this means that, although it will be frequent that j0 = j or j0 + 1 = j, it will not always be the case). This procedure is followed in all the situations in which the nearest neighbour (in the sense of equations (17), (18), (19), (20)) does not exist.
We end this section by reminding the reader that, for each of the species b, we end up with an equation that is linear in gb and can be written as a linear problem in matrix form. The matrix that represents the orbits and the collision operator is square with approximately N × N elements per row, and sparse. Although their relative weight varies with ,b, vd,b and 0, the non-zero elements are always at the same position for a given flux surface. As [5], we solve the linear problem with a direct solver from the PETSc library based on LU factorization.

5. Results
In this section, we demonstrate the performance of the new version of KNOSOS . In 5.1 we benchmark it against DKES in the large aspect ratio limit. In section 5.2, we show the effect of the component of the magnetic drift that is tangent to magnetic surfaces in the analysis of stellarator transport.

5.1. Fast and accurate calculation at low  and Er of standard size
In this section, we deal with the neoclassical transport of bulk species b in large aspect ratio stellarators ( 1) for radial electric fields of size Er  Tb/(a Zbe) (this is the standard size of a radial electric field that is solution of an ambipolarity equation in which bulk species b intervenes). As a consequence, in equation (2), the terms including vM,b ·  and vE ·  are negligible. We are left with

lb2 dl lb1 |v |

B B

vE ·  ( + |J ) gb -

lb2 lb1

dl |v |

Cblin[gb]

=

-

lb2 lb1

dl |v | vM,b

· bFM,b .

(31)

This equation rigorously models the transport of large aspect-ratio stellarators at low

collisionality

3/2



and /

Er of standard size ) and the  or 

[9]. Specifically, it describes the regimes ( / ). For large

1/ regime (when aspect ratio, this

equation coincides with the orbit average of the equation solved by DKES (including the

incompressible E × B drift [11, 19], which is correct when More details are given in Appendix A.

1 and Er  Tb/(a Zbe)).

In order to benchmark KNOSOS, we perform calculations of the monoenergetic

transport coefficient D11 as a function of the collisionality and normalized radial electric field. We do so for 5 magnetic configurations (7 different flux-surfaces in each case,

labelled by s = /LCMS = 0.005, 0.046, 0.128, 0.250, 0.413, 0.617 and 0.862, where

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

15

Er /v B00

/(2)

Er /v B00

/(2)

1

1.04

102

DKES KNOSOS

10-4

101

100

10-5

B/B00 D11[A.U.]

10-1 10-2 10-3

10-6 10-7

10-4

10-8

0

0.96

10-6

10-5

10-4

10-3

0

/(2/N )

1



1

1.09

102

DKES KNOSOS

10-4

101

100

10-5

B/B00 D11[A.U.]

10-1 10-2 10-3

10-6 10-7

10-4

10-8

0

0.94

10-6

10-5

10-4

10-3

0

/(2/N )

1



1

1.15

102

DKES KNOSOS

10-4

101

100

10-5

B/B00 D11[A.U.]

10-1 10-2 10-3

10-6 10-7

10-4

10-8

0

0.88

10-6

10-5

10-4

10-3

0

/(2/N )

1



Er /v B00

/(2)

Figure 4: Magnetic field strength on the flux-surface (left) and monoenergetic radial transport coefficient D11 as a function of the collisionality and normalized radial electric field (right). The calculations correspond to configurations AIM (top), EIM (center) and KJM (bottom) of Wendelstein 7-X.

 = LCMS at the last closed flux-surface) in the configuration space of the stellarator Wendelstein 7-X: low-mirror (officially labelled AIM), standard (EIM), high-mirror (KJM), high-iota (FTM) and low-iota (DBM). This set comprises configurations with varying degree of optimization with respect to neoclassical transport. Figures 4 and 5 show a selection of the calculations, corresponding to s = 0.128. The agreement with DKES is good, and the computing time is much smaller: the full characterization of

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

16

Er /v B00

/(2)

1

1.09

102

DKES KNOSOS

10-4 101

B/B00 D11[A.U.]

100 10-1 10-2 10-3

10-5 10-6 10-7

10-4

10-8

0

0.92

10-6

10-5

10-4

10-3

0

/(2/N )

1



1

1.09

102

DKES KNOSOS

10-4

101

100

10-5

B/B00 D11[A.U.]

10-1 10-2 10-3

10-6 10-7

10-4

10-8

0

0.94

0

/(2/N )

1

10-6

10-5

10-4 

10-3

Er /v B00

/(2)

Figure 5: Magnetic field strength on the flux-surface (left) and monoenergetic radial transport coefficient D11 as a function of the collisionality and normalized radial electric field (right). The calculations correspond to configurations FTM (top) and DBM (bottom) of Wendelstein 7-X.

the flux-surface takes a few seconds, while it may need up to tens of hours with DKES.

5.2. Fast and accurate calculation at low  and small Er

In this section, we address the neoclassical transport of large aspect ratio stellarators for

small radial electric fields (Er Tb/(a Zbe)). We will assume that the stellarator is close enough to omnigeneity, so that a local equation can be employed. As a consequence, in equation (2), the terms vM,b ·  and vE ·  are not negligible, but the term |J  is [3]. This yields

lb2 dl lb1 |v |

B vM,b + B vE

· gb -

=-

lb2 lb1

dl |v | (vM,b

+ vE) · bFM,b ,

lb2 lb1

dl |v |

Cblin[gb]

=

(32)

This equation models rigorously the transport of optimized large-aspect ratio stellarators

at low
3/2

collisionality  ) and

[5]. Specifically, for smallEr, it describes the superbanana-plateau or  regimes (for 

the 1/ regime (for  and depending

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

17

100 101

Qi(r/a = 0.5) [MW] Qi [MW]

100 ambipolar Er

-10

-5

w/o vM ·  w. vM · 

0

5

10

Er [kV/m]

10-1

w/o vM ·  w. vM · 

0

0.2

0.4

0.6

0.8

1

r/a = s

Figure 6: Neoclassical ion energy flux as a function of the radial electric field at radial position r/a = 0.5 (top left), and as a function of the radial position (top right). Relative change in the ion energy flux caused by the tangential magnetic drift (bottom).

on details 3/2 

of the magnetic field [10]); for / ) and the  regime (

large Er, it describes the 1/ regime (when / ). We note that even though the term

with |J  is small in this limit, retaining it can be useful in order to deal numerically

with very deeply trapped particles [5].

In order to assess the effect of tangential magnetic drift on transport, we compare

two calculations: in the first one, we solve equation (2) with 1 set to zero; in the second one, we solve equation (31). We perform the calculations using as input the experimental

profiles and magnetic configuration (EIM) of a W7-X discharge: #180918041, studied

in detail in [20]. It corresponds to a so-called "high-performance" plasma, in which

the ion turbulence has been reduced and neoclassics provides the main contribution to

ion energy transport in the core region [21]. Figure 6 (top left) shows this neoclassical

Qi as a function of the radial electric field at radial position r/a = 0.5. A well-known qualitative behaviour is observed [22]: the large peak in Qi that appears at Er = 0 when solving equation (31) (or, equivalently, when using DKES) is reduced in height and moves

towards negative values of Er (an opposite effect takes place, not shown in the figure, for the electrons). The difference Qi between the two calculations for a given value of Er is

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

18

thus strongest for small Er. Figure 6 (top right) shows the radial profile of neoclassical Qi for discharge: #180918041. It can be observed that the neoclassical predictions change quantitatively, but not qualitatively, with Qi around 10% at r/a < 0.5 (and negligible for outer positions, where the collisionality is large). The reason is that the ambipolar value of Er is never too small. Furthermore, as indicated by the squares in figure 6 (top left), the small change in the ambipolar radial electric field goes in the direction of making Qi small.
Even if the effect is small, and very likely lies within the precision of the calculations (that come e.g. from the error bars in the measured plasma profiles), it is systematic, and is likely to become larger in other relevant scenarios. In W7-X, the inverse aspect ratio is very small, and therefore very small Er is needed in order for the tangential magnetic drift to become of the size of the E × B drift. This is not the case of the Large Helical Device, see e.g. [22, 5]. And even within the configuration space of W7-X, there is a variety of scenarios. For the high-mirror (KJM) configuration of W7-X, the tangential magnetic drift is relatively larger, specially at higher  due to the diamagnetic effect (the confinement of energetic ions relies precisely on enhancing their precession on the flux-surface). Finally, for any configuration, an accurate description of the particle orbits will be necessary at high enough temperature. In order to quantify this, in figure 6 (bottom) we repeat the calculation of figure 6 (top left) for 8 W7-X discharges selected from [23]. Two trends can be observed: Qi/Qi increases with decreasing niTi-5/2 (i.e. for decreasing weight of collisions with respect to the drifts on the flux-surface) and decreasing e|Er|/(aTi) (a value  1 indicates a radial electric field of standard size). If forthcoming campaigns of W7-X are able to reach ion temperatures of the order of 4 keV, Qi/Qi  1 is a possibility to be considered.

6. Summary
In this work, we have presented a new version of KNOSOS, a powerful low-collisionality neoclassical code that is extremely fast, and at the same time, can calculate physical effects usually neglected: tangential magnetic drift and 1. Thanks to the implementation of new bounce-averaged equations, KNOSOS can now handle any large aspect ratio stellarator magnetic configuration. There is a wide variety of plasma physics problems that it can be applied to. A non exhaustive list includes the analysis of experimental discharges, stellarator optimization and the provision of input (Er, 1 or the neoclassical distribution function gb) for other transport simulations.

Acknowledgments
The work has been partially funded by the Ministerio de Ciencia, Innovacio´n y Universidades of Spain under project PGC2018-095307-B-I00 and FIS2017-88892-P and by the Comunidad de Madrid under projects 2017-T1/AMB-5625 and Y2018/NMT [PROMETEO-CM]. This work has been carried out within the framework of the

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

19

EUROfusion Consortium and has received funding from the Euratom research and training programme 2014-2018 and 2019-2020 under grant agreement No 633053. The views and opinions expressed herein do not necessarily reflect those of the European Commission.

Appendix A. Discussion on the drift-kinetic equation for large aspect ratio stellarators

In this appendix we discuss how equation (31) coincides at low collisionalities and large

aspect ratio with the drift kinetic-equation solved by the code DKES. Let h(, , l, v, , )

be the non-adiabatic component of the deviation of the ion distribution from a

Maxwellian distribution (in this appendix we drop the species index). The function

h is defined in the trapped and passing regions of the phase space; it depends on l (it is

not an orbit-averaged quantity) and  (i.e., it is not even in the parallel velocity). DKES

computes h by solving [11]

B2 B2

vE ·

h

-

 B

Bh

+v

B B

·

h

+

vM

·

FM

= Clin[h] .

(A.1)

Equation (A.1) is typically solved imposing the following regularity conditions in the

derivatives with respect to :

h = 0 at  = 0 and

(A.2)

|v h| <  at points with v = 0 .

(A.3)

Note that equation (A.1), together with the boundary conditions (A.2) and (A.3), do not

completely determine h: one can add an arbitrary function of  and v to h and obtain

another solution of (2) that also satisfies (A.2) and (A.3). This function is typically

unimportant (it does not give radial transport, for example). In equation (A.1), (B2/ B2 )vE is an incompressible approximation to the E × B
drift vE, and this allows DKES to solve the drift-kinetic equation by means of a variational principle. This approximation is correct for 1, except for very large values of radial

electric field, Er T /(a Ze) [19]. For 1, equation (A.1) is equivalent to

vE ·

h -

 B

Bh

+v

B B

·h+vM,b

·FM,b

= Clin[h] .

(A.4)

The orbit averaging of equation (A.4) yields

vE · l

lh -

 B

Bh

+

+vE · 

h -

 B

Bh

+ vM · FM = Clin[h] ,

(A.5)

where we have used that vE ·  = 0/t is constant on the flux-surface, and the orbit average of a function f is defined by equation (10) for trapped particles and by

Bf /v

f=

.

B/v

(A.6)

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

20

for passing particles. The function h can be decomposed into its bounce-average and a component that fluctuates along the orbit

h = h + hf ,

(A.7)

which leads to

(vE · l)f lhf -

 B

l(vE · l)Bh -

 B

(l(vE · l)B)f hf

+vE · 

h -

 B

Bh -

 B

(B)f hf

+vM · FM = Clin[h + hf ] ,

(A.8)

where we have used lh = 0. For large aspect ratio stellarators, it is shown in [9] that the contribution of passing particles to radial transport is small at low collisionality, so equation (A.8) needs to be solved in the trapped region only. Furthermore, several terms in (A.8) are demonstrated to be small in 1, which leads to

vE · 

h -

 B

Bh

+ vM · FM = Clin[h] .

(A.9)

We have thus arrived at equation (A.9), which differs from equation (31) (with h = gb) by terms that are small in 1. Even though equation (A.9) is obtained more naturally from equation (A.4), equation (31) posseses a desirable property: it conserves the second adiabatic invariant J exactly, as discussed in section 3, and not only up to small terms in .

[1] K C Shaing, K Ida, and S A Sabbagh. Neoclassical plasma viscosity and transport processes in non-axisymmetric tori. Nuclear Fusion, 55(12):125001, 2015.
[2] C D Beidler, K Allmaier, M Yu Isaev, S V Kasilov, W Kernbichler, G O Leitold, H Maaßberg, D R Mikkelsen, S Murakami, M Schmidt, D A Spong, V Tribaldos, and A Wakasa. Benchmarking of the mono-energetic transport coefficients. Results from the International Collaboration on Neoclassical Transport in Stellarators (ICNTS). Nuclear Fusion, 51(7):076001, 2011.
[3] I Calvo, F I Parra, J L Velasco, and A Alonso. The effect of tangential drifts on neoclassical transport in stellarators close to omnigeneity. Plasma Physics and Controlled Fusion, 59(5):055014, 2017.
[4] A Dinklage, M Yokoyama, K Tanaka, J L Velasco, D L´opez-Bruna, C D Beidler, S Satake, E Ascas´ibar, J Ar´evalo, J Baldzuhn, Y Feng, D Gates, J Geiger, K Ida, M Jakubowski, A L´opez-Fraguas, H Maassberg, J Miyazawa, T Morisaki, S Murakami, N Pablant, S Kobayashi, R Seki, C Suzuki, Y Suzuki, Yu Turkin, A Wakasa, R Wolf, H Yamada, M Yoshinuma, LHD Exp. Group, TJ-II Team, and W7-AS Team. Inter-machine validation study of neoclassical transport modelling in medium- to high-density stellarator-heliotron plasmas. Nuclear Fusion, 53(6):063022, 2013.
[5] J L Velasco, I Calvo, F I Parra, and J M Garc´ia-Regan~a. Knosos: A fast orbit-averaging neoclassical code for stellarator geometry. Journal of Computational Physics, 418:109512, 2020.
[6] J M Garc´ia-Regan~a, T Estrada, I Calvo, J L Velasco, J A Alonso, D Carralero, R Kleiber, M Landreman, A Moll´en, E S´anchez, C Slaby, TJ-II Team, and W7-X Team. On-surface potential and radial electric field variations in electron root stellarator plasmas. Plasma Physics and Controlled Fusion, 60(10):104002, 2018.

Fast neoclassical simulations for large aspect ratio stellarators with KNOSOS

21

[7] I Calvo, F I Parra, J L Velasco, and J M Garc´ia-Regan~a. Impact of main ion pressure anisotropy on stellarator impurity transport. Nuclear Fusion, 60(1):016035, 2020.
[8] I Calvo, F I Parra, J L Velasco, J A Alonso, and J M Garc´ia-Regan~a. Stellarator impurity flux driven by electric fields tangent to magnetic surfaces. Nuclear Fusion, 58(12):124005, 2018.
[9] V d'Herbemont, F I Parra, I Calvo, and J L Velasco. Finite orbit width effects in large aspect ratio stellarators. In preparation.
[10] I Calvo, J L Velasco, F I Parra, J A Alonso, and J M Garc´ia-Regana. Electrostatic potential variations on stellarator magnetic surfaces in low collisionality regimes. Journal of Plasma Physics, 84(4):905840407, 2018.
[11] S P Hirshman, K C Shaing, W I van Rij, C O Beasley, and E C Crume. Plasma transport coefficients for nonsymmetric toroidal confinement systems. Physics of Fluids, 29(9):2951­2959, 1986.
[12] V V Nemov, S V Kasilov, W Kernbichler, and M F Heyn. Evaluation of 1/ neoclassical transport in stellarators. Physics of Plasmas, 6:4622, 1999.
[13] C D Beidler and W D D'Haeseleer. A general solution of the ripple-averaged kinetic equation (GSRAKE). Plasma Physics and Controlled Fusion, 37(4):463­490, apr 1995.
[14] W Kernbichler, S Kasilov, G Kapper, A Martitsch, V Nemov, C Albert, and M Heyn. Solution of drift kinetic equation in stellarators and tokamaks with broken symmetry using the code NEO-2. Plasma Physics and Controlled Fusion, 58:104001, 2016.
[15] C.D. Beidler et al. Successful reduction of neoclassicalenergy transport in the wendelstein 7-x stellarator. Nature, submitted, 2021.
[16] L P Ku, P R Garabedian, J Lyon, A Turnbull, A Grossman, T K Mau, M Zarnstorff, and ARIES Team. Physics design for aries-cs. Fusion Science and Technology, 54(3):673­693, 2008.
[17] N Pablant, A Langenberg, A Alonso, J Baldzuhn, C D Beidler, S Bozhenkov, R Burhenn, K J Brunner, A Dinklage, G Fuchert, O Ford, D A Gates, J Geiger, M Hirsch, U H¨ofel, Ye O Kazakov, J Knauer, M Krychowiak, H Laqua, M Landreman, S Lazerson, H Maaßberg, O Marchuck, A Mollen, E Pasch, A Pavone, S Satake, T Schr¨oder, H M Smith, J Svensson, P Traverso, Y Turkin, J L Velasco, A von Stechow, F Warmer, G Weir, R C Wolf, and D Zhang and. Investigation of the neoclassical ambipolar electric field in ion-root plasmas on w7-x. Nuclear Fusion, 60(3):036021, feb 2020.
[18] S Satake, M Okamoto an N Nakajima, H Sugama, and M Yokoyama. Non-local simulation of the formation of neoclassical ambipolar electric field in non-axisymmetric configurations. Plasma and Fusion Research, 1:002, 2006.
[19] C D Beidler, M Yu Isaev, S V Kasilov, W Kernbichler, H Maaßberg S Murakami, V V Nemov, D Spong, and V Tribaldos. ICNTS-Impact of Incompressible E× B Flow in Estimating Mono-Energetic Transport Coefficients. In Proceedings of the 16th Int. Stellarator/Heliotron Workshop, Toki, volume NIFS-PROC-69, page P2.O31, 2007.
[20] T Estrada, D Carralero, T Windisch, E S´anchez, J M Garc´ia-Regan~a, J Mart´inez-Fern´andez, A de la Pen~a, and J L Velasco et al. Radial electric field and density fluctuations measured by doppler reflectometry during the post-pellet enhanced confinement phase in w7-x. Nuclear Fusion, 61(4):046008, 2021.
[21] S A Bozhenkov, Y Kazakov, O P Ford, and M N A Beurskens et al. High-performance plasmas after pellet injections in wendelstein 7-x. Nuclear Fusion, 60(6):066011, may 2020.
[22] S Matsuoka, S Satake, R Kanno, and H Sugama. Effects of magnetic drift tangential to magnetic surfaces on neoclassical transport in non-axisymmetric plasmas. Physics of Plasmas, 22(7):072511, 2015.
[23] D Carralero et al. An experimental characterization of core turbulence regimes in wendelstein 7-x. Nuclear Fusion, submitted, 2021.

