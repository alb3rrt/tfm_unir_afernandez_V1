Comprehensive Energy Footprint Benchmarking of Strong Parallel Electrified Powertrain
Aashrith Vishwanath1, Hamza Anwar2,, Apurva Chunodkar3, Qadeer Ahmed4
Center for Automotive Research, The Ohio State University 930 Kinnear Road, Columbus, OH, USA 43212

arXiv:2106.00243v2 [eess.SY] 2 Jun 2021

Abstract
In this paper we present a benchmark solution with higher number of continuous and discrete states and control levers using validated powertrain component models, where DP fails due to exponential rise in the computation time. The problem involves 13 states and 4 control levers, with complex interactions between multiple subsystems. Some of these variables are discrete while some are continuous. Some have slow dynamics while some have fast dynamics. A novel three step PS3 algorithm [1] which is presented in our prequel paper is used to obtain a near-optimal solution. PS3 algorithm makes use of pseudo spectral method for accurate state estimations. We present three scenarios where only fuel is minimized, only emissions are minimized and, lastly a combination of both fuel and emissions are minimized. All three cases are analyzed for their performance and computation time. The optimal compromise between fuel consumption and emissions are analyzed using a Pareto-front study. This large-scale powertrain optimization problem is solved for a P2 parallel hybrid architecture on a class 6 pick-up & delivery truck.
Keywords: powertrain energy optimization, pseudo spectral method, large-scale dynamic optimization

1. Introduction
In today's world, global warming has grown to become a huge threat. According to the United States Environmental Protection Agency, in the US, 28%

Corresponding Author
Email addresses: vishwanath.16@osu.edu (Aashrith Vishwanath), anwar.24@osu.edu
(Hamza Anwar), apurva.chunodkar@cummins.com (Apurva Chunodkar), ahmed.358@osu.edu
(Qadeer Ahmed) 1MS Student in Electrical Engineering at the Ohio State University 2PhD Student in Electrical Engineering at the Ohio State University 3Sr. Tech. Specialist ­ Powertrain & Electrification Systems & Controls, Advanced System
Performance, Cummins Inc. 4Research Associate Professor, Mechanical & Aerospace Engineering at the Ohio State
University

Preprint submitted to Control Engineering Practice

June 3, 2021

of global warming is due to greenhouse gas emissions from transportation alone. With this being a growing threat to the humankind, we see the need for alternate methods of energy. Hybrid electric vehicles(HEV) is a very good candidate in this case because we notice a 20-40% reduction in greenhouse gases while using HEVs as opposed to their conventional counterparts. However, energy management strategies for HEVs is a growing research area. Due to complex formulations and intricate interactions between subsystems large-scale optimization problems are generally not solved. In this paper, we present a large 13 state 4 control problem with complex interactions between different subsystems for multiple cost function scenarios. The 13 state 4 control problem consists of some fast dynamics eg: SOC, some slow dynamics eg: Battery Temperature and After-Treatment Temperatures, some discrete dynamics eg: gears and engine on/off and some continuous dynamics eg: acceleration, all of which are solved together using the PS3 approach as discussed in prequel paper [1]. The PS3 algorithm is a direct method which uses pseudo spectral collocation(PSC) for highly accurate modelling. This problem is implemented on MATLAB using the open-source modelling language called CasADi[2]. It is parsed as a nonlinear program(NLP) using a parser called YOP[3]. IPOPT[4] solver is used to solve this case-study problem in tandem with HSL MA97[5] linear solver. As previously established in the prequel paper, this problem cannot be solved using the well-known Dynamic Programming(DP)[6]. Formulations imposing discontinuities, the use of maps, interpolations, and lookup tables in the problem makes it very challenging for the solver to optimize. In addition to this complexity, We model dynamic constraints like battery charge sustaining and eco-driving meeting the total distance. We also model combinatorial constraints like dwell-time constraints on engine switch and gear shift. Since we minimize fuel and emissions, we model the after-treatment system along with the other powertrain components. In section 2, we discuss the problem in detail. The states and control variables used, the cost functions that are experimented and their formulation in the subsection 2.1. We then introduce the continuous state and control variables, the state dynamic equations, and other algebraic relations model-wise in subsection 2.2. We then introduce the discrete controls, states and state dynamics and their algebraic relations in subsection 2.3. In section 3 we discuss about the detailed step-wise implementation of the problem. In section 4 we discuss some observations with results obtained for this experiment in detail. The subsection 4.6 consists of a detailed study of a particular maneuver and a Pareto front study for the case-study problem.
2. Problem description & formulation
2.1. Problem overview For this Case-study problem, we consider a strong P2 parallel hybrid ar-
chitecture. The application is a class-6 pick-up & delivery truck. The block
2

SON Ox

TPreDOC/Pre-DOC temp.,

TDOC/DOC temp., TDPF/DPF temp.,

(Coulumbic Efficiency) (Load)

vorg

TSCR/SCR temp. After-Treatment

/SOC, Tb/temp. Electric Battery Accessories

(Inertial Force,

m exh Ttot EON Ox
mf /fuel Engine

µ/torquesplit
m



Traction

e Motor

 total

a/acceleration

Aerodynamic Drag,

(Gearbox

Rolling Resistance,

Efficiency)

Gradient Force)

Transmission v

d/distance, v/speed

& Differential Fv

Vehicle Dynamics (Eco-Driving )

e/Engine on/off Switch (Inertial Drag,

(Inertial Drag,

Drive Efficiency)

Rubbing Friction,

Combustion Efficiency)

g/gearnumber

State Variable

Drive Cycle

Control Lever

Energy Flow

Figure 1: Block diagram of the problem. Diagonal arrows indicate energy losses.

diagram in Fig. 1 shows the various sub-components, states, controls and other signals that we consider. There are 13 states and 4 control variables. The state variables and control variables with their symbols are given in the table below: These variables are optimized across the three steps[1]. The variables that are

STATES(13) SOC speed
Gear number (D) Engine on/off (D) Gear dwell time counter (D) Engine on/off dwell time
counter (D) Distance
Fuel consumption Battery Temperature Pre-DOC Temperature
DOC Temperature DPF Temperature SCR Temperature

SYMBOL  v g e g
e d mf Tb TPreDOC TDOC TDPF TSCR

CONTROL(4) torque split acceleration
gear shift command (D) engine switch (D)

SYMBOL µ a
gcmd ecmd

Table 1: All the states and control variables with their symbols.

labelled `(D)' are discrete variables, and the others are continuous variables. The state dynamics and the algebraic constraints/relations pertinent to these variables are given in section 2.3 and section 2.2 respectively. The cost function for this optimization problem is divided into three cases, this is given in the table below with the formulation for the same. Table 2 illustrates the cost

3

Name Fuel problem Fuel & Emissions problem Emissions problem

Cost Function
T
m f dt
0 T
m f + (1 - )Se dt
0 T
Se dt
0

Table 2: Cost function formulations problem-wise.

functions used for the problems solved. Fuel problem minimizes only the fuel consumption. Emissions problem minimizes only SONOx emissions denoted as `Se'. Fuel & Emissions problem optimizes minimizes a combination of Fuel consumption and Emissions. The objectives are normalized individually first and then weighted by a factor  which is chosen to be 0.43 for this problem. We present a discussion on different values of  in section 4.7. All these optimization problems are done across three steps which are discussed in detail in section 3.
2.2. Continuous States & Controls
All the continuous states, with their respective models, state dynamic equations, and algebraic equations/ constraints pertaining to them are listed and explained in this section. The maps and look-up tables that are used in every model to define the problem are also discussed below.

2.2.1. Battery Model
An 11 kWh NMC/ Graphite based battery pack of 350 V nominal voltage with 90 cells in series and 6 branches in parallel is used. There are two state variables, battery state-of-charge (SOC)  and battery temperature Tb related to the battery model. SOC is a dimension less quantity between 0 and 1. Charge sustaining operation is assumed for the drive cycle, and so the initial condition and final condition for SOC is set equal to 0.55. For the electrical dynamics, we assume a zero-th order equivalent circuit model, and for the thermal dynamics, a first order temperature model with heat addition due to ohmic losses is used. These dynamics are expressed in the following two differential equations:







=

-

Ib Qnom

;

Ib

=

-b

Voc  2R0

-

Voc 2R0

2

-

Pb R0



,

(1)

Tb

=

-

1 mbcb

hbAb (Tb - Tambient) + Ib2R0

(2)

The maximum and minimum current limits Ib,max and Ib,min are given as a function of the battery temperature Tb. We use a spline interpolation for battery

4

temperature dependence of battery current limit to retain smoothness. This is given in Fig. 2.

Ib,min(Tb)  Ib  Ib,max(Tb)

(3)

where, the constants are as follows: Qnom is the battery capacity (31 Ah), b is Coulumbic efficiency (90% for charging, 100% for discharging), hb is heat transfer co-efficient due to convection with ambient temperature (assumed constant), Ab is outer battery pack surface area, mb is battery pack mass, cb is battery pack specific heat capacity, and Tambient is ambient temperature (25C). The equivalent circuit model internal resistance, R0 is assumed to be a function of SOC, ; and the Voc() is the open-circuit voltage which is SOC-dependent. These dynamics are essentially driven by the battery power, Pb which is as follows:
Pb = Pm + Paux,
where Pm is the mechanical power delivered to/from the electric machine and Paux is the constant accessories load on the battery pack. Other box constraints are defined as,

0.3    0.8,

(4)

0  Tb  ,

(5)

In Fig. 2 we show the internal resistance of a battery cell as a function of SOC, the open-circuit-voltage form with respect to SOC. The charge sustaining

Cell Resistance [ohm] Charging/Discharging Current Limit [A]
Cell OCV [V]

5 10-3

4.5

4

3.5

3

0.1

0.2

0.3

0.4

0.5

0.6

0.7

0.8

0.9

1

SOC

300

380

370

360

350

340

330

320

310

0.1

0.2

0.3

0.4

0.5

0.6

0.7

0.8

0.9

1

SOC

250

200

150 5

10

15

20

25

30

35

40

45

Battery Temperature [c]

Figure 2: Resistance(Top-left), open-circuit voltage(Top-right), temperature dependant current limit(Bottom)

constraint is applied on SOC, this means that the initial and the final charge over the complete drive cycle has to be the same. If `T' is the final time the charge sustaining constraint is formulated as:

0 = T = 0.55,

(6)

5

2.2.2. Vehicle Dynamics and Drive line
In vehicle dynamics block, there are two state variables, speed v and distance d, and one control variable acceleration a. Time-varying input to the vehicle dynamics (eco-driving) block is a reference drive cycle, vorg(t) that the ecodriving vehicle needs to follow within certain bounds while satisfying stop-atstop constraint and same-total-distance constraint. The stop-at-stop constraint is that whenever the reference vehicle is stopped, vorg(t) = 0, the eco-driven vehicle is to be forced stopped as well v(t) = 0. This path constraint essentially captures occurrences of road stop signs and red-traffic lights. It is formulated as:

|vorg(t) - v(t)|  5

(7)

The same-total-distance constraint refers to the boundary value constraint on the state variable distance, d that the total distance covered by eco-driven vehicle must be the same as that covered through reference drive cycle. This is given as a boundary constraint,

dT = dorg,T ,

(8)

where, dorg,T is the total distance travelled by the reference vehicle. Connected to the vehicle dynamics block is the differential and transmission block, for which the input is a gear profile g. Longitudinal vehicle dynamics and pointmass wheel model is used for simplicity. We assume road loads of aerodynamic drag, rolling resistance, inertial drag and gradient forces acting against the supplied power by the propulsion system. Hence, the following kinematic and dynamic equations are part of these blocks:

v = a,

(9)

d = v,

(10)

Algebraic :

 Fv

=

Mva

+

cd

       

= gv , rv
:=  =

ga ,

aAf 2

v2

+

Mvgacr

cos(org )

+

Mvga

sin(org),

g   

=

g

Fvrrvv gsign(Fv

)

,







 total

=



g + e,drag +  (Ie + Im) g + Im

if e = 1, if e = 0

where, Fv is total traction force at wheels. org is the road-grade which is displayed below. g is the gear ratio for gear number g. g is the driveshaft torque after the transmission, e,drag is the motoring torque of the engine i.e. rubbing friction and total is the total torque that the combination of motor and

6

engine needs to provide. Some assumptions here are whenever the vehicle is stopped, v = 0, the demand torque total is set to take value zero. The demand torque is given by the above mentioned equations for e = 0 case and e = 1 case separately when v = 0. Other constants are given in the table:

Mv

Vehicle mass

cd Aerodynamic drag coefficient

a

Air density

Af

Frontal area

ga Gravitational acceleration

cr

Wheel rolling resistance

rv

Wheel radius

g

Gearbox efficiency

Ie

Engine inertia

Im

Electric machine inertia

Table 3: Vehicle Parameters with their symbols.

Finally, some box constraints on the state and control variables are:

-2  a  1.5,

(11)

0  v  25,

(12)

The reference speed profile vorg and the elevation profile org used in the problem is given in Fig. 3

Velocity [mph] Elevation profile [degrees]

50

40

30

20

10

0

0

200

400

600

800

1000

1200

Time [s]

3

2

1

0

-1

-2

-3

0

200

400

600

800

1000

1200

Time [s]

Figure 3: Reference speed profile(left), elevation profile(right)

2.2.3. Electric machine and Engine model A 90 kW electric machine (EM) with maximum shaft speed of 3000 rpm
is used and a 220hp diesel internal combustion engine (ICE) is used with a red line of 2600rpm. The efficiency of mechanical-to-electrical (or electrical-tomechanical) conversions is denoted by m(, m) which is given as a 2-D look-up table of the EM operating points: shaft speed  and EM torque m. Similarly, internal combustion engine map for fuel consumption m f , the exhaust flow rate m exh, the turbine-out temperature Ttot, and the engine-out NOx EON Ox are also given as 2-D look-up tables of shaft speed  and engine torque e. These
7

maps are depicted in Fig. 4.

m f = F (, e),

(13)

m exh = M(, e),

(14)

TTOT = T (, e),

(15)

me = N (, e).

(16)

The time-varying signals related to these subsystems are governed by algebraic relationships or through look-up tables. The torque split control variable, µ,
relates the engine, e and EM, m torques to the demand torque after transmission, total. Similarly, the mechanical power delivered to/from electric machine, Pm algebraically relates with electric machine (EM) torque through efficiency term, m(, m). Note that engine drag is accounted for by adding it in the demand torque expression total as explained in section 2.2.2. Through experimentation with the solver, we learnt that making mf a state variable aids in convergence. These algebraic relationships for both traction and braking phases are summarized as follows:

T raction :


e =        

(1 - µ) total 0

if  > idle if   idle

m =   

µtotal total













Pm

=

m m

if  > idle if   idle

Braking :

 e = 0 
m = max{total, m,min} Pm = mm

When the vehicle is braking, i.e. total < 0, we assume that EM operates at maximum recuperation energy to charge the battery which is illustrated as max{total, m,min}.
As for some inequalities, the engine and EM torques are limited at their minimum and maximum curves, which are given by shaft-speed dependent 1-D look-up tables (shown as black curves in Fig. 4). The shaft-speed is constrained by the maximum engine speed at redline:

0    max,

e,min  e  e,max if e = 1,

e = 0

if e = 0,

m,min  m  m,max.

(17) (18) (19)

µ does not affect the e and m in the following cases:

8

· Engine is off. e = 0
· Driveshaft speed below engine Idle.   idle · Braking phase. total < 0 For these cases we assume it to be equal to 1. This is because during these cases, the engine torque e = 0.

2.2.4. After-treatment Model
The after-treatment system consists of the Diesel Oxidation Catalyst (DOC), Diesel Particulate Filters (DPF), and selective Catalytic Reduction (SCR). The states associated with the after-treatment system are Pre-DOC temperature, DOC temperature, DPF temperature and SCR temperature respectively. The initial conditions for all the four states are considered to be the ambient temperature (25C). The ambient losses are assumed to be only due to convection and radiation. The state dynamic equations are given by:

TPreDOC = 0.042m exh(TTOT - TPreDOC)

Qin,(·) = cp,airm exh(Tprev. stage - T(·))

Qconv.loss,(·) = h(·)A(·)(Tamb - T(·))

Qrad.loss,(·) = (·)A(·)(Ta4mb - T(4·))

T·

=

Qin,(·) + Qconv.loss,(·) + Qrad.loss,(·) m(·)cp,(·)

(20) (21) (22) (23)
(24)

Here, (·)  {DOC, DPF, SCR} respectively. TP rev.stage is the temperature of the previous stage, i.e., if (·) = DOC, then the TPrev.stage is the temperature of Pre-DOC TPreDOC. Similarly, if (·) = DPF then TPrev.stage is the temperature of DOC TDOC and if (·) = SCR then TPrev.stage is the temperature of DPF TDPF. Qin is the energy entering the catalyst, Qconv.loss is the ambient losses of the catalyst due to convection, and Qrad.loss is the loss due to radiation. The exhaust

flow rate m exh, turbine out temperature TTOT, and the engine out NOx are 2-D LUTs of engine torque e and driveshaft speed g when the driveshaft speed is above engine idle, otherwise exhaust flow rate is 0.05752 kg/s, the turbine

out temperature is 90C and the engine out NOx is 8.4 mg. The specific heat of the SCR is a 1-D LUT of the SCR temperature. The heat transfer co-

efficient of DOC, DPF and SCR is a function of air speed which is equal to the

vehicle speed, air temperature which is equal to constant ambient temperature

(25C), respective catalyst lengths and lastly their external heating factors. The

conversion efficiencies of NO and NO2 are 2-D LUTs of SCR temperature and exhaust flow rate. We assume here that the density of gases is equal to density

of air. The system-out NOx denoted as `Se' is the product of engine-out NOx and the conversion efficiencies. The ratio of number of molecules for Nitrogen

Oxides

is

assumed

to

be

equal

(

NO NO2

=

1).

The fig.

shows the normalized

conversion efficiency maps used for both NO and NO2 .

9

Engine Torque [Nm] EM Torque [-]

1 0.858

Normalized Engine BSFC Map

BSFC Map

Max Torque

0.90

0.80

0.72 0.715
0.64

0.572

0.56

0.48
0.429 0.40

0.32 0.286
0.24

0.143

0.16

0

0.1

0.2

0.3

0.4

0.5

0.6

0.7

0.8

0.9

Engine Speed [RPM]

0.08 1

1 0.68 0.34
0 -0.34 -0.68
-1 0

Normalized Motor Efficiency Map

Efficiency Map Limit Torque
0.9

0.7

0.5

0.3

0.1

0.2

0.4

0.6

0.8

1

EM Speed [-]

Engine Torque [-] Engine Torque [-]

Normalized Turbine-out Temp. Map

1

1

TOT Map

Max Torque

1

0.85

0.85 0.89

0.71

0.78

0.71

Normalized Exh. Flow Map

Exh. Flow Map Max Torque

1

0.83

0.57

0.42

0.28

0.14

0

0.11

0.22

0.33

0.45

0.56

0.67

0.78

0.89

1

Engine Speed [-]

0.67 0.57
0.56 0.42
0.45 0.28
0.33
0.14 0.22

0.11

0

0.1

0.2

0.3

0.4

0.5

0.6

0.7

0.8

0.9

Engine Speed [-]

0.66 0.5 0.33 0.16 1

Normalized Engine-Out NOx Map

1

EONOx map

Max Torque

1

0.85 0.87

0.71

0.75

Engine Torque [-]

0.62 0.57
0.5 0.42
0.37 0.28
0.25
0.14 0.12

0

0.1

0.2

0.3

0.4

0.5

0.6

0.7

0.8

0.9

1

Engine Speed [-]

Figure 4: 2-D Maps for Brake-specific Fuel Consumption(Top-left), Electric Machine(Topright), Turbine-out Temperature(Centre-right), Exhaust Flow Rate (Centre-left), Engine-out NOx (Bottom).

10

SCR Temperature [-] SCR Temperature [-]

0.90

1

0.90 1

0.90

0.81 0.90

0.81

0.81

0.72

0.81

0.72

0.72

0.63

0.72

0.63

0.63

0.63

0.54

0.54

0.54

0.54

0.45

0.45 0.45

0.45

0.36

0.36

0.36

0.36

0.27

0.27

0.27

0.27

0.18

0.18

0.18

0.18

0.09

0.09

0.09

0.34

0.68

1

0.34

0.68

0.09 1

Exhaust Flow Rate [-]

Exhaust Flow Rate [-]

Figure 5: 2-D Maps of NOx conversion efficiencies NO(left) NO2 (right)

2.3. Discrete States & Controls
In this section all the discrete states and controls are listed and their state dynamics and other constraints on the same are discussed in detail in section 3.2.

2.3.1. Gears & Gear dwell time dynamics The result obtained from step-1 is relaxed. Here, g  [1, 6]. This is formu-
lated as a box constraint given by:

1g6

(25)

In step-2, the solver Gurobi is used to optimize the relaxed solution in step1 and convert it into a discrete solution. Now the gear can take values, g  {1, 2, 3, 4, 5, 6}. The complete problem formulation is discussed in detail in section 3. The discrete-time variables and the state dynamics for the same is given by difference equations. A counter variable g is formulated to take note of the time between two consecutive gear shifts. The state variable gear status shifts only when the counter variable meets the dwell time. The dwell time used on gears is 3s. The discrete-time dynamics for gears and gear dwell time counter is formulated as following with k as the time step:

1  g(k + 1) - g(k) = 0
-(dwelltime + 1)

if g(k)  dwelltime,

otherwise,

(26)

if g(k + 1) - g(k) = gcmd

g(k + 1) - g(k) = gcmd if g(k) > dwelltime

(27)

0

otherwise

2.3.2. Engine on/off & Engine on/off dwell time dynamics
A similar formulation is made for engine on/off variable, a relaxed solution of which is obtained from step-1 where e  [0, 1] which is given as box constraint

11

given by:

0e1

(28)

This is then optimized to obtain an integer solution in step-2 where e  {0, 1}. A separate counter variable is assigned to monitor the dwell time of the engine status. The dwell time on engine status is set to 2s. The formulation of discretetime dynamics for engine status and engine start-stop counter is as follows:

1  e(k + 1) - e(k) = 0
-(dwelltime + 1)

if e(k)  dwelltime,

otherwise,

(29)

if e(k + 1) - e(k) = ecmd

e(k + 1) - e(k) = ecmd if e(k) > dwelltime

(30)

0

otherwise

3. Implementation details

The optimal control problem with 13 states and 4 controls is solved using PS3 method [1]. As mentioned in the prequel paper, the consistent variables are vehicle speed, acceleration and distance. The other state and control variables are considered as inconsistent variables. The step-1 involves 9 state and 4 control variables. Step-2 involves 4 state and 2 control variables. Step-3 involves 7 state variables and 1 control variable. All the above mentioned steps are solved in succession to obtain the final solution. Overall objective function that is minimized in our case-study problem is given by:

T

J := m f + (1 - )Sedt

(31)

0

where, T denotes the total time, m f the rate of fuel consumption, and Se the SONOx emissions. The cost is minimized for different values of . We have considered three cases of  for numerical results. In the first case,  = 1, only
the fuel consumption is minimized. In the second case,  = 0, where only emissions are minimized. In the third case,   (0, 1), where a conflicting cost
function consisting of a combination of both fuel consumption and emissions is minimized. In this case the terms, m f and Se, are individually normalized at first for numerical reasons.

3.1. STEP-1 - Solving Relaxed version of the NLP
The NLP which is solved in this step has 9 states which are , v, d, mf , Tb, TPreDOC, TDOC, TDPF, and TSCR. The 4 control variables are µ, g~, a, and e~. The three consistent variables are v, d and a. For simplicity in formulation, the continuous time optimal control problem (OCP) for the given NLP solved in step-1 is given below. This is because discretization is done using the PSC scheme and the NLP used has the states, cost function and the constraints

12

being evaluated at each collocation point as mentioned in [1]. Some of the path constraints used in this step were modified to accommodate the relaxed nature of the control levers gears and engine switch. For example the path constraint limiting the engine torque was formulated as follows:

e e,min  e  e e,max

(32)

The cost function, box, path and boundary constraints are given as follows:
· The cost function used is given by (31) where the states are controls are optimized.

· The ordinary differential equations for each state variable used here are outlined in section 2. This is given by (1), (2), (9), (10), (20) & (24).
· The box constraints are given by equations (4), (5), (11), (12), (25) & (28).
· The path constraints are given by (3), (7), (17), (19) & (32).
· The boundary constraints are given by (6) & (8).
· Apart from these constraints, initial and final conditions on states, controls and other signals are also specified.
A simple initial guess based on apriori information about the control variables was used. To avoid numerical difficulty for the interior point algorithm in IPOPT, the constraint bounds were relaxed by a factor of 10-4. The polynomial degree for collocation points was set to 5, to take full advantage of radau collocation for handling stiffness in the problem. The control interval was set to 1 second. The linear solver with IPOPT used was HSL MA97 [5].

3.2. STEP-2 - Solving Integer states and controls
Once step-1 is solved, we obtain the optimal trajectories of consistent variables, (v, d, a), and the trajectories of the relaxed discrete variables (g~, e~). Step2 of the PS3 algorithm is about finding the optimal integer trajectories (g, e) from the relaxed solutions that satisfies combinatorial constraints, and it requires solving a mixed-integer quadratic program. To solve for the two discrete variables of our problem, gear number and engine on/off state, we use a formulation of MIQP similar to the one described in the prequel paper's gear example. In particular, we make use of the vectorized forms of relaxed and binary-equivalent gear number trajectories. The binary gear trajectory is denoted using bj(k)  {0, 1} which will take value 0 if j-th gear at time k is inactive, and value 1 if it is active. Similarly, the relaxed gear trajectory is denoted using rj (k)  [0, 1].
Before the MIQP is defined, we start off from the optimal trajectories of consistent variables, v and a to arrive at all possible shaft speed and shaft angular acceleration values for the 6 gears at every time step. Naturally, not all

13

gears will always be feasible in the complete drive cycle due to violation of the maximum shaft speed constraint. Another reason for infeasibility of a gear at a given time is when the corresponding maximum torque constraint is violated. However, the torque constraints are dependent on the engine switch as given in section 2.2.3. Nonetheless, as stated below we arrive at two gear-feasibility binary matrices B0 (used when e = 0) and B1 (used when e = 1), each of size N (length of drive cycle) by 6. For the k-th time step (out of N steps), and j-th gear number,

B0,j (k) :=

1 0

if total,j (k)  m,max,j(k)  j (k)  max if total,j (k) > m,max,j(k)  j (k)  max

(33)

B1,j (k) :=

1 0

if total,j (k)  (e,max,j (k) + m,max,j(k))  j (k)  max if total,j (k) > (e,max,j (k) + m,max,j(k))  j (k)  max

(34)

where, the subscript j and paranthesized k indicates dependence on the gear choice and time step, respectively. Once the two gear-feasibility matrices are determined, we formulate and solve the mixed-integer quadratic program given below:





N

6

min
e(k),bj (k)

(e(k) - e~(k))2 +

k=1

j=1

bj(k) - rj (k)

2


s.t. One-Gear-At-A-Time Constraint k :

6
1 = bj(k)
j=1
Feasible Gear Selection Constraint k j :

0  bj(k) 

B0,j (k) B1,j (k)

if e(k) = 0 if e(k) = 1

Minimum Dwell-Time Constraints k j :

i  {k, k + 1, · · · , k + L} :

bj(k) - bj(k - 1)  bj(i)

bj(k - 1) - bj(k)  1 - bj(i)

ie  {k, k + 1, · · · , k + Le} :

e(k) - e(k - 1)  e(ie)

e(k - 1) - e(k)  1 - e(ie)

where, L = 3 seconds is the minimum dwell-time duration that gear has to remain unchanged before next gear shift, and likewise, Le = 2 seconds is the minimum dwell-time for engine switch.
Notice that the feasible gear selection constraint is an "indicator" constraint because the upper bound imposed on the optimization variable bj(k) is either of

14

the two pre-determined values B0,j(k) or B1,j(k), but the choice is governed by the value of another optimization variable e(k). It is common knowledge in integer programming that indicator constraints can be written as linear inequality constraints. Hence our step-2 problem is a mixed-integer quadratic programming problem as it only has linear constraints on the optimization variables with a quadratic objective function. It is solved using MIQP solver, Gurobi [7], with solution time under 10 seconds for N = 1200.
As a result of solving the above MIQP and converting the binary-equivalent gear form into its integer-valued counterpart, we obtain the optimal discrete trajectories of gear number g(k) and engine state e(k), which can then be used in step-3 to solve for the inconsistent variables. 3.3. STEP-3 - Consistency between continuous and discrete variables
The cost function that is optimized is retained to be the same as the one optimized in section 3.1. The integer gear and engine on/off profiles g and e from section 3.2 with v, a, and org are used as inputs.The states used in this problem are , mf , Tb, TDOC, TDPF and TSCR. The control variable is µ. The cost function, Box, Path and boundary constraints are given as follows:
· The sate dynamics of each of these states are the same as in section 3.1. These are given by (1), (2), (20) & (24).
· The box constraints are given by equations (4) & (5) · The path constraints are given by (3), (17), (19) & (18). · The boundary constraints is given by (6). The initial guess used for this problem is obtained from the state and control trajectories of step-1. The solver options used for this problem were the same as the ones used in step-1 in order to ensure consistency. Since we had a very good initial guess, a warm start option was used additionally.
15

4. Performance Evaluation
In this section, the results that were obtained serve as a benchmark for the real-time controllers that are implemented on actual vehicles. The following sections outlines experiments that are discussed in detail with states, controls and other important signals and their interactions. Computation time for these problems are of the order of 25-30 mins for each problem.

4.1. Overall Fuel Consumption and SONOx Emissions

Fuel Consumption [kg]

1 0.8 0.6 0.4 0.2
0 0
1 0.8 0.6 0.4 0.2
0 0

Fuel Fuel & Emissions Emissions

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

SONOx Emissions [g]

Figure 6: Comparison of Fuel consumption and Emission for the three cases.

Fig. 6 shows the Fuel consumption and the SONOx emissions for the complete time horizon. We can see from Fig. 6 that the fuel consumption is least for the Fuel problem. We can see a 9.1% increase in Fuel consumption from Fuel problem to the Fuel & Emissions problem and a 15% increase in case of the Emissions problem.

16

4.2. Discrete States, Controls and their analysis

Gear Counter

Gear Number

4 3 2 1 0
0
6 5 4 3 2 1
0
3
2
1
0 0
1.5 1
0.5 0
-0.5 0

Fuel Fuel & Emissions Emissions

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

Engine on/off Counter

Engine on/off Status

Figure 7: Gear dwell time counter, Gear profile, engine start-stop counter & Engine on off profile

Gear Shift Command

Engine on/off Switch

2 1 0 -1 -2
0
1 0.5
0 -0.5
-1 0

Fuel Fuel & Emissions Emissions

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

Figure 8: Gear shift command and engine switch

17

Duration (s)

500 450 400 350 300 250 200 150 100
50 0 1

Fuel Fuel & Emissions Emissions

2

3

4

5

6

Gear Number

Figure 9: Engine on/off duration(left) Gear duration(right).

The Fig. 7-9 has all the discrete state, control variables that were optimized in step-2 which is illustrated in section 3.2 with their analysis. We can infer from Fig 7-9 that although the engine off duration is highest for the Fuel & Emissions problem, the main reduction in fuel in case of the Fuel problem is that it is at a higher gear for longer duration compared to the other two problems. This can be seen from the Fig. 9 Gear duration analysis. We can see from the Gear Counter plot and the Engine on/off Counter plot in Fig. 7 that the dwell time for both the integer variables are met.

18

4.3. Battery related states & signals, Torque split, and operating points

SOC

Torque split

0.58 0.56 0.54 0.52
0.5 0
1 0.5
0 -0.5
-1 0
27 26.5
26 25.5
25 0
200 100
0 -100 -200
0

Fuel Fuel & Emissions Emissions

200

400

600

800

Time [s]

1000

1200

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

Batt. Temp. [c]

Batt. Current [A]

Figure 10: SOC, Torque split, Battery Temperature & Battery Current

Engine Torque [Nm]

1 0.85 0.71 0.57 0.42 0.28

Normalized Engine Operating Points

Efficiency Map Max Torque Fuel Fuel & Emissions Emissions

0.90

1

0.83
0.68 0.75

EM Torque [Nm]

0.66 0.34
0.57 0
0.48

0.41 -0.34
0.32

0.24

-0.68

0.14

0.16

-1 0.08

0

0.1

0.2

0.3

0.4

0.5

0.6

0.7

0.8

0.9

1

0

Engine Speed [RPM]

Normalized EM Operating Points

Efficiency Map

Limit Torque

Fuel

Fuel & Emissions

Emissions

0.9

0.7

0.5

0.3

0.1

0.17

0.34

0.51

0.68

0.85

EM Speed [RPM]

Figure 11: Engine operating points(left) Motor operating points(right)

In Fig. 10 for the blue curve, we can see that the the torque split chooses greater negative values for longer duration. This is because when the engine is off for longer duration, the SOC decays faster but since the charge sustaining

19

Engine Torque [N-m]

Demand Torque [N-m]

1 0.75
0.5 0.25
0 0
1 0.5
0 -0.5
-1 0
1 0.5
0 -0.5
-1 0

Fuel Fuel & Emissions Emissions

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

Motor Torque [N-m]

Figure 12: Engine Torque, Demand Torque, Motor Torque
constraint is imposed the engine is charging the battery in these cases to recoup the lost charge. In Fig. 10 We can see that the Battery Temperature profile for the Fuel problem rises sharply. The main reason for this is the rapid charging and discharging of the battery. The SOC profile of the Fuel problem also proves this. From the BSFC map in Fig. 11 we can see that the operating points for the Fuel problem are more at the higher efficiency region. The operating points for the Fuel problem operate at a high torque region which could be the reason for longer negative torque split values. From Fig. 11 by plotting an Iso-power curve, we see that in case of the Fuel problem there are more number of points outside this curve in the high speed and high efficiency region. This can also be inferred from the average motor efficiencies during traction which is calculated and found to be 86.64% for the Emissions problem 87.88% for the Fuel & Emissions problem and 89.61% for the Fuel problem.
4.4. Eco-driving
In Fig. 13 the black plot shows the reference speed profile which is different from the speed profiles for the other problems. The distance for all the problems are the same. This emphasizes the eco-driving that has been modelled. The Energy at wheels for the reference drive cycle is 2.567 KWh, for the Fuel problem is 2.43 KWh, for the Fuel & Emissions problem is 2.467 KWh and, for the Emissions problem it is 2.44 KWh. We can see that the energy for the reference drive cycle is higher than the problems that were optimized thus, emphasizing the phenomenon of Eco-driving. We can see that the distance is almost the

20

Velocity [mph]

Distance [miles]

50

Fuel

40

Fuel & Emissions

30

Emissions

Reference

20

10

0

0

200

400

600

800

1000

1200

Time [s]

6

4

2

0

0

200

400

600

800

1000

1200

Time [s]

4

2

0

-2

-4

-6

0

200

400

600

800

1000

1200

Time [s]

Acceleration [mph/s]

Figure 13: speed, Distance & Acceleration
same for the three problems, because of a hard constraint that the total distance should remain the same.

21

4.5. After-Treatment States and related Parameters

Driveshaft Speed [rad/s]

Exh. Flow Rate [kg/s]

1 0.68 0.34
0 0
1 0.68 0.34
0 0
0.9 0.6 0.3 0.1
0
1
0.5
0 0

Fuel Fuel & Emissions Emissions Engine Idle

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

Turbine-out Temp. [c]

Engine-out NOx [g]

Figure 14: Driveshaft Speed, Exhaust flow rate, Turbine-out Temperature, Engine-out NOx

Fuel problem Fuel & Emissions problem
Emissions problem

Conversion efficiency (%) 89.52 91.18 93.34

Table 4: Average NOx Conversion Efficiencies problem-wise

Average NOx conversion efficiencies across the whole drive cycle is highest for Emissions problem. When we analyze the emissions trend we notice that even though the overall engine out emissions is lower for the fuel problem, we can see that the optimizer is smart in choosing the operating points which take higher conversion efficiency thereby reducing the system out emissions for the Emission problem.

22

Pre-DOC Temp. [c]

DOC Temp. [c]

300 200 100
0 0
300 200 100
0 0
300 200 100
0 0
300
200
100
0 0

Fuel Fuel & Emissions Emissions

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

200

400

600

800

1000

1200

Time [s]

DPF Temp. [c]

SCR Temp. [c]

Figure 15: After-Treatment Temperatures(Pre-DOC, DOC, DPF, SCR)
4.6. Deeper Performance Evaluation For this study we choose a 20s maneuver(220s-240s) from the drive cycle
and analyze the important plots in the same. We can see from Fig. 16 there is a sharp increase in the SONOx emissions for the Fuel problem. This can be due to an increase in EONOx or a reduction in NOx conversion efficiency. We can easily conclude from the EONOx plot that this difference is very small compared to the difference in NOx conversion efficiency. Therefore, this phenomenon can be mainly accounted to the sharp decrease in the NOx conversion efficiency. Although we see a slight increase in the SCR temperature profile of the Fuel problem, this is not causing any decrease in the SONOx emissions because these temperatures despite being different are almost of the same order for all the problems. This increase in SONOx emissions can now be mainly accounted to the sudden increase in the exhaust flow rate. From Fig. 5 we see that for high exhaust flow rate and low SCR temperature the conversion efficiency is lower. This is because of the position of the engine operating points. We can see that the engine torque curve is very high in case of the Fuel problem. This can in turn be accounted to the torque split profile. We can see from Fig. 16 that the engine is charging the battery only in case of the Fuel problem. As we have already discussed in the section 2.3,that this is because the engine is off most of the time to minimize the fuel consumption in this case, but imposing of the SOC charge sustaining constraint forces the torque split to choose these
23

SOC

Exh. Flow Rate [kg/s]

Engine Torque [N-m]

0.545

700

0.4

0.54

600 0.2

Torque split

0.535

Fuel

0

Fuel & Emissions

Emissions

-0.2

500 400

0.53

-0.4

300

0.525

-0.6

200

220

225

230

235

240

220

225

230

235

240

220

225

230

235

240

Time [s]

Time [s]

Time [s]

0.5

4

350

0.4

3

300

0.3

2

250

0.2

1

Engine-out NOx [g]

Turbine-out Temp. [c]

SCR Temp. [c]

0.1

200

220

225

230

235

240

220

225

230

235

240

Time [s]

Time [s]

NOx Conversion Efficiency. [%]

45

1

0.8 40
0.6

0.4 35
0.2

30

220

225

230

235

240

Time [s]

0

220

225

230

235

240

Time [s]

SONOx Emissions [g]

0

220

225

230

235

240

Time [s]

2

1.5

1

0.5

0

220

225

230

235

240

Time [s]

Figure 16: Plot comparison for a 20s maneuver (220s-240s)
negative values in turn increasing the SONOx emissions.
4.7. Pareto-Front Study
We experimented various weighting factors, , between minimizing fuel and minimizing (NOx) emissions for the case-study problem to obtain the best compromise between the two conflicting objectives. Owing to the fact that the algorithm may converge to local minima, the data points have a wide spread of values as shown in Fig. 17. This limitation was mitigated by, firstly, having 33 different experiments, where  ranged from 0 to 1, and all other solver options, initial guess, tolerances and objective scaling, were kept the same. And secondly, fitting a linear least-squares curve to the data (as shown), in order to determine relative proportionality of the two objectives. A value of 0.61 for R2 term shows that the linear fit is a relatively good representation of the data.
We found that the slope of the line is -3.88. Firstly, this tells us that the slope is negative, as expected. In other words, a higher fuel is generally accompanied with lower emissions, and lower fuel with higher emissions. Secondly, it points out that 3.88 units increase in fuel may correspond to 1 unit decrease in emissions. This linear proportionality constant is determined solely for the reason that the two axes can thus be scaled, and then a single pareto-optimal point can be determined which minimizes both the objectives in 2-norm sense as discussed below. Finally, the contours shown in Fig. 17 originate from a reference point (shown as the origin) which was chosen based on the lowest fuel data point ( = 1.00) and the emissions data point ( = 0.00). These contours

24

show the 2-norm distance from the reference. Hence, we observe that the best data point for overall low emissions and fuel is that for the value  = 0.43. Note that for faster computation in this study, we use Radau collocation of degree one. The two extreme data points,  = 1.00 and  = 0.00 are annotated in the figure, and so is the pareto-optimal point  = 0.43 annotated.

1.0 0.9 =1.00 0.8

(Scaled) Euclidean norm

0.9

linear fit, f(x)

data points, [0,1]

reference

0.8

0.7

f(x) = -3.8829*x + 16.2054

0.7

0.6

R2 = 0.60742

0.6

SONOx [-]

0.5

0.5

0.4

0.4

0.3 0.3

0.2

=0.43

0.2

0.1

min ms

=0.00

0.1

min mf 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0 Fuel [-]

Figure 17: Pareto-Front Study showing data points for various values of , a linear regression fit, and Euclidean distance contours from a reference point (all axes are normalized between 1.0 and minimum mf or ms).

5. Conclusion
In this paper, a large 13 state 4 control problem with complex interactions between the powertrain components is solved using a novel 3-step approach. A framwork called CasADi was used to formulate this problem on a MATLAB based environment, and a package called YOP was used to aid with the process of formulating the problem on CasADi. Non-linear programming (NLP) solver IPOPT was used to solve the problem in conjunction with the HSL linear solver MA97. A result was obtained for three cases: Fuel optimization problem, where the cost function was just minimizing fuel consumption. Emissions optimization problem, where the cost function was just minimizing the Emissions. Lastly, the Fuel & Emissions joint optimization problem, where a complex conflicting
25

cost function was used to minimize the combination of both fuel consumption and emissions using a Pareto-based study. We can observe from the result that the Fuel & Emissions joint optimization problem with  = 0.43 gives a fairly good result. The fuel consumption is in between the Fuel optimization problem and Emissions optimization problem, with not that big a compromise on the SONOx emissions. The emissions in this problem is very close to the Emissions optimization problem.
References [1] A. Vishwanath, H. Anwar, A. Chunodkar, Q. Ahmed, Comprehensive en-
ergy footprint benchmarking algorithm for electrified powertrains, Preprint submitted to IEEE Transactions on Control Systems Technology (2021). [2] J. A. E. Andersson, J. Gillis, G. Horn, J. B. Rawlings, M. Diehl, CasADi ­ A software framework for nonlinear optimization and optimal control, Mathematical Programming Computation 11 (1) (2019) 1­36. doi:10.1007/s12532018-0139-4. [3] V. Leek, An optimal control toolbox for matlab based on casadi, https://www.yoptimization.com/ (2016). [4] E. D. Andersen, K. D. Andersen, The mosek interior point optimizer for linear programming: an implementation of the homogeneous algorithm, in: High performance optimization, Springer, 2000, pp. 197­232. [5] HSL, A collection of fortran codes for large-scale scientific computation, http://www.hsl.rl.ac.uk/ (2007). [6] O. Sundstrom, L. Guzzella, A generic dynamic programming matlab function, in: 2009 IEEE control applications,(CCA) & intelligent control,(ISIC), IEEE, 2009, pp. 1625­1630. [7] L. Gurobi Optimization, Gurobi optimizer reference manual, http://www.gurobi.com/ (2021).
26

