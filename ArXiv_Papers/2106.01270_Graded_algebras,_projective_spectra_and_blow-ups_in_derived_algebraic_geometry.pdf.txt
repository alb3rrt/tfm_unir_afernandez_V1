arXiv:2106.01270v1 [math.AG] 2 Jun 2021

GRADED ALGEBRAS, PROJECTIVE SPECTRA AND BLOW-UPS IN DERIVED ALGEBRAIC GEOMETRY
JEROEN HEKKING
Abstract. We define graded, quasi-coherent OS-algebras over a given base derived scheme S, and show that these are equivalent to derived Gm,S-schemes which are affine over S. We then use this Gm,S-action to define the projective spectrum Proj B of a graded algebra B as a quotient stack, show that Proj B is representable by a derived scheme over S, and describe the functor of points of Proj B in terms of line bundles. The theory of graded algebras and projective spectra is then used to define the blow-up of a closed immersion of derived schemes. Our construction will coincide with the existing one for the quasi-smooth case. The construction is done by generalizing the extended Rees algebra to the derived setting, using Weil restrictions. We close by also generalizing the deformation to the normal cone to the derived setting.

Contents

1. Introduction

1

2. M -graded algebras

8

3. Equivariant geometry

17

4. Graded algebras and Gm-actions

20

5. Projective spectra

26

6. The Rees algebra of a closed immersion

33

7. Blow-ups

43

Appendix A. M -graded R-algebras as product-preserving presheaves

51

Appendix B. Cell attachments and finiteness conditions

52

References

58

1. Introduction
Blow-ups are ubiquitous in algebraic geometry. One constructs the blow-up of a closed immersion f : Z  X by taking the projective spectrum of the Rees algebra associated to f . Here are thus two very basic tools of algebraic geometry that go into this construction: quasi-coherent, graded algebras and projective spectra of these algebras.
Recently, the blow-up BlZ X of a derived scheme X in a centre Z has been constructed in [KR18] in the case that Z  X is quasi-smooth, which is the derived analogue of a regular embedding. The strategy used is to describe the functor of points of BlZ X and then to show that it is representable, thus circumventing the need to consider graded algebras or projective spectra.
The goal of this article is to define the blow-up of a closed immersion Z  X of derived schemes in the general case by means of the projective spectrum of the associated Rees algebra. Since, perhaps surprisingly, graded algebras and projective spectra were not available in the derived setting at the time of this writing, an
Date: June 3, 2021.
1

intermediate goal is to first develop these concepts, which are also interesting in their own right. A large part of the work has gone into understanding derived graded algebras, about which we will first say a few words.
1.1. Graded algebras. Classically, for a scheme S, the following categories are, possibly contravariantly, equivalent:
(1) Z-graded, quasi-coherent OS-algebras, (2) Schemes affine over S with a Gm,S-action, (3) OS[t±1]-comodules in the symmetric monoidal category of quasi-coherent
OS -algebras, (4) Quasi-coherent OBGm,S -algebras, (5) Commutative monoids in the symmetric monoidal category QCohZ(S) of
Z-graded, quasi-coherent OS-modules, (6) Lax symmetric monoidal functors Z  QCoh(S).
The equivalences between (1),(2),(3) are either done by hand, or using the Barr­ Beck theorem. For (2)  (4), one uses that T  BGm,S is affine if and only if the pullback P  S along S  BGm,S is as well. Finally, (5) and (6) are equivalent, as shown by hand or by using Day convolution, and both are easily seen to be equivalent to (1).
This list induces six equivalent kinds of input for the Proj-construction, by taking N-graded objects in (1) and their counterparts in the other categories. Therefore, in generalizing the Proj-construction to the derived setting, one is now faced with the question which of these inputs to take as the starting position.
The derived versions of (2),(3) and (4) turn out to be equivalent to one another, as we shall see. In setting up the theory of Z-graded, quasi-coherent OS-algebras in the context of derived algebraic geometry, it is reasonable to ask that the result is also equivalent to the derived version of (2). Indeed, suppose that S is affine, say S = Spec A. Then a simplicial A-algebra with a levelwise A[t±1]-coaction gives rise to a simplicial graded A-algebra, by applying the classical construction levelwise.
We have therefore taken the equivalence between (1) and (2) as design criterion in generalizing (1) to the derived setting. And indeed, the first main result of this paper is the following:
Theorem 4.6.2. Let S be a derived scheme. Then there is a contravariant equivalence between the category of quasi-coherent, Z-graded OS-algebras and the category of Gm,S-schemes affine over S.
Although the derived versions of (5) and (6) are also equivalent to one another, we show that in general these are not equivalent to the derived versions of (1)­(4).
We then use this equivalence to define the projective spectrum of an N-graded, quasi-coherent OS-algebra B generated in degree 1, over a derived scheme S, as the quotient stack [(Spec B V (B+))/Gm,S]. The second main result is then:
Theorem 5.1.3. For S, B as above, Proj B := [(Spec B V (B+))/Gm,S] is representable by a derived scheme over S.
Furthermore, for S, B as above, we recover three results from the classical case. First, we give an exact functor from quasi-coherent, graded B-modules to quasicoherent OProj B-modules. Next, we introduce Serre's twisting sheaves and check familiar behaviour of these sheaves. Third, we show that for a given map of derived schemes  : T  S, the space of maps T  Proj B over S is the space of graded homomorphisms B  M, where M is an N-graded OT -algebra freely generated by a line bundle in degree 1, and B  M is a homomorphism of graded OT algebras for which the induced map 0(B1)  0(M1) is surjective. This recovers OProj B(1) as universal line bundle.
2

1.2. The problem in the derived setting. Let S be a derived scheme. Morally, a Z-graded, quasi-coherent OS-algebra B should be a quasi-coherent OS-algebra B together with a decomposition B  d Bd in QCoh(S) such that the multiplication maps Bn  B induce homotopy-coherent systems Bd1  · · ·  Bdn  Bd1+···+dn .
Writing down this infinite amount of coherency data by hand is not easy. It needs to guarantee that on the one hand the concept is flexible enough so that quasicoherent OS-algebras A with an OS [t±1]-coaction, which are given as homotopy coherent cosimplicial diagrams of the form A  A[t±1] . . . , give rise to Z-graded, quasi-coherent OS-algebras. On the other hand, it needs to be strict enough so that forgetting the grading gives us a quasi-coherent OS-algebra, i.e., locally a simplicial commutative ring and not only an E-ring.
One approach is via model categories. Let C be the category of simplicial objects in the category of Z-graded rings. We could define a model structure on C by declaring a morphism B  B to be a fibration, resp. a weak equivalence, when it is so on the underlying simplicial set. Then for a simplicial commutative ring R, we let the category CR of Z-graded R-algebras be the coslice category CR/, where C is the -category associated to C, and R is endowed with the trivial grading.
A Z-graded OS-algebra B would then locally on S be given by a Z-graded simplicial OS(U )-algebras, for U  S affine open. To define an OS[t±1]-coaction on such a B, we need a morphism B  B[t±1] of OS-algebras which sends Bd to Bdtd. First assume that S = Spec R, and that B is given by a Z-graded simplicial R-algebra B. To give something which is homotopically well-defined, B[t±1] must be the derived tensor product B R R[t±1]. The question is then whether we can compute this derived tensor product and replace B in such a way that B  B[t±1] can be defined by the classical construction levelwise, i.e., by sending a homogeneous simplex b of degree d to btd.
We can answer this last question affirmatively, but only after we have shown Theorem 4.6.2. To use only the model-categorical approach from the start seems to be intractable even in the local picture. What is more, to glue such a construction into an OS [t±1]-coaction on all of B would involve gluing different cofibrant models on affine patches. Making this into an -functor from Z-graded OS-algebras to OS-algebras with OS [t±1]-coaction seems hopeless.
What is therefore needed is a functor, intrinsic to the language of -categories, from the -category Alg of simplicial commutative rings to the -category of categories, sending R  Alg to the -category AlgZR of Z-graded R-algebras. Better yet, this should come with a universal property for colimit-preserving functors out of AlgZR. We will indeed give such a construction. The universal property of AlgZR will allow us to give a functor F from AlgZR to the -category AlgGRm of R-algebras with R[t±1]-coaction. Functoriality of AlgZR in R will allow us to globalize this to any base derived scheme.
The mapping spaces of AlgZR and AlgGRm are too different from one another to show that F is fully faithful by hand. Luckily, it will turn out that the functor F : AlgZR  AlgGRm is a left adjoint for abstract reasons, using the universal property of AlgZR, which will give us a candidate for the inverse of F . This is good, because writing down an inverse functor AlgGRm  AlgZR by hand is again not so easy. Indeed, an object B in AlgGRm is given by a cosimplicial diagram C(B) of the form B  B[t±1] . . . in the -category of R-algebras. If this diagram was a strictly commutative diagram in the 1-category of simplicial commutative rings, then we could apply the classical construction levelwise, to get a grading on B. Unfortunately, standard strictification techniques do not guarantee that C(B) can be strictified, without changing the objects Cn(B) up to homotopy. Indeed, it will
3

be a consequence that one can actually strictify any AlgGRm to a levelwise R[t±1]coaction.
1.3. Rees algebras and blow-ups. Let Z  X be a closed immersion of derived scheme. Since we will define the blow-up BlZ X as the projective spectrum of the Rees algebra RZ/X , the behaviour of BlZ X is thus completely controlled by that of RZ/X . Thus, the question whether our construction of BlZ X is `correct' is reduced to the same question about RZ/X . To this end, let us first consider a universal property of the extended Rees algebra in the classical case.
Let A  B be a surjection of (discrete) rings with kernel I, and RBex/tA the extended Rees algebra nZ Intn  A[t±1], where I-m = A for m  0. Let Q be a Z-graded A[t-1]-algebra for which t-1  Q is not a zero divisor. Here and in what follows, we take deg t-1 = -1. We then have an isomorphism of sets
AlgZA[t-1](RBex/tA, Q) = AlgZA(B, Q/(t-1))
between Z-graded A[t-1]-algebra maps and Z-graded A-algebra maps, natural in Q. Indeed, there is a graded A-algebra map B  Q/(t-1) if and only if the structure map A  Q maps I into (t-1). It thus suffices to show that a map  : RBex/tA  Q of Z-graded A[t-1]-algebras is determined by its restriction to degree 0. And indeed this is so: the composition RBex/tA  Q -×-t--1 (t-1) shows that |It is determined by 0, and similarly for higher degrees.
Let now A  B be a map of simplicial rings, surjective on 0. We will define the derived version of the extended Rees algebra in such a way that it satisfies a somewhat more robust version of this universal property: it will turn out that we have an equivalence of spaces
AlgZA[t-1](RBex/tA, Q) = AlgA(B, (Q/(t-1))0)
for any Z-graded A[t-1]-algebra Q. Observe that Q  (Q/(t-1))0 is easily defined. One could therefore hope to define R(e-xt)/A by means of this universal property via some adjoint functor theory.
This universal property will however not lead to an adjunction as stated, since in general only a map A  B which is surjective on 0 will have an extended Rees algebra. We can remedy this by restricting the category AlgA to the category of surjections A  B, and AlgZA[t-1] to the category of those Z-graded A[t-1]-algebras Q for which A[t-1]  Q0 is an equivalence. However, by doing so we leave the world of presentable -categories. Because for general -categories, adjoint functor theorems are less powerful, the strategy to define R(e-xt)/A as a left adjoint to Q  (Q/(t-1))0 by means of an adjoint functor theorem did not succeed.
The solution was found using Weil restrictions. To sketch the idea, let z : X  A1X be the zero section. Then the theory of Weil restrictions says that pulling back stacks along z has a right adjoint, written ResX/A1X . We thus have a natural equivalence
St/A1X (T , ResX/A1X (Z))  St/X (T ×A1X X, Z)
of mapping spaces of stacks. If ResX/A1X (Z) is affine over A1X , say ResX/A1X (Z) = Spec R, then for T = Spec Q we will get
AlgOX[t-1](R, Q)  AlgOX (B, Q/(t-1))
where B is such that Z = Spec B. This is almost the universal property that we want, save that we have lost the grading on R.
4

To recover the grading, one starts not with z but with the induced map  : BGm,X  [A1X /Gm,X]. We define DZ/X as the pullback of Res ([Z/Gm,X]) along A1X  [A1X /Gm,X]. We then show the following:
Theorem 6.3.3. The stack DZ/X is representable by a scheme affine over A1X .
By construction, DZ/X will then be of the form Spec ReZx/tX , where ReZx/tX is a Zgraded OX [t-1] algebra which satisfies the desired universal property. We will take this ReZx/tX as the extended Rees algebra of Z over X, and put BlZ X := Proj ReZx/tX .
We present two additional reasons why our recipe for blowing up in the derived setting is `correct'. First, for Z  X a closed immersion of classical schemes, it will turn out that the underlying classical scheme of BlZ X is the classical blow-up BlcZl X of X in Z.
Second, for Z  X a closed immersion of derived schemes, a virtual Cartier divisor (S, D) over (X, Z) is a scheme S over X together with a morphism D -h SZ  S such that D  S is locally on S of the form Spec R  Spec R/(f ), and such that OSZ  hOD is an isomorphism on 0 and surjective on 1. Let vDivZ X be the space of virtual Cartier divisors over (X, Z). In [KR18], the blow-up of X in Z is defined as vDivZ X in the case that Z  X is quasi-smooth, in which case it is shown to be representable by a derived scheme. We will then show:
Theorem 7.5.3. There is a virtual Cartier divisor (BlZ X, ProjZ(ReZx/tX /(t-1))) over (X, Z). If Z  X is quasi-smooth, then the induced map hZ/X : BlZ X  vDivZ X is an equivalence.
We will now introduce some terminology and notation. After this, we give a summary of this paper in §1.6, where we also outline the solution to the problems discussed in §1.2.
1.4. Elements of derived algebraic geometry. We use the language of category theory and derived algebraic geometry as in [To¨e14], [HAGI], [SAG], [GR17]. The -category of spaces is denoted by S.
Write Alg for the -category of simplicial commutative rings, simply called rings. One way to construct Alg is by endowing the category of simplicial objects in the category of commutative rings with a simplicial model structure, where weak equivalences and fibrations are taken on the underlying simplicial sets. Then Alg is the -category associated to this model category. Alternatively, Alg is the category of functors Polyop  S that preserve finite products, where Poly is the category of polynomial algebras Z[T1, . . . , Tn] and algebra maps between them.1
For R  Alg, we let cnModR be the -category associated to the model category of simplicial R-modules, and ModR the stabilization of cnModR. Alternatively, ModR is the -category of modules of R considered as an E-algebra, which is automatically stable. Then cnModR consists of the connective R-modules M , i.e., those for which nM = 0 for all n < 0.
Still for R  Alg, we write AlgR for the -category AlgR/. Points in AlgR are called R-algebras. Likewise, points in ModR are called R-modules. When we work in the point-set models of these -categories, we indicate this by talking about simplicial R-algebras resp. simplicial R-modules (in the connective case).
We write Sch for the -category of derived schemes. For X a derived scheme, we let QCoh(X) be the -category of quasi-coherent OX -modules, which has a full subcategory cnQCoh(X) spanned by the connective OX -modules. The category QCoh(X) is closed symmetric monoidal, presentable and stable [SAG, Prop. 2.2.4.1; 2.2.4.2, Rem. 6.5.3.8], with left- and right-complete t-structure [SAG, Prop. 2.2.5.4].
1Here, as always, we consider 1-categories as -categories via the nerve construction.
5

If X is affine, say X = Spec A, then we have QCoh(X)  ModA. In general, it holds that QCoh(X)  limSpec AX ModA as -categories, where the indexing category runs over all open immersions Spec A  X, and the limit is taken in the -category of stable -categories. A point M in QCoh(X) is thus a homotopycoherent system of OX (U )-modules M(U ) indexed by the affine open subsets U  X. If all of these modules are connective, such a system thus gives rise to a sheaf (in the homotopical sense, explained below) of simplicial abelian groups on the underlying space of X, with action OX × M  M, which makes M(V ) into an OX (V )-module for each V open in X.
Similarly, we define the -category Alg(X) of quasi-coherent OX -algebras for a derived scheme X as the limit limSpec AX AlgA over all affine open subsets of X.
By stack we mean a sheaf Alg  S for the ´etale topology. We write St for the full subcategory of presheaves on Algop spanned by stacks. For a stack X we let QCoh(X) be the limit limSpec RX ModR over all maps Spec R  X. When X is a derived scheme, then this notion agrees with the previous definition. For a map of stacks  : X  Y, we have an adjunction
 : QCoh(Y)  QCoh(X) : 
provided QCoh(X), QCoh(Y) are presentable. See e.g. [GR17, §I.3.2]. Roughly speaking, a derived algebraic stack is a stack X that allows a smooth
atlas. The precise definition is not important for us. What matters is the following fact: let algSt be the -category of derived algebraic stacks, and PrL be the category of presentable -categories with left-adjoint functors between them. Then any functor F : Alg  PrL can be right-Kan extended to a functor F^ : algSt  PrL. This is because for X algebraic, the indexing category to compute F^(X) consisting of maps of the form Spec R  X can be taken to be small, and PrL is closed under small limits.

1.5. Conventions. The term `levelwise' will refer to the simplicial level. Since we will be dealing with graded simplicial objects, we reserve the subscript notation Bd for the graded piece of degree d. For any simplicial object X, we reserve the notation x  X to mean points (i.e., zero-simplices) x in X.
From here on, everything is derived, by which we mean that all (co)limits are homotopy (co)limits c.q. (co)limits in the -sense, all functors are -functors, all schemes are derived, all diagrams commute up to homotopy, etc., unless otherwise stated. In particular, sheaves are taken in the homotopical sense, meaning that for a cover {U  V } the sheaf condition reads that

F (V )  lim [n] 
n

(0,...,n) F (U0 ×V · · · ×V Un )

should be an equivalence. Observe: if this limit is taken in a 1-category, then it can be computed on the subcategory [1]  [0], which retrieves the classical notion of a sheaf.
Colimits of simplicial diagrams are called geometric realizations. Dually, limits of cosimplicial diagram are called totalizations. Functors that preserve colimits are called cocontinuous.
Maps of rings, algebras, modules,... are called surjective if they are so on 0. For  : M  M  a map of R-modules, the fibre is always taken in ModR. If  is surjective, then this coincides with the fibre in cnModR.

1.6. Summary. Let S be a scheme and R a ring. In §2 we introduce the category of M -graded R-algebras, for any discrete commutative monoid M .
A key insight in the proof of Theorem 4.6.2 is that the category AlgZ of Z-graded rings can be constructed in two ways. It is either the category of those presheaves on
6

the category PolyZ of Z-graded polynomial rings over Z that send tensor products to products, or it is the category associated to a model 1-category of simplicial
graded rings. Thus, in the first incarnation, one does not start with a ring B and a decomposition B  d Bd in ModZ as in §1.2. Instead, one only specifies the graded pieces Bd, and defines the algebraic structure by giving `substitution maps' Bd1 × · · · × Bdn  Be, for any homogeneous polynomial P (X1, . . . , Xn) over Z of degree e that has Xi in degree di, in a homotopy coherent way.
We then define the category AlgZR of Z-graded R-algebras as the slice category AlgZR/. We show that the construction of AlgZR is functorial in R in Proposition 2.3.1, which allows us to globalize the notion of graded algebras in §2.4 to the category AlgZ(S) of quasi-coherent, Z-graded OS-algebras.
We recall group actions and principal bundles in the setting of derived algebraic geometry in §3. Here we also introduce the category AffGm(S) of Gm-schemes affine over S. Objects of AffGm (S) will be cosimplicial diagrams in the category of quasicoherent OS-algebras which satisfy the derived analogue of coaction axioms. It is shown that AffGm (S) is equivalent to the category Alg(BGm,S).
Section §4 is more technical, and contains the proof of Theorem 4.6.2. The strategy is as follows. First we give an adjunction  : AlgZ  AlgGm : . A Zgraded algebra can be strictified to a simplicial object in the 1-category of discrete
Z-graded algebras. Although on these algebras  will coincide with the classical
construction levelwise, we will not use this description to introduce . Indeed, the reason that we first do the absolute case, is that colimit-preserving functors out of AlgZ are classified by coproduct-preserving functors out of the 1-category PolyZ, which is a tractable problem.
After this construction, we show that  is fully faithful in Proposition 4.4.1,
by showing that the unit is invertible. We then show that  is conservative, by showing that it commutes with the forgetful functors to Alg. We then globalize to an adjunction equivalence S  S : AlgZ(S)  AlgGm,S (S) in §4.6.
In §5 we introduce the projective spectrum of a quasi-coherent, N-graded OSalgebra B generated in degree 1 as Proj B := [(Spec B V (B+))/Gm,S]. We show that Proj B is representable by giving an open cover of affine schemes of the form Spec B(f). Here, B(f) is the degree-zero part of the graded localization Bf , where B is an N-graded algebra, and f is a homogeneous element of B in degree 1. Lemma
2.7.4 is crucial in this approach, which says that the induced Gm-action on Spec Bf is free.
In §6 we introduce the extended Rees algebra of a closed immersion Z  X as a Z-graded, quasi-coherent OX [t-1]-algebra ReZx/tX , using Weil restrictions. We show that this construction is stable under base-change, and give an explicit formula for the Rees algebra in the case that Z  X is a finite quotient. This is a closed immersion of the form Spec B  Spec A, where B is obtained from A by a single
finite cell attachment. Then in §6.10 we recover the adjunction mentioned in §1.3. We close with applying our formula to a regular embedding of classical schemes.
Finally, in §7 we introduce the blow-up BlZ X := Proj RZ/X of arbitrary closed immersions Z  X, show that our description coincides with vDiv in the quasi-
smooth case, and show that we recover the classical picture as the underlying clas-
sical scheme of BlZ X. We close by proposing a generalization of the deformation to the normal cone to the derived setting in §7.6.
Not everything in the body text is strictly necessary to show the main results.
Most readers can safely skim over §3: this section is mostly there to fix notation. There are some smaller results, like the adjunction involving the Rees algebra in
§6.10, which were only relevant as intermediate results in earlier versions. However, they now serve to give a more complete picture of the theory, and are thus left in.
7

Some results that were needed in earlier versions but became obsolete in the current version have been collected in the appendix, since they seemed interesting in their own right, but did not add to the present story.
1.7. Acknowledgements. I would like to thank David Rydh for fruitful discussions and for extensive comments on previous versions. The key idea in the construction of Rees algebras, namely to use Weil restrictions, is his. I would also like to thank Adeel Khan for his helpful feedback and for several encouraging Zoom sessions. Lastly, I would like to thank Tyler Lawson for our e-mail conversation that gave me the main ideas for the proof of Proposition B.8.3.
2. M -graded algebras
Recall that Alg is the category of functors Polyop  S that preserve products, where Poly is the 1-category of finitely generated polynomial rings of the form Z[x1, . . . , xn]. One can strictify these objects in the sense that Alg is equivalent to the -category associated to the model 1-category of simplicial commutative rings. We now generalize this picture to the graded setting.
2.1. Graded rings. Throughout, fix a commutative monoid M (always discrete). Let PolyM be the 1-category of graded polynomial rings which are of the form Z[x(d1), . . . , x(dn)], where x(di) is of degree di  M , and with graded ring homomorphisms between them.2
For any category C, let P(C) be the category of presheaves on C, and P(C) the full subcategory of P(C) spanned by the finite product-preserving presheaves on C, i.e. those functors Cop  S that send finite coproducts in C to finite products in S.
Definition 2.1.1. The category AlgM := P(PolyM ) is the category of M -graded rings.
Remark 2.1.2. Let A be the 1-category of simplicial objects in the 1-category of M -graded, discrete rings. Objects of A are called simplicial, M -graded rings. Then A has a simplicial model structure, where a map B  B is a weak equivalence resp. a fibration if the maps Bd  Bd are weak equivalences resp. fibrations of simplicial sets, for all d  M . Consider PolyM as a full subcategory of A.
Let A be the -category associated to A. Then the natural map A  AlgM is an equivalence by [HTT, Cor. 5.5.9.3], since discrete M -graded rings are productpreserving 1-presheaves on PolyM . This map A  AlgM is induced by the Yoneda embedding: we send a fibrant-cofibrant object B in A to the functor
Z[x(d1), . . . , x(dn)]  MapA(Z[x(d1), . . . , x(dn)], B)  Bd1 × · · · × Bdn
which is an object of P(PolyM ). See loc. cit. for details.
2.2. Graded R-algebras. Throughout, fix R  Alg. Let  : Poly  PolyM be the functor that sends Z[x] to Z[x(0)] and which preserves finite coproducts. Write PolyR for the full subcategory of AlgR spanned by R-algebras of the form R[x1, . . . , xn], and let  : Poly  PolyR be the functor that sends Z[x] to R[x] and which preserves finite coproducts. Let (-)0 be the functor AlgM  Alg which is given by precomposing with , i.e., this functor sends an M -graded ring B to its degree-zero part B0.
2It would be more precise to write x(di) as xi(di), since the degrees are not assumed to be different. The double index will be suppressed nonetheless.
8

Example 2.2.1. We consider R as an M -graded ring with trivial grading as follows. Taking a model for R, we may assume that R is a simplicial ring. Then endow this simplicial object in the 1-category of discrete rings level-wise with the trivial grading (i.e., concentrated in degree 0). This gives a simplicial object in the 1-category of discrete graded rings, hence an object of AlgM by Remark 2.1.2.
We will see in Example 2.3.5 the following more intrinsic definition of the trivial grading, without involving simplicial models. Namely, we can consider R as a functor Polyop  S. Then R endowed with trivial grading is the left Kan extension of R along .
Definition 2.2.2. The category AlgM R of M -graded R-algebras is the fibre product AlgM ×Alg AlgR of (-)0 along the forgetful functor U : AlgR  Alg.
Remark 2.2.3. Observe that U : AlgR  Alg is a fibration in the Joyal model structure by [HTT, Cor. 2.4.6.5]. It follows that AlgM R is the underived fibre product of simplicial sets. Hence, AlgM R is the category of pairs (B, R  B0), where B is an M -graded ring and R  B0 a ring map. In other words, AlgM R is the coslice category AlgM R/, where R is endowed with the trivial grading.
Remark 2.2.4. From Remark 2.2.3 and Remark 2.1.2 it follows that, for B  AlgRM , we have a decomposition B  dM Bd with Bd  QCoh(R) the graded piece of degree d.
Let R[x(d1), . . . , x(dn)] be the tensor product R Z Z[x(d1), . . . , x(dn)] in AlgM , for d1, . . . , dn  M . Then R[x(d1), . . . , x(dn)] gives an object of AlgM R in an obvious way. Let PolyM R be the full subcategory of AlgM R spanned by the objects of this form.
We need the following two notions from [HTT, §5.5.8]. A non-empty simplicial set K is sifted if the diagonal d : K  K × K is cofinal, that is, if precomposition with d preserves colimits. Now an object c in a category C is compact projective if it corepresents a functor C  S that preserves sifted colimits. For example, for a category D with finite coproducts, the image of d  D under the map D  P(D) is compact projective.
Lemma 2.2.5. The functor U : AlgR  Alg and the functor (-)0 : AlgM  Alg preserve sifted colimits.
Proof. By [HTT, Prop. 5.5.8.10], sifted colimits in P(C) are computed as colimits in P(C), i.e., pointwise, for any category C. It follows that for any functor  : C  D which preserves finite coproducts, the map  : P(D)  P(C) preserves sifted colimits. Now the claim follows since the forgetful functor AlgR  Alg is , and (-)0 : AlgM  Alg is .
Lemma 2.2.6. The objects in PolyM R are compact projective in AlgM R .
Proof. Consider objects in AlgM R as pairs (B, B) with B  AlgR and B  AlgM . By [Cis19, Prop. 6.2.19] and Lemma 2.2.5, the colimit of a sifted diagram {(B, B )} in AlgM R is (colim B, colim B ). In particular, the projection AlgM R  AlgM preserves sifted colimits. For any d  M , the functor AlgM  S : B  Bd also preserves sifted colimits, since Z[x(d)] is compact projective in AlgM . It follows that the composition
AlgM R  AlgM  S : B  Bd
preserves sifted colimits, i.e., that R[x(d)] is compact projective in AlgM R . By [HTT, Prop. 5.5.8.25], all objects in PolyM R are now compact projective in AlgM R , since these objects are coproducts of the form R[x(d1)]  · · ·  R[x(dn)].
9

Remark 2.2.7. We can in fact show that the inclusion PolyM R  AlgM R induces an equivalence P(PolyM R )  AlgM R . Since the proof is somewhat technical, and the result is not essential in what follows, the argument can be found in Appendix A.
2.3. Change of rings and of monoids. Let Mon be the 1-category of discrete commutative monoids and monoid homomorphisms between them. Following [HTT], we write PrL resp. PrR for the category that has presentable categories as objects and functors which are left resp. right adjoints as morphisms.
Proposition 2.3.1. For j : M  M  a homomorphism of commutative monoids and  : R  R a ring map, we have an adjunction
!j! : AlgM R  AlgM R : j!!
where j!! is given on objects by precomposing with a map PolyM R  PolyM R that sends R[x(d)] to R[x(j(d))], and !j! is given by left Kan extension.
These adjunctions are natural in M and R in the sense that we have a functor Alg((--)) : Algop × Monop  PrR which is given by (, j)  j!! on morphisms.
Proof. We first give the adjunction in the following two special cases: (i) Where  is the identity on Z and j : M  M  is arbitrary; (ii) Where  : R  R is arbitrary and j is the identity on M , for some M .
Case (i). We first define the finite coproduct-preserving functor
[j] : PolyM  PolyM : Z[x(d)]  Z[x(j(d))]
It suffices to decide how [j] acts on the following hom-sets
PolyM (Z[x(d)], Z[x(e1), . . . , x(en)])  PolyM (Z[x(j(d))], Z[x(j(e1)), . . . , x(j(en))])
Now since PolyM (Z[x(d)], Z[x(e1), . . . , x(en)])  Z[x(e1), . . . , x(en)]d
it suffices to give natural maps Z[x(e1), . . . , x(en)]d  Z[x(j(e1)), . . . , x(j(en))]j(d). For this, we take the map of Z-modules which is given by x(ei)m  x(j(ei))m. Since PolyM , PolyM are discrete categories, naturality is unproblematic.
Write now j! for the functor P(PolyM )  P(PolyM ), given by precomposing with [j] : PolyM  PolyM . Since [j] preserves tensor products, j! restricts to a functor j! : AlgM  AlgM , by definition of AlgM and AlgM .
By the dual of [Cis19, Prop. 6.4.9], we have a left adjoint j! : P(PolyM )  P(PolyM ), which is given on objects by pointwise left Kan extension. From the latter fact and the proof of [HTT, Prop. 5.5.8.15], [SAG, Prop. 25.1.1.5], it follows that j! restricts to the unique cocontinuous functor AlgM  AlgM , which on PolyM is given by [j] followed by the inclusion PolyM  AlgM .
Case (ii). We have an adjunction ! : AlgR  AlgR : !, where the left adjoint is given by taking tensor products and the right adjoint by precomposition with . The right adjoint ! commutes with the forgetful functors to Alg. On the other hand, we also have endofunctors (-) R R on Alg and AlgM . Together with !, these give a morphism of cospans from AlgM  Alg  AlgR to AlgM  Alg  AlgR .
We can thus take fibre products on both sides of the adjunction over Alg with AlgM , to get the adjunction
! : AlgM R  AlgM R : !
Observe that by Remark 2.2.3, we can still describe ! via precomposition with .
10

Now for the general case, consider the adjunction j! : AlgM  AlgM : j! from the first case. Observe that j! sends R  Alg with trivial M grading to R with trivial M  grading. Hence, taking coslices gives an adjunction j! : AlgM R  AlgM R  : j! by Remark 2.2.3. Composing with the second case gives us the adjunction
!j! : AlgM R  AlgM R   AlgM R : j!!
Since for R  R in Alg and j : M  M  in Mon it holds for all d  M that R[x(j(d))]  R[x(j(d))] R R, we have that !j! restricts to the functor PolyM R  PolyM R : R[x(d)]  R[x(j(d))]. From the adjunction !j!  j!! it follows that j!! is given by precomposition with !j!.
It remains to show naturality in M and R. The functors [j] : PolyM  PolyM from the first case give a functor H : Mon  Cat : M  PolyM . Since H lands in 1-categories, naturality is unproblematic. Now composition with H induces a functor
Monop  PrR : M  AlgM
which on morphisms is given by sending j : M  M  to j! : AlgM  AlgM , as in the first case. Taking coslice categories, we get a functor
Monop  PrR : M  AlgM R
for any R  Alg. By naturality of the coslice construction, this gives us a functor Algop  Fun(Monop, PrR), and thus a functor
Algop × Monop  PrR : (R, M )  AlgM R
which sends (, j) : (R, M )  (R, M ) to the functor j!!, which is what we wanted.
Remark 2.3.2. Taking adjoints, we also get a functor Alg((--)) : Alg × Mon  PrL, which on morphisms is given by sending (, j) to !j!.
Remark 2.3.3. Let p : C  Alg × Mon be the Cartesian fibration associated to the functor Algop × Monop  PrR which sends (R, M ) to AlgM R and (, j) to j!!. We can describe C as the category of triples (R, M, B), where M is a commutative monoid, R a ring, and B an M -graded R-algebra. A morphism (R, M, B)  (R, M , B) is given by a ring map  : R  R, a monoid homomorphism j : M  M  and a morphism h : B  j!!B in AlgM R . Then p is the forgetful functor.
Notation 2.3.4. As in the proof of Lemma 2.3.1, we write the adjunction id! j!  j! id! as j!  j!, and ! id!  id! ! as !  !.
Example 2.3.5. We recover the following adjunctions from Proposition 2.3.1.
(1) For j the trivial map 0  0 we recover the extension-restriction by scalars adjunction.
(2) For j the inclusion 0  M  we have that j! : AlgM R   AlgR is the functor (-)0. From the adjunction, it follows that j!R[x] is R[x(0)]. Since AlgR is generated by polynomial algebras under colimits, in general j! therefore sends an R-algebra A to the graded algebra which is A concentrated in degree 0. We say that j! endows A with the trivial grading.
(3) For j the map M  0 it holds that j!R[x(d)] = R[x], which follows from the proof of Proposition 2.3.1. Since j! is cocontinuous, it follows that j! is the functor which forgets the grading. Observe that j!A is the derived analogue of the monoid algebra A[M ].
11

(4) For general  : R  R and j : M  M , given B in AlgM R , the underlying R-algebra of !j!B is B R R. This follows from the naturality of the adjunctions and the previous examples.
2.4. Graded, quasi-coherent algebras on algebraic stacks. Throughout, fix an algebraic stack X and a scheme S. Using Proposition 2.3.1, we now define the relative case. We are mostly interested in graded, quasi-coherent algebras on schemes: we only need to consider graded, quasi-coherent algebras in one case, namely on the algebraic stack BGm. We therefore only generalize to algebraic stacks when needed or when it is as much effort as the case of schemes.
Definition 2.4.1. Extend the functor Alg((--)) : Alg × Mon  PrL to a functor algStop × Mon  PrL, written (X, M )  AlgM (X), by right Kan extension along the inclusion Alg ×Mon  algStop ×Mon (allowed by [HTT, Prop. 5.5.3.13]). For a stack X and a monoid M , we call AlgM (X) the category of M -graded, quasi-coherent OX-algebras.
For f : X  X a morphism of stacks, and j : M  M  a morphism of commutative monoids, we have an adjunction f j!  j!f : AlgM (X)  AlgM (X), by construction of Alg((--)).
Remark 2.4.2. Let C, D, E be categories, C0 a subcategory of C, with E cocomplete, and F0 : C0 × D  E a functor. Write h for the inclusion C0  C, and let F be the left Kan extension of F0 along (h × idD).
Observe that for any (c, d)  C × D, the functor C0/c  (C0 × D)/(c,d) that sends f : c0  c to the pair (f, idd) is a right adjoint, hence cofinal by [Cis19, Cor. 6.1.13].3 The functor F (-, d) : C × {d}  E is therefore the left Kan extension of F0 : C0 × {d}  E along (h × id{d}).
From Remark 2.4.2 it follows that AlgM (X) is the right Kan extension of AlgM (-) along Alg  algStop, i.e. AlgM (X) is the limit limSpec RX AlgM R of categories, with transition maps AlgM R  AlgM R for Spec R  Spec R over X induced by pulling back.
Remark 2.4.3. Call a morphism of algebraic stacks X  X affine if for any scheme U over X the morphism UX  U is affine. For the trivial monoid {0}, we get that Alg(X) := Alg{0}(X) is (contravariantly) equivalent to the category Aff/X of algebraic stacks affine over X.
This known fact can roughly be seen as follow. We have a functor Aff/X  Alg(X) induced by the functors Aff/X  AlgR, indexed over maps Spec R  X, that send X  X to the R-algebra A such that Spec A = XR. To check that this functor is an equivalence, we use that St/X  limSpec RX St/ Spec R. Thus the statement can be checked affine-locally on X, which is clear.
For a composition X -f Y -g Z with g and gf affine it holds that f is affine as well. Indeed, f factorizes as the closed immersion X  X ×Z Y, which is affine, followed by the projection X ×Z Y  Y. The latter map is also affine, since being affine is stable under base change.
For A a quasi-coherent OX-algebra, we write the corresponding stack over X as Spec A.
Let B be an M -graded, quasi-coherent OX-algebra. Write j for the map M  0. Then the underlying quasi-coherent OX-algebra j!B, written simply as B, comes with a decomposition B  dM Bd in QCoh(X), such that affine-locally Bd is the
3In [Cis19], what we call a cofinal functor is called a final functor.
12

graded piece of degree d of B. This follows from the fact that j! commutes with f , for any f : Spec R  X, together with Remark 2.2.4.

Notation 2.4.4. We call Z-graded rings and Z-graded algebras simply graded rings and graded algebras.

Example 2.4.5. For j : N  Z the inclusion, the functor j! : AlgZ(X)  AlgN(X) sends A to an N-graded algebra which has underlying OX-module An :=
n0 An.
Example 2.4.6. Consider the adjunction SymR  U , where U is the forgetful functor AlgR  cnModR. Let j be the map N  0.
Writing the presheaf j!A on PolyNR as R[x(d)]  Ax(1)d, we get j!A  A[x(1)] in the obvious way, for any R-algebra A. Using the adjunctions, we thus get natural equivalences
AlgR(SymR(U R), A)  A  A[x(1)]1  AlgNR(R[x(1)], A[x(1)])  AlgR(j!j!R, A)
for all A in AlgR. It follows that SymA(A)  j!j!A for any R-algebra A, by [SAG, Prop. 25.2.3.1], by naturality of the adjunctions in Proposition 2.3.1, and since j! commutes with base-change. We write this R-algebra as A[t].
Inverting t gives us A[t±1] := A[t, t-1], which is equivalent to i!i!A where i is the map Z  0. Globalizing gives us graded, quasi-coherent OS-algebras A[t] and A[t±1], for any quasi-coherent OS-algebra A.
Since A[t]  A Z Z[t] and Z  Z[t] is a cofibration, we can compute A[t] by adjoining the free variable t levelwise to a simplicial model for A. This shows that (A[t]) = (A)[t] as 0(A)-modules. From [DAGV, Prop. 4.1.18] it follows that also (A[t±1]) = (A)[t±1] as 0(A)-modules.
Lemma 2.4.7. Let f : X  Y be a morphism of algebraic stacks. Write j for the map Z  0, so that j! is the functor that forgets the grading. Then the following diagram commutes
AlgZ(X)  AlgZ(Y)

j!

j!

Alg(X)  Alg(Y)

Proof. Consider the unit  : id  j!j! on AlgZ(X). Upon applying  to both sides, we get a map   j!j!  j!j!, where we have used naturality of Alg((--)) in the equivalence. Now taking the adjoint of this map gives us a natural transformation
 : j!  j!
between the two ways around the square. We claim that  is an equivalence. Since the question is smooth-local on both X and Y, we may assume that f is of the form Spec B  Spec A. The latter case is obvious.

2.5. Graded, quasi-coherent modules on algebraic stacks.
Definition 2.5.1. The category of M -graded, quasi-coherent OX-modules is defined as QCohM (X) := QCoh(X)×M .
We often abuse notation, and introduce an M -graded, quasi-coherent OX-module {Nd}dM by only introducing the underlying quasi-coherent OX-module N :=
dM Nd. We say N is connective when the underlying OX-module is so, and write the category of connective objects as cnQCohM (X).
13

Lemma 2.5.2. For any M -graded, quasi-coherent, connective OX-module N , and all k  0, we have a natural isomorphism kN = dM k(Nd). It follows that (N ) is M -graded as 0(OX)-module, with graded pieces of degree d of the form  (Nd ).
Proof. Use the Dold-Kan correspondence.
Remark 2.5.3. The category QCohM (X) is symmetric monoidal in the following way. Informally, for given M -graded, quasi-coherent OX-modules N , N , we let N  N  be the graded module which is e+f=d Ne  Nf in degree d.
Formally, we let M  be the symmetric monoidal category associated to M , where the tensor product is given by addition in M , and with only identity morphisms. Then QCohM (X) is the category of functors M  QCoh(X). Thus, by Day convolution we get a symmetric monoidal structure on QCohM (X), which is also available in the -setting by [Gla13]. Since M has no non-identity morphisms, this monoidal structure is particularly easy to compute, which recovers the informal description.
Remark 2.5.4. When S = Spec R, then cnModM R := cnQCohM (Spec R) can be computed as the -category associated to the model category of M -graded simplicial R-modules.
2.6. Graded, connective E-algebras. For a symmetric monoidal category C, write Alg(C) for the category of commutative algebra objects in C as in [HA, Def. 2.1.3.1]. Then Alg(cnQCohM (S)) is the category of M -graded, connective Ealgebras over OS. By [Gla13, Prop. 2.12], this category is equivalent to the category of lax symmetric monoidal functors M   cnQCoh(S).
If M = {0} and S = Spec R, this recovers the notion of connective E-algebras over R by the proof of [SAG, Prop. 2.5.1.2].
Lemma 2.6.1. The map Alg(cnQCohM (S))  limSpec RS Alg(cnModM R ), given by restriction, is an equivalence.
Proof. A lax symmetric monoidal functor M   cnQCoh(S) is the same thing as a compatible family of lax symmetric monoidal functors M   cnModR, indexed by all maps Spec R  S, in the category C of symmetric monoidal categories and lax monoidal functors between them.
Remark 2.6.2. We have a map F : AlgM (S)  Alg(cnQCohM (S)). Indeed, by Lemma 2.6.1, it suffices to give maps when S = Spec R, natural in R. But this is straightforward: given an M -graded R-algebra B, we may assume that the underlying M -graded ring is a simplicial M -graded ring. Then we have a strictly commutative diagram in the category of M -graded, simplicial R-modules, which gives a commutative algebra object in cnQCohM (R).
The map F is in general not an equivalence by [SAG, §25.1.2]. For example, when M = {0}, we know that F in general is only an equivalence in characteristic 0.
Composing the functor F : AlgM (S)  Alg(cnQCohM (S)) with the forgetful functor Alg(cnQCohM (S))  cnQCohM (S) gives us a functor U : AlgM (S)  cnQCohM (S). For B  AlgM (S) we call U B the underlying graded, quasi-coherent OS-algebra. As in the ungraded case, we might suppress the notation U .
2.7. Homogeneous localization. Let R be a ring and B an N-graded R-algebra. We will recover the following classical picture:
Remark 2.7.1. If B is discrete and M is a discrete, graded R-module, then for f  R homogeneous of degree 1, the underived tensor product Mf := M R Rf
14

is graded, where the homogeneous elements of degree d - k are of the form m/f k,
with m  M homogeneous of degree d. We write the graded piece of degree 0 as
M(f ). For a non-graded discrete R-module N , the underived tensor product N RR[t±1]
is graded in the obvious way. For M as above and f  R homogeneous of degree 1, the map M(f) R R[t±1]  Mf : x  tn  xf n is an isomorphism.

Recall that the ungraded case of localization has been generalized to the derived

setting in [DAGV, Prop. 4.1.18]. Our approach will be similar.

Let A be an R-algebra, and put 0(A)×, and that n(A×) = n(A)

A× := AlgR(R[t±1], A). for n > 0. Hence A× 

Recall that 0(A×) A is monic in S.

=

Definition 2.7.2. Let f be a homogeneous point in B. A map of Z-graded Ralgebras  : B  B exhibits B as the homogeneous localization of B at f if
for any other Z-graded R-algebra C it holds that composition with  induces an
equivalence

AlgZR(B, C)  AlgZR,f (B, C),

where AlgZR,f (B, C) is the subspace of AlgZR(B, C) spanned by those maps that send f into C×.

Proposition 2.7.3. Let f be a homogeneous point in B of degree d. Then there is
a homogeneous localization of B at f , written B  Bf . Moreover, this localization is unique in AlgZR up to contractible choice, and the underlying R-algebra of Bf corresponds to the ungraded localization at f .

Proof. For existence, we define Bf as the pushout

R[s] sf B

R[s±1]

Bf

in AlgZR, with deg(s) = d. We claim that Bf is the homogeneous localization of B at f .
For C  AlgZR we have have that AlgZR(R[s±1], C) is equivalent to the subspace of Cd spanned by those elements which are invertible in 0C, i.e.,
AlgZR(R[s±1], C)  Cd ×C C×
By construction of Bf and by composing pullback squares, we thus get that

AlgZR(Bf , C)

C×

AlgZR(B, C)

C

is Cartesian. The claim follows from the fact that the bottom horizontal arrow maps  to (f ), and that the right vertical arrows is monic.
Unicity is clear. Let j be the map Z  0. It remains to show that j!(Bf )  (j!B)f . To this ends, by adjunction and the universal property of graded localization, we have that
AlgR(j!(Bf ), A)  AlgZR,f (B, A[t±1])
where deg(t) = 1. Now the equivalence AlgR(j!B, A)  AlgZR(B, A[t±1]) gives an equivalence AlgR,f (j!B, A)  AlgZR,f (B, A[t±1]). Indeed, for a given  : j!B  A
15

with transpose ¯ : B  A[t±1], the map 0(¯) sends f to (f )td. Now since 0(A[t±1]) = 0(A)[t±1] by Example 2.4.6, the element (f )td is invertible in 0(A[t±1]) if and only if (f ) is invertible in 0(A).

For f a homogeneous point in B of degree 1, write B(f) for the degree zero part of Bf . We then have the following.
Lemma 2.7.4. The natural map B(f)[t±1]  Bf , sending t to f , is an equivalence of graded R-algebras.
Proof. Consider (B) as 0(B)-module. Then (B(f)[t±1]) = (B(f))[t±1] by Example 2.4.6, and we have the isomorphisms
(B(f))[t±1] = ((Bf )0)[t±1] = ((B)f )0[t±1] = (B)f = (Bf )
Here, we have used: the definition of B(f); Lemma 2.5.2; Remark 2.7.1 and [DAGV, Prop. 4.1.18].

2.8. Irrelevant ideal. Let i be the map 0  N and j the map N  0. We can summarize the adjunctions i!  i! and j!  j! as explained in Example 2.3.5 in the
following diagram

trivial
i!
Alg(S)
i!
(-)0

forget

AlgN(S) j!
j!

Alg(S)

(-)[t]

Throughout, write  : i!i!  id for the counit of the adjunction i!  i!. In the classical case, the map B : B0  B has a retraction B  B0 with fibre the irrelevant ideal B+. This map B  B0 comes about since there is also an adjunction i!  i!. We will now generalize this to the derived picture.
Recall that a functor is conservative if it reflects equivalences.

Proposition 2.8.1. There is an adjunction i! : AlgN(S)  Alg(S) : i! with counit  : id  i!i! such that     id.

Proof. We first do the case S = Spec Z. Write sAlg resp. sAlgN for the model 1-category of simplicial rings resp. simpli-
cial, N-graded rings. Write  for the inclusion sAlg  sAlgN that endows A  sAlg with the trivial grading. Then the functor  : sAlgN  sAlg that sends B to B0 is both a left and right adjoint to  .
In fact,  is both left and right Quillen. Indeed, it is right Quillen since it
preserves fibrations and trivial fibrations, and it is left Quillen since  preserves
fibrations and trivial fibrations. Both statements follow from the fact that fibrations and weak equivalences in sAlgNR are defined degree-wise.
Consequently, both  and  preserve cofibrations and trivial cofibrations. There-
fore, the left derived functor of  can be computed by composition with a fibrant-
cofibrant replacement, and thus coincides with the right derived functor. The same
holds for .
By [Hin16, Prop. 1.5.1], the derived functors of a Quillen adjunction induce an
adjunction on the associated -categories. Since the derived functor of  is i! and of  is i!, we indeed have an adjunction i!  i!.
As in the proof of Proposition 2.3.1, Claim (ii), we promote i!  i! to an adjunction AlgNR  AlgR with counit , for any R  Alg. To globalize this to S, observe that j!i! is the identity on Alg(S), and that j! is conservative, hence that i! preserves all limits and colimits. We therefore have an adjunction
i  i! : AlgN(S)  Alg(S)

16

Now i coincides with i! because this is true affine-locally by the case S = Spec R, and since left adjoints are unique up to contractible choice.
It remains to show that for B  AlgN(S), the composition BB : B0  B  B0 is an equivalence. This can be checked locally, so we assume that S = Spec R and that B corresponds to B  AlgN(R).
Consider B as a pair (B0, B)  AlgR ×Alg AlgN. Then BB is the composition
(B0, B0)  (B0, B)  (B0, B0)
induced by the identity on B0 and by the maps B0  B  B0 from the adjunctions in the case R = Z. Hence, it suffices to do the case R = Z. But this case follows from the classical case, together with the fact that both  and  preserve trivial fibrations and trivial cofibrations.

Definition 2.8.2. For B  AlgN(S), write B+ for the graded, quasi-coherent OSmodule n>0 Bn. We call B+ the irrelevant ideal.
Proposition 2.8.3. The sequence B+  B --B B0 is a fibre sequence.

Proof. The question is local on S, so assume that S = Spec R and that B corresponds to B  AlgNR. Since B0  B  B0 is a sequence of graded maps which composes into the identity, the map B  B0 is given by the projection on the
underlying graded R-modules.
Let F be the fibre of B  B0. Since the map

n(B) =

d0 n(Bd)  n(B0)

is given by the projection, it is surjective. The claim now follows by considering the long exact sequence in homotopy groups associated to F  B  B0.

The surjection B  B0 gives us a closed immersion Spec B0  Spec B, which we write as V (B+)  Spec B.

3. Equivariant geometry
We review some theory on group actions, following [HTT, §6.1.2], [NSS15].
3.1. Groupoids and groups. Let C be a category with fibre products. We say that a simplicial object X : op  C satisfies the Segal condition if for all n  1 the map Xn  X1 ×X0 · · · ×X0 X1 induced by the spine inclusion is an equivalence, and that morphisms are invertible if the map X2  X1 ×X0 X1 induced by 2[2]  [2] is an equivalence.
A groupoid object in C is a functor G : op  C which satisfies the Segal condition and such that morphisms are invertible. The category of groupoid objects in C is the full subcategory of Fun(op, C) spanned by groupoid objects.
Definition 3.1.1. A group object in C is a groupoid object G in C such that G0 is contractible.
We write a group object G in C with G1 = G as B(, G). We often suppress notation and refer to G by G.
Example 3.1.2. Let H be an abstract group. Consider H as a one-point category. Then the nerve of H gives us a group object in Set.
Applying the same procedure to a classical group scheme G gives us a simplicial diagram in St which sends [n] to Gn. This is a group object in St, and it has the property that the colimit of this diagram is the familiar stack BG.
17

3.2. Group actions. Let C still be a category with fibre products, and let G be a group object in C.

Definition 3.2.1. A G-object in C is a groupoid object in C of the form B(P, G) : op  C : [n]  Gn × P

such that d1 : G × P  P is the projection, and such that the levelwise projection B(P, G)  B(, G) is a morphism of groupoid objects. We call d0 : G × P  P the action of G on P and P the underlying object of B(P, G).
The category CG of G-objects is the full subcategory of groupoid objects over G
spanned by G-objects. Morphisms of G-objects are called G-equivariant maps.

We refer to a G-object B(P, G) as P when convenient, similarly as in the classical case.

Example 3.2.2. Let G be a classical group scheme acting on a classical scheme X. Then consider the action category, which has the points of X as objects and as morphisms x  y those g  G such that gx = y. The nerve of this category is the quotient groupoid B(X, G), which sends [n] to Gn × X. We thus think of a one-simplex (g, x) in B(X, G) as an edge from x to gx. Let us spell out the general formulas for the face and degeneracy maps for future reference and to fix the precise indexing.
For 0  i  n, we have that

di : Gn × X  G(n-1) × X

(g1, . . . , gn-1, gnx)  (g1, . . . , gn, x)  (g1, . . . , gn-ign-i+1, . . . , gn, x)
(g2, . . . , gn, x)

if i = 0 if 0 < i < n if i = n

Likewise, for 0  j  n the map sj : Gn × X  G(n+1) × X sends the element (g1, . . . , gn, x) to (g1, . . . , gn-j, e, gn-j+1, . . . , x).
Of particular interest is the case when G = Gm and X = Spec B. In this case B(X, G) induces and is determined by the corresponding cosimplicial diagram C(B, Z[t±1]) in the category of discrete rings that sends [n] to B[t±1 1, . . . , t±n 1]. The coface maps are given by, for 0  i  n

di : B[t±1 1, . . . , t±n-1 1]  B[t±1 1, . . . , t±n 1]

bte11

·

·

·

ten-1
n-1



te11

·

·

·

ten-1
n-1

d bdtdn

bte11 · · · (tn-itn-i+1)en-i

·

·

·

ten-1
n

bte21

·

·

·

ten-1
n

if i = 0 if 0 < i < n if i = n

where the bd are determined by (b) = d bdtd for  : B  B[t±1] the coaction. The codegeneracy maps sj : B[t1±1, . . . , tn±+11]  B[t1±1, . . . , t±n 1] for 0  j  n are B-algebra maps that send the elements t1, . . . , tn+1 to t1, . . . , tn-j, 1, tn-j+1, . . . , tn.

3.3. Principal bundles. Suppose now that G is a group object in St. For example, G can be any classical group scheme. Then for B(P, G) a given G-action in St, we define the corresponding quotient stack [P/G] as the colimit of B(P, G) in St.
Definition 3.3.1. Let T be a stack. A principal G-bundle over T is a morphism B(P, G)  T together with a G-action B(P, G) such that P  T is colimiting, i.e., gives an equivalence [P/G]  T . A morphism of principal G-bundles is a morphism of G-objects B(P, G)  B(P , G) that fixes T . This gives the category Bun(T, G) of principal G-bundles over T .
18

The main result here is that   BG classifies principal G-bundles. That is, by [NSS15] we have an equivalence of categories

St(T, BG)  Bun(T, G) : (T  BG)  (T ×BG B(, G)  T )

In fact, pulling back along B(, G)  BG gives us an equivalence St/BG  StG.

Example 3.3.2. Let S be a scheme. Let G be a group scheme over S acting on a
scheme X over S. Then for T  S in Sch it holds that St/S (T, [X/G]) is equivalent to the space of diagrams

P

X

T

S

where P  T is a principal G-bundle and P  X is G-equivariant. Indeed, for given T  [X/G] we can form the pullback diagrams

P

X

S

T

[X/G]

BG

Remark 3.3.3. Let X be a G-object in any category, with d0 =  the action. Write the face maps of G as i. From the Segal condition it follows that di : Gn × X  Gn-1 × X is homotopic to (idGn-1, ) if i = 0, and to (i, idX ) otherwise. Likewise, it follows that sj is homotopic to the map which is the unit of G in the j-th coordinate, and the identity on the other coordinates.

3.4. BGm,S-algebras. Let S be a scheme. Consider Gm,S := Gm × S as a group object in St/S . For S = Spec R we write Gm,S as Gm,R. For  : S  S a morphism of schemes we have that BGm,S is the pullback of BGm,S along . This is because pullbacks commute past colimits in St, as they do in any topos by universality of
colimits.

Definition 3.4.1. The category AffGm(S) of Gm,S-schemes affine over S is the full subcategory of StG/Sm,S spanned by those Gm,S-stacks which are schemes affine over S.

When

S

=

Spec R

or

when

S

=

Spec Z

we

write

AffGm (S)

as

Aff

Gm R

or

as

Aff Gm

respectively. Write AlgGm for the opposite of AffGm, i.e., this is the category of

rings

with

a

Gm-coaction.4

Likewise,

define

AlgGRm

:=

(Aff

Gm R

)op

and

AlgGm (S)

:=

AffGm (S)op.

Proposition 3.4.2. Pulling back along the quotient map  : S  BGm,S induces an equivalence Alg(BGm,S)  AlgGm,S (S).

Proof. Recall from §3.3 that pulling back along  gives us an equivalence
(St/S )/BGm,S  StG/Sm,S
Since  is affine, it holds that X  BGm,S is affine if and only if XS  S is, for any algebraic stack X. Thus the claim follows from Remark 2.4.3.

When convenient, we will tacitly identify AlgGm(S) with Alg(BGm,S) via the equivalence above.

4It would be more correct to call this a (Gm)-coaction. We have suppressed the  to ease notation.
19

Remark 3.4.3. We actually have a functor AlgGm (-) : Schop  PrL, since StGSm,S is functorial in S and since being affine is stable under pullbacks. The equivalence

in Proposition 3.4.2 is natural in S, hence AlgGm(-) : Schop  PrL is the right

Kan extension of the restriction AlgGm (-) : Alg  PrL. It follows that the map

H

:

AffGm (S)



limSpec RS

Aff

Gm R

is

an

equivalence.

Example 3.4.4. Let  : S  BGm,S be the projection map and  : BGm,S  S
the structure map. Then  sends R  Alg(S) to R[u±1]  AlgGm,S (S) with diagonal coaction of Gm,S, and  is the functor which forgets the coaction. The functor  endows R  Alg(S) with trivial action, and  sends A  AlgGm,S (S) to the invariants AGm .

4. Graded algebras and Gm-actions

Fix a base scheme S. The goal of this section is to show the following.

Theorem 4.6.2. There is a contravariant equivalence from the category of quasicoherent, Z-graded OS-algebras to the category of Gm,S-schemes affine over S.
We write the simplicial diagram of a Gm,S-scheme X = Spec A affine over S as B(X) = {Bn(X)}n. Recall that B(X) lives over the trivial Gm,S-scheme B(S) = B(S, Gm,S). Observe that B(X) determines and is determined by a cosimplicial diagram in Alg(S), which we write as C(A) = {Cn(A)}n. Then C(A) lives under the cosimplicial diagram C(OS ) corresponding to the trivial Gm,S-action B(S) on S. We write Cn(A) as A[t±1 1, . . . , t±n 1], where the indexing is as in Example 3.2.2. We use the obvious similar notation in the affine case. In particular, the cosimplicial diagram associated to the trivial Gm-action on Spec Z is written as C(Z).
As for Gm-schemes, we often abuse notation by introducing objects of AlgGm by saying that A is a ring with Gm-coaction, with associated cosimplicial diagram C(A).

4.1. The affine Gm-scheme associated to a graded ring. Observe that AlgGm is a full subcategory of Alg C(Z)/, and that Alg C(Z)/ is cocomplete by [HTT, Cor. 5.1.2.3]. For a given diagram F : K  AlgGm , the colimit in Alg C(Z)/ is computed pointwise, and lands in AlgGm , since (-)  Z[t±1] commutes with colimits. Hence AlgGm is cocomplete.
We have an obvious coproduct-preserving map PolyZ  AlgGm, which sends Z[x(d)] to the cosimplicial diagram associated to the coaction Z[x(d)]  Z[x(d), t±1] determined by x(d)  x(d)td. By left Kan extension, we get a functor
 : AlgZ  AlgGm

Since  preserves finite coproducts in PolyZ, this functor  preserves all small colimits. See [HTT, Prop. 5.5.8.15], [SAG, Prop. 25.1.1.5] and their proofs.

Remark 4.1.1. We can describe  explicitly on fibrant-cofibrant simplicial graded rings. Let B be such an object. Then the grading is levelwise, hence we have a levelwise coaction of Gm, which extends levelwise to a cosimplicial diagram in the category of discrete rings. Combining these levels gives us a cosimplicial diagram in Alg, which recovers (B).

Proposition 4.1.2. The cocontinuous functor  has a right adjoint.
Proof. This follows from [HTT, Cor. 5.5.2.9, Rem. 5.5.2.10], since AlgZ is presentable and  cocontinuous.

From here on, take a right adjoint  to , so that we are in the situation

(4.1)

 : AlgZ  AlgGm : 

20

4.2. Twisted coaction. In this paragraph, fix A in AlgGm with cosimplicial diagram C(A).
Remark 4.2.1. Recall that if A is classical, then we know that it has a Z-grading. The graded piece Ad is the (underived) equaliser of A  A[t±1], where one map is the coaction A  A[t±1] multiplied with t-d, and the other map is the inclusion. We will generalize this formula for Ad to the derived setting, which will help us both in showing that  is fully faithful and in showing that  is conservative.
Definition 4.2.2. Let C(A[u±1]) be the cosimplicial diagram in Alg associated to the diagonal Gm-action on Spec A × Spec Z[u±1].
We grade the rings Cn(A[u±1]) via the grading on Z[u±1] which has u in degree -1. Then C(A[u±1]) is actually a cosimplicial diagram in AlgZ.
Definition 4.2.3. For d  Z define the d-th twist of A as the cosimplicial space
C(A(d)) :   S : [n]  AlgZ Z[x(d)], Cn(A[u±1])
where the cosimplicial structure is induced by C(A[u±1]).
Observe that C(A(d)) sends [n] to Cn(A). It also has the same coface and codegeneracy maps as C(A), except that the maps d0 : Cn-1(A(d))  Cn(A(d)) are multiplied with t-n d, for all n.
Recall that a coaugmentation of a cosimplicial diagram X :   C in a given category C is an extension of X to a diagram on the category + of finite ordinals and order-preserving maps. A coagumentation is limiting if the induced map X()  lim X is an equivalence.
Definition 4.2.4. Let d  Z. The map
AlgGm ((Z[x(d)]), A)  Alg(Z[x(d)], A)  AlgZ(Z[x(d)], C0(A[u±1]))
that sends f to f 0 induces a coaugmentation
A,d : AlgGm ((Z[x(d)]), A)  C(A(d))
in S. Since the A,d are natural in d, by definition of AlgZ and the adjunction   , these maps induce a coaugmentation
A : (A)  C(A[u±1])
in AlgZ.
4.3. Equivariant mapping spaces. Let still A  AlgGm be given. Observe: if we know that    is an adjoint equivalence, then the grading on A must be such that
Ad  AlgZ(Z[x(d)], (A))  AlgGm ((Z[x(d)]), A)
We will show that AlgGm ((Z[x(d)]), A) is indeed a model for Ad, by showing that it is a limit of C(A(d)), which generalizes the classical picture by Remark 4.2.1.
Proposition 4.3.1. For any A in AlgGm and d  Z, the coaugmentation A,d : AlgGm((Z[x(d)]), A)  C(A(d)) is limiting in S.
To show this, we want to describe the mapping spaces in AlgGm as a certain end, which will be a limit over a twisted arrow category. Let us recall the terminology and result.
For a 1-category I, the twisted arrow category T (I) of I is the 1-category where the objects are arrows x  y in I, and a morphism from x  y to x  y is a pair of morphisms x  x, y  y which make the obvious `twisted' square commute. More abstractly, T (I) is the category of elements of the functor I(-, -) : Iop × I  Set.
21

Lemma 4.3.2. Let I be a 1-category. For F, G : I  C two I-indexed diagrams in a category C, the mapping space CI (F, G) is the limit of the diagram
T (I)  S : (x  y)  C(F (x), G(y))

Proof. See e.g. [GHN20].

Proof of Proposition 4.3.1. Write C(Z[x(d)]) for the cosimplicial diagram associated to (Z[x(d)]). Observe that

AlgGm ((Z[x(d)]), A) = Alg C(Z)/(C(Z[x(d)]), C(A)) = Alg(C(Z[x(d)]), C(A)) ×Alg(C(Z),C(A)) {C(Z)  C(A)}

Now we apply Lemma 4.3.2 to the mapping spaces Alg(-, -). Using that limits commute past each other, it holds that

AlgGm ((Z[x(d)]), A)  lim H
[n][m]T ()

for the functor H that sends the object [n]  [m] in T () to

(4.2)

Alg(Cn(Z[x(d)]), Cm(A)) ×Alg(Cn(Z),Cm(A)) {Cn(Z)  Cm(Z)}  Alg(Z[x(d)], Cm(A))  Alg(Z[x], A[t±1 1, . . . , t±m1])

We will now describe what H does on morphisms.
Let a morphism  in T () from 1 : [n1]  [m1] to 2 : [n2]  [m2] be given by maps  : [n2]  [n1] and  : [m1]  [m2]. For i = 1, 2, let i be the map in
T () from id[mi] to i determined by i. Also, let  be the map from 1 to 1 determined by , and let  be the map from 1 to 2 determined by . This gives
a factorization   = . Observe that H(i) is determined by precomposing a given map Cmi(Z[x(d)]) 
Cmi (A) with the map (i) : Cni(Z[x(d)])  Cmi(Z[x(d)]). Likewise, H() is given by precomposition with  : Cn2 (Z[x(d)])  Cn1 (Z[x(d)]), and H( ) by postcomposition with  : Cm1 (A)  Cm2 (A).
The map H(i), when considered as map Cmi(A)  Cmi(A) by (4.2), is given by multiplying with tm i(i0), which is invertible. We can thus define a diagram H : T ()  S that sends  : [n]  [m] to H(id[m]), and any map  : 1  2 to H(2)-1H()H(1), with notation as before. Then lim H  lim H.
Now let p be the functor T ()   that sends [n]  [m] to [m]. Consider H() as map Cm1 (A)  Cm2 (A). Then it holds

H()  H(2)-1  H( )  H()  H(1)

 (×t-m22(0))  C(A)()  (×tm(10))  (×tm 11(0))
 C(A)() × tm (20)+1(0)-2(0) = C(A)() × tm -2(0) = C(A(d))()
The precomposition of C(A(d)) :   S with p is thus homotopic to H. We claim that the functor p is final, meaning that composition with p does not
change limits. By [HTT, Prop. 4.1.3.1], it suffices to show that p/[m] is contractible, for any m  0. We write objects of p/[m] as [n1]  [m1]  [m]. Consider the functor F : p/[m]  p/[m] that sends [n1]  [m1]  [m] to [n1]  [m] = [m]. Then there is a natural transformation idp/[m]  F , and the essential image of F is equivalent to /[m]. It thus suffices to show that /[m] is contractible, which is clear.
It now follows that lim H  lim C(A(d)). This equivalence identifies f  AlgGm ((Z[x(d)]), A)  lim H with the point in lim H given by the family {n}n, where n is the composition
n : Z[x(d)]  Cn(Z[x(d)]) -f-n Cn(A)

22

The equivalence is thus compatible with the coaugmentation, which remained to be shown.

4.4. From graded rings to affine Gm-schemes is fully faithful.

Proposition 4.4.1. The unit  : idAlgZ   is invertible.

Proof. Let B in AlgZ be given, and consider the map B : B  (B). Since we can check the statement degree-wise, by adjunction it suffices to show that

F : AlgZ(Z[x(d)], B)  AlgGm ((Z[x(d)]), (B))

is an equivalence, for fixed d  Z.

Write C(B) for the cosimplicial diagram associated to (B), let C(B(d)) be the

d-th twist of (B), and let G be the coaugmentation (B),d from Proposition 4.3.1. We will see that F is a map of limiting coaugmentations, one of which is G. In other

words, we will give a limiting coaugmentation H : AlgZ(Z[x(d)], B)  C(B(d))

which commutes with F and G.

Taking a model of B, we assume that B is a simplicial graded ring. Consider the

obvious coaugmentation H : Bd  C(B(d)), which is just the inclusion Bd  B. Observe that GF  H. Indeed, since Z[x(d)] is cofibrant in AlgZ and any object

in AlgZ is fibrant, the mapping spaces AlgZ(Z[x(d)], Cn(B[u±1])) can be computed

as underived mapping spaces. Now GF sends a point b  Bd represented by a morphism Z[x(d)]  B to the map Z[x(d)]  B[u±1] given by x(d)  bu-d. It follows that GF = H.

We claim that H is limiting. To this end, consider the Bousfield-Kan spectral se-

quence for computing the homotopy groups of lim C(B(d)). This spectral sequence

has Eu2v = u(vC(B(d))) on the second page. Here, for a cosimplicial abelian group P we write u(P ) for the u-th cohomology group of the cochain complex

P 0  P 1  . . . with differentials n : P n  P n+1 given by n =

n i=0

(-1)idi.

Let v be given. Write P for the cochain complex associated to the cosimplicial

abelian group vC(B(d)). We identify P n with v(B)[t1±1, . . . , t±n 1]. We write the

cochain complex which has v(Bd) concentrated in degree 0 simply as v(Bd).

The projection v(B)  v(Bd) induces a map P  v(Bd), and the inclusion

v(Bd)  v(B) induces a map v(Bd)  P . We will show that the composition

z : P  v(Bd)  P is homotopic to the identity on P . This implies that the

spectral v lim C

sequence (B(d)) =

degenerates and that E02v = v(Bd). Together v(Bd), which will thus finish the proof.

this

implies

that

We will give maps n : P n  P n-1 of abelian groups for n  0, where P -1 := 0,

which satisfy  +  = id -z. We define n on an element of the form betk11 · · · tknn ,

with be  v(B) homogeneous of degree e, as

n(betk11 · · · tknn ) =

betk11

·

·

·

tkn-1
n-1

0

if e - d = kn otherwise

Since P n = e v(Be)[t±1 1, . . . , tn±1], this gives a unique well-defined map. To check that  +  = id -z, let p = btk11 · · · tknn  P n be given, with n  1.
Without loss of generality, assume that b is homogeneous of degree e. Observe that
n(p) = b(tk11 · · · tknn tne-+d1 - tk11 · · · (tntn+1)kn + · · · + (-1)n+1tk21 · · · tknn+1)
We have a similar description for n-1. Now a case distinction on whether e-d = kn shows that (n-1n + n+1n)(p) = p = (id -z)(p).
For b  P 0 homogeneous of degree e, it holds that

(-10 + 10)(b) = 10(b) = 1(bte-d - b) = (id -z)(b)

which again follows from a simple case distinction on whether d = e.
23

Proposition 4.4.1 implies that  is fully faithful. From here on, we thus consider AlgZ as a full subcategory of AlgGm . In particular, we will omit  from our notation when convenient. Then we can describe  as the restricted Yoneda embedding. Indeed, for A  AlgGm , we have that (A) = AlgGm(-, A) as presheaves on PolyZ, by adjunction.
4.5. From affine Gm-schemes to graded rings is conservative. Let us briefly consider the classical setting. Let A be a discrete ring with Gm-coaction. Then we have a diagram A[u±1]  A[u±1, t±1], where one map is induced by the diagonal Gm-action on Spec A × Gm and the other map is the inclusion. This is a diagram of graded rings, with u in degree -1. The limit of this diagram in the category of discrete, graded rings is the graded ring associated to A.
We have a similar description available in the derived setting, which will imply that  is conservative. For this, we need Gm-coactions on Z-graded rings. To this end, consider C(Z) as diagram in AlgZ by endowing it with the trivial grading. Identify the category AlgZ(BGm) with the category of those cosimplicial diagrams in AlgZ under C(Z) that, after forgetting the grading, give diagrams corresponding to Gm-coactions. In other words, AlgZ(BGm) is the fibre product of the inclusion AlgGm  Fun(, Alg)C(Z)/ with the functor Fun(, AlgZ)C(Z)/  Fun(, Alg)C(Z)/ induced by the forgetful functor U : AlgZ  Alg, and is thus a full subcategory of Fun(, AlgZ)C(Z)/.
Example 4.5.1. For A  AlgGm the object C(A[u±1]), that has u in degree -1, lives in AlgZ(BGm).
Lemma 4.5.2. The functor  is equivalent to the composition of the functor C(-[u±1]) : AlgGm  AlgZ(BGm) with lim : AlgZ(BGm)  AlgZ.
Proof. For A  AlgGm , the coaugmentation of Z-graded rings A : (A)  C(A[u±1]) from Definition 4.2.4 is limiting. Indeed, applying AlgZ(Z[x(d)], -) to A yields the limiting coaugmentation of spaces A,d from Proposition 4.3.1. Since all the A,d are also natural in A, the map A is natural in A, whence the claim follows.
Recall that for  : BGm  Spec Z the structure map, the adjunction    : Alg  Alg(BGm) corresponds to the adjunction Alg  AlgGm, where the left adjoint endows a ring with trivial action and the right adjoint is taking invariants.
Lemma 4.5.3. The functor  : AlgZ(BGm)  AlgZ is homotopic to the functor lim : AlgZ(BGm)  AlgZ. Likewise,  : Alg(BGm)  Alg is homotopic to lim : Alg(BGm)  Alg.
Proof. Write C for the category Fun(, AlgZ)C(Z)/, and let F : AlgZ  C be the functor which sends B  AlgZ to the cosimplicial diagram B  B[t±] . . . of Zgraded B-algebras corresponding to the trivial Gm-coaction on B.
The functor F is left adjoint to lim : C  AlgZ. Indeed, for B  AlgZ and C  C, by purely formal arguments, it holds that
C(F B, C)  Fun(, AlgZ)(B, C)  AlgZ(B, lim C)
where B is the constant diagram. Now  endows a Z-graded ring with trivial Gm-coaction. Thus the composition
of  with the inclusion AlgZ(BGm)  C is F . From    and F  lim it follows that  is the restriction of lim to AlgZ(BGm).
The argument that  : Alg(BGm)  Alg is lim : Alg(BGm)  Alg is the same.
24

Write U : AlgZ  Alg and V : AlgGm  Alg for the forgetful functors. Proposition 4.5.4. The functor  commutes with U and V . Proof. Consider the following diagram

AlgGm C(-)[u±1] AlgZ(BGm)  AlgZ

C (-)[u±1 ]

U

U

Alg(BGm)  Alg

It is clear that the triangle on the left commutes. The square on the right commutes by Lemma 2.4.7. Now b y Lemma 4.5.2 and 4.5.3, the composition of the top arrows is , and the composition of the diagonal arrow with the bottom arrow is V .

Corollary 4.5.5. The functor  is conservative, and hence    is an adjoint equivalence.
Proof. Since V is conservative, the first statement follows from U   V . Now the second statement is purely formal: since the unit is invertible by Proposition 4.4.1, it suffices to show that the map (A) : (A)  (A) induced by the counit is invertible, for any A  AlgGm . By adjunction, we have id(A)  (A)  (A). Since (A) is invertible, the claim follows.

4.6. Globalizing the adjoint equivalence   . Consider now the adjunctions

Alg triv AlgZ  AlgGm

(-)0



where triv  (-)0 is the adjunction from Example 2.3.5 induced by j : 0  Z. By composing, we recover the adjunction    from Example 3.4.4.

Lemma 4.6.1. We have equivalences AlgGRm,R  AlgGm ×Alg AlgR, for any ring R, where the fibre product is taken with respect to .

Proof. Write C(R) for the cosimplicial diagram associated to R endowed with the trivial coaction. Observe that AlgGRm,R is then the under-category (AlgGm )C(R)/. The equivalence follows from the adjunction   , by [RV18, Prop. 4.1.1].

Theorem 4.6.2. For any scheme S, we have an adjoint equivalence S  S : AlgZ(S)  AlgGm,S (S)
For S = Spec R we write S  S as R  R.

Proof. The case S = Spec R follows from Lemma 4.6.1 and the case S = Spec Z. This also shows that the adjunctions R  R are natural in R  Alg. Then, for general S, we write AlgZ(S) and AlgGm,S (S) as a limit of the categories AlgZR and AlgGRm,R , indexed over all maps Spec R  S by Definition 2.4.1 and Remark 3.4.3.

The proof shows that S  S is natural in S. We will henceforth identify the functor AlgZ(-) with AlgGm (-).
25

4.7. Graded algebras as Gm-comodules. We record a result which is interesting in its own right, concerning an application of the Barr­Beck­Lurie theorem as in [HA, §4.7]. Since we will not use the result in what follows, we will not unpack all definitions from [HA] that we use.
Recall that a monad on a category C is an algebra object T in the monoidal category Fun(C, C) under composition. For such T , we let ModT (C) be the category of left T -modules. The objects of ModT (C) are objects c  C together with a homotopy coherent action T (c)  c.
Let F : C  D : G be a given adjunction. Then T := GF is a monad on C, and G factors as G : D  ModT (C) followed by the forgetful functor ModT (C)  C. Now F  G is called monadic if G is an equivalence.
The Barr­Beck­Lurie theorem says that F  G is monadic if and only if G is conservative and geometric realizations of G-split simplicial objects exist in D and are preserved by G. Here, a G-split simplicial object X : op  D means that GX has a contracting homotopy in C.
Consider the adjunction U  (-)[t±1] : AlgZ(S)  Alg(S) from Example 2.3.5 induced by the map j : Z  0, where U is the forgetful functor. This corresponds, under the adjoint equivalence S  S, to the adjunction    : AlgGm,S (S)  Alg(S) from Example 3.4.4. Taking opposites on both sides gives us the adjunction
(-) × Gm  V : Aff(S)  AffGm,S (S)
where V is the forgetful functor.
Lemma 4.7.1. The adjunction (-) × Gm  V is monadic.
Proof. Clearly V is conservative, so by the Barr­Beck­Lurie theorem it suffices to show that V preserves V -split geometric realizations. So let Y· be a V -split simplicial diagram in AffGm,S (S).
Let Y be the colimit of Y· in StG/Sm,S . Since colimits commute past each other, we have
[Y /Gm,S] = [colim Y·/Gm,S]  colim[Y·/Gm,S]
Also, since colimits in St/S are universal, the map
colim([Y·/Gm,S] ×BGm,S S)  colim([Y·/Gm,S]) ×BGm,S S
is an equivalence, where the colimits are taken in St/S . We thus have an equivalence
(4.3) g : colim Y·  colim([Y·/Gm,S] ×BGm,S S)  [Y /Gm,S] ×BGm,S S  Y
where again the colimit is taken in St/S, after forgetting the Gm,S-action on Y· and on Y .
Now let Y-1 be the colimit of V Y· in Aff(S). After forgetting the Gm,S-action on Y· and Y , we have a morphism h : Y-1  Y under Y· in St/S. Now since Y· is V -split, Y·  Y-1 is colimiting in St/S. Also, Y·  Y is colimiting in St/S by (4.3). It follows that h is an equivalence. Consequently, Y is affine over S and is thus the colimit of Y· in AffGm,S (S), from which the claim follows.
5. Projective spectra
Throughout, let B be an N-graded, quasi-coherent OS-algebra on a scheme S, with underlying N-graded OS -module d Bd, such that 0B is generated as a 0OSalgebra by 0B1, locally on S. We refer to this latter condition by saying that B is generated in degree 1.
The goal of this section is to define the projective spectrum Proj B and show that it is representable by a scheme. After this, we want to give a description of the functor of points of B. This will lead us to recover the universal line bundle on
26

Proj B, for which we will first need Serre's twisting sheaf, which in turn is based on the exact functor (-) from graded, quasi-coherent B-modules to quasi-coherent OProj B-modules.
Remark 5.0.1. The assumption that B is generated in degree 1 will give us a nice affine cover of Proj B of the form Spec B(f), for f homogeneous of degree 1. It is also used in the proof of Lemma 5.4.2, where we show that the twisted modules OProj B(n) are invertible. As in the classical case, the assumption is not as strict as it may seem.
For   N and R  Alg, let  be the functor PolyZR  PolyZR that sends R[x(d1), . . . , x(dk)] to R[x(d1), . . . , x(dk)]. Precomposing with  gives us a functor
AlgZR  AlgZR : B  B()
where Bd() = Bd. Since this is natural in R, we get a functor AlgZ(S)  AlgZ(S) : B  B(), where again Bd() = Bd
Now suppose that B is an N-graded, quasi-coherent OS-algebra such that 0B is a finitely generated 0OS-algebra. For simplicity, assume that S is affine. Then there is some   N such that B() is generated in degree 1, and we simply define Proj B as Proj B(). To see that this agrees with the classical case, see e.g. [GW10, Rem. 13.11]. This strategy can be extended to quasi-compact S by taking a finite cover of affine subschemes.
5.1. Construction and representability. Recall from §2.8 that we defined the irrelevant ideal of B as B+ = n>0 Bn, which comes with a fibre sequence B+  B  B0. The closed immersion Spec B0  Spec B is written as V (B+)  Spec B.
The Gm,S-action on Spec B restricts to a Gm,S-action on Spec B V (B+). Indeed, the pullback along V (B+)  Spec B of the action Spec B ×S Gm,S  Spec B is V (B+) ×S Gm,S  V (B+), since B  B0 is a homogeneous map. Therefore (Spec B V (B+)) ×S Gm,S  Spec(B) lands in Spec B V (B+).
Definition 5.1.1. The relative projective spectrum Proj B of B over S is the stack [(Spec B V (B+))/Gm,S] defined over S.
We are going to show that the relative projective spectrum is a scheme. We want to argue locally, for which we need that the projective spectrum commutes with pullbacks. Note that, for given g : T  S, the pullback g : AlgZ(S)  AlgZ(T ) maps N-graded objects to N-graded objects, and is such that (gB)0  g(B0).
Lemma 5.1.2. The Proj-construction is stable under pullbacks. That is, if g : T  S is given, then Proj gB  Proj B ×S T .
Proof. We have that V ((gB)+)  Spec gB0  V (B+) ×S T , since the relative spectrum commutes with pullbacks. From the pasting lemma for pullbacks, it follows that V (gB+)  Spec gB ×Spec B V (B+). We then get
Proj gB = [(Spec gB V (gB+))/Gm,T ]  [g(Spec B V (B+))/gGm,S]  Proj B ×S T
For the last equivalence we have used that g : St/S  St/T commutes with quotient stacks. Indeed, g commutes with all colimits since colimits in topoi are universal.
Theorem 5.1.3. Proj B is representable by a scheme over S.
Proof. Since being schematic is local, by Lemma 5.1.2 we may assume that Spec B  S corresponds to a map R  B in Alg with B a graded R-algebra.
27

Note that {Spec Bf | f  B1} is an open cover of Spec B V (B+) by equivariant

maps, and thus that {[Spec Bf /Gm,S] | f  B1} is an open cover of Proj B, as holds

in general for such a situation. It thus suffices to show that [Spec Bf /Gm,S] 

Spec B(f). And Gm,S-action on

indeed this holds, by Lemma Spec Bf = Spec B(f) ×S Gm,S

2.7.4 and the fact that the diagonal is given by only acting on Gm,S.

Notation 5.1.4. From here on, write Proj B and its structure map as Y := Proj B - S

Affine-locally on S, we write D+(f ) for the affine open subsets of the form Spec B(f)  Y , for f a homogeneous point in B of degree 1.

5.2. Functoriality. We will show that the derived Proj construction has familiar functorial behaviour. First we record:

Lemma 5.2.1. The underlying classical scheme of Proj B is the classical projective spectrum of 0B over Scl. When S, B are classical, then so is Proj B.
Proof. Using the gluing description of Proj, it suffices to observe that for a graded A-algebra B, A  Alg, and f  B1, we have 0(B(f))  0(B)(f), where we have written the connected component containing f just as f  0B. The second claim also follows from the local picture.

Now let  : B  B be a morphism of graded OS-algebras. Let U () be the open complement of the fibre product
F := Spec B ×Spec B V (B+)
Since V (B+ )  Spec B factors through F , it holds that U () is contained in Spec B \V (B+ ). The induced map U ()  Spec B \V (B+) is moreover equivariant, so we get a morphism
Proj() : [U ()/Gm]  [(Spec B \ V (B+))/Gm]
If  is a surjective map, then U () is all of Spec B \ V (B+ ). If B, B are generated in degree 1, we thus in this case get a morphism
Proj() : Proj B  Proj B

5.3. Graded B-modules. By Remark 2.6.2, we can consider B as an algebra object in the symmetric monoidal category cnQCohN(S), and therefore as an algebra
object in QCohZ(S).

Definition 5.3.1. The category GrModB of graded, quasi-coherent B-modules is the category of modules in QCohZ(S) over B. Such a module is connective if the underlying Z-graded OS-module is connective. We write cnGrModB for the category of connective objects in GrModB.
Remark 5.3.2. Informally, a graded, quasi-coherent B-module is thus a quasicoherent module M over the underlying algebra of B, together with a decomposition M  dZ Md in QCoh(S), such that the maps Bd OS Me  M factor through Md+e for all d, e, in a homotopically coherent way.
The category GrModB is stable by [HA, Prop. 7.1.1.4]. Furthermore, it is symmetric monoidal by [HA, Thm. 4.5.2.1], where the monoidal structure is given by the relative tensor product (-) B (-), which preserves colimits in each variable separately by [HA, Cor. 4.4.2.15].
We will sketch the construction of a functor
cnGrModB  cnQCoh(Y ) : M  M
28

We first give a local description of M for given M  GrModB. Take an open immersion Spec R  X, and let B  AlgZR correspond to the pullback of B to Spec R. Then Proj B  Proj B ×X Spec R has an affine open cover by schemes of the form Spec B(f), where f  B1. On such Spec B(f), the module M is given by M(f), where M is the pullback of M to Spec R, and M(f) is the degree-zero part of Mf := M B Bf .
In the classical case, it is not hard to see that this local description glues into a quasi-coherent OY -module M, functorial in M. One can use the Grothendieck construction in the derived setting. Recall that this entails an equivalence, for any category C, between Fun(C, Cat) and the category of coCartesian fibrations over C. See e.g. [BS18] for an exposition. For a given functor F : C  Cat, we write the associated coCartesian fibration as F  C.
Let A be the category AlgN(-) associated to the functor Alg  Cat that sends R to AlgNR. Then objects of A are pairs (R, B) with R  Alg and B  AlgNR. A morphism (R, B)  (R, B) consists of a ring map R  R and a map of N-graded R-algebras B R R  B.
Likewise, let X be the category cnGrMod(-). Observe that X has as objects triples (R, B, M ), where (R, B)  A and M  cnGrModB. A morphism (R, B, M )  (R, B, M ) is a map (R, B)  (R, B) in A together with a morphism M B B  M  in GrModB .
Now let A0 be the category (AlgN(-)) associated to the functor Alg  S that sends R  Alg to the core (AlgNR) of AlgNR (obtained by discarding non-invertible morphisms). This is the subcategory of A spanned by all objects, and by those morphisms (R, B)  (R, B) for which the induced map B R R  B is an equivalence. Consider the functor A0  Cat that sends (R, B) to cnQCoh(Proj B), where we temporarily write Proj B for [(Spec B \V (B+))/Gm], even though this might not be a scheme. Observe that this is well-defined by §5.2, since for (R, B)  (R, B) in A0 we have a morphism f : Proj B  Proj B, hence f  : cnQCoh(Proj B)  cnQCoh(Proj B). Write then Y0 for cnQCoh(Proj(-)).
There is a functor F : X0  Y0 that sends (R, B, M ) to (R, B, M ), where the local description of M  is as above. This can be formalized by reducing to the case where (R, B, M ) is of the form R = Z[t1, . . . , tk], B = R[x(d1), . . . , x(dn)], and M a finite direct sum of shifted copies of B, i.e. graded B-modules B(e) for which B(e)d = Bd+e. This strategy is similar to the one used in [SAG, §25.2.1]. We omit details.
The functor F sends coCartesian edges to coCartesian edges. We thus get functors F(R,B) : GrModB  QCoh(Proj B), natural with respect to pairs (R, B)  A. To globalize this to schemes, let A0 be the category of pairs (S, B), where S is a scheme and B  AlgN(S). Morphisms are defined as in A0. Now the functor cnGrMod(-) on A0 is the right Kan extensions of its restriction to A0; the same holds for cnQCoh(Proj(-)). The functors F(R,B) thus induce a functor cnGrModB  cnQCoh(Proj(B)), written M  M, natural in (S, B)  A0, which is locally given by F(R,B).
Remark 5.3.3. Evaluating at affine opens of the form Spec B(f) shows OY  B.
Proposition 5.3.4. The functor cnGrModB  cnQCoh(Y ) : M  M is exact.
Proof. Since the question is local, it suffices to show that
cnGrModB  cnModB(f) : M  M(f)
is exact, for any graded R-algebra B and f  B1. Since the functor cnGrModB  cnGrModBf : M  Mf is exact by [HA, Cor. 4.4.2.15], we only need to show that
29

cnGrModBf  cnModB(f) : M  M0 is exact. For this, in turn, it suffices to show that the functor

H : GrModBf  ModB(f) : M  M0

is exact and t-exact.
We have an adjunction triv  (-)0 : ModB(f)  GrModB(f) , where triv endows a B(f)-module with the trivial grading. The functor

ModB(f)  GrModBf : N  triv(N ) B(f) Bf

is then that H

a left adjoint to H. Since is exact. Now t-exactness

GrModBf and ModB(f) are both follows from the fact that n(Md

stable, it ) = n(M

follows )d.

5.4. Serre's twisting sheaf. For n  Z, let B(n) be the graded B-module such that B(n)d = Bn+d. Then put OY (n) := B(n), which is the derived version of Serre's twisting sheaf.

Remark 5.4.1. Let B be a graded ring. With similar machinery as in §4.1, we could endow B(n) with a Gm-coaction, which gives us a cosimplicial module that has C(B(n)) as underlying cosimplicial space. This justifies the terminology from Definition 4.2.3, but is not needed in what follows.
Recall, from §2.5, that Z is the symmetric monoidal category associated to the monoid (Z, +).
Lemma 5.4.2. The modules OY (n)  QCoh(Y ) are invertible, and induce a lax symmetric monoidal functor OY (-) : Z  QCoh(Y ) for which the maps OY (n)  OY (m)  OY (n + m) are invertible.
Proof. The first claim is local, so we reduce to a graded R-algebra B. We claim that the D+(f ) for points f  B1 form a trivializing open cover for OY (n). To see this, consider the B-module homomorphism ×f n : B  B(n), which gives an equivalence Bf  B(n)f . Moreover, this equivalence preserves the grading, and thus gives an equivalence B(f)  B(n)(f). It follows that OY (n) is a line bundle.
For the existence of the functor OY (-), as in §2.6, it suffices to give a Z-graded OY -algebra of the form nZ OY (n). We sketch the argument for why such an algebra exists.
Recall the category A0 of pairs (R, B) from 5.3. Let Z be the category of triples (R, B, C), where (R, B)  A0 and C  AlgZ(Proj B). As in the construction of (-), we can define a functor

A0  Z : (R, B)  R, B, nZ OProj B(n)
by defining this functor in the case where the object (R, B)  A0 is of the form (Z[t1, . . . , tk], R[x(d1), . . . , x(dn)]), which is straightforward. By right Kan extending this functor to schemes, we indeed get a Z-graded OY -algebra nZ OY (n).
For the third claim we observe that the dual of OY (n) is OY (n) = OY (-n). Upon tensoring the map h : OY (n) OY (m)  OY (n + m) with OY (-n) we obtain the identity on OY (m). It follows that h is invertible.
5.5. Functor of points. In the classical case, we know that Proj B represents the functor that assign to a (classical) scheme f : T  S over S the set of equivalence classes of pairs (L, ), where L is a line bundle on T and  is a map f B 
n0 Ln of graded OT -algebras such that f B1  L is surjective. Here, two such pairs (L, ) and (L, ) are equivalent if there is an isomorphism of Z-graded f B-algebras n0 Ln = n0(L)n. See e.g. [Stcks, Tag 01O4].
30

The goal of this section is to give a similar description in the derived setting. We thus want to make sense of graded algebras which are of the form nN Ln, for some line bundle L. We do this as follows.

Definition 5.5.1. Let X be a stack and A an N-graded, quasi-coherent OX-algebra. We say that A is freely generated by a line bundle if the canonical map OX  A0 is invertible, A1 is a line bundle on X, and the canonical maps A1 n  An are equivalences for all n  N.

Remark 5.5.2. Let A be an N-graded, quasi-coherent OT -algebra on a scheme T . We argue that A is freely generated by a line bundle L if and only if A is equivalent to Sym L.
Let first A be freely generated by a line bundle L  A1. Then the inclusion L  A induces an N-graded map Sym L  A by Lemma B.5.1. We claim that this is an equivalence. Since we can check this locally, we may assume that L is free and that X is affine, say X = Spec A, L = A. Then the map Sym(L)n  An is equivalent to the map (At)n  An, which is an equivalence.
The converse, that Sym(L) is freely generated by L, is again straightforward to check locally.
Lemma 5.5.3. Let  : X  X be a morphism of stacks and A an N-graded OX-algebra. If A is freely generated by a line bundle, then so is A.

Proof. Use that structure sheaves, line bundles and tensor products pull back, together with commutativity of the diagrams

AlgN(X)  AlgN(X)

(-)n

(-)n

cnQCoh(X)  cnQCoh(X)

where the vertical arrows are induced by the forgetful functors AlgN(-)  cnQCohN(-) and the functors (-)n : cnQCohN(-)  cnQCoh(-).
Example 5.5.4. Consider the projection map  : S  BGm,S. Since  is affine, it holds S = Spec OS. In fact, OS is a Z-graded OBGm,S -algebra such that (OS)0 is freely generated by a line bundle. Indeed, since S  BGm,S is the pullback of  : Spec Z  BGm, by Lemma 5.5.3 it suffices to check the statement on . In this case it follows from the fact that  is the universal Gm-torsor in the classical sense, since a Gm-torsor on a classical scheme U is locally of the form U × Gm.
Let Y : Scho/pS  S be the following functor. For  : T  S we let Y() be the space of maps B  M of N-graded OT -algebras, such that M is freely generated by a line bundle, and such that B1  M1 is surjective. Thus, Y is a sub-presheaf of
Scho/pS  S ( : T  S)  (AlgN(T )B/)
where (-) means that we discard non-invertible morphisms.
Proposition 5.5.5. The functor Y is the functor of points of Y = Proj(B).
Proof. Let  : T  S be given. We know that Y (T ) is the space of commutative squares
31

P

Spec B V (B+)

T



S

where P  T is a principal Gm,S-bundle and P  Spec B V (B+) is Gm,Sequivariant.
Recall that P  T is a pullback of S  BGm,S. Therefore, by Lemma 5.5.3 and Example 5.5.4, the bundle P  T is classified by a Z-graded OT -algebra A such that P  Spec A, and such that A0 is freely generated by a line bundle.
The composition  : P  Spec B V (B+)  Spec B is equivariant, and thus corresponds to a graded map B  A which, by Example 2.4.5, factors through
A0 since B is N-graded. Now the claim is that  landing outside V (B+) is exactly the condition that B  A0 induces a surjection B1  A1.
To see this, consider the following diagram of pullback squares in Sch

Q

Spec B0

Spec B0

Spec A

Spec B

Spec B

Observe that Q  Spec(A B B0) over T . Since V (B+)  Spec B0, we thus have to show that Q =  if and only if B1  A1 is surjective. But Q =  if and only if Qcl = , so the statement follows from the classical case.
Remark 5.5.6. The identity on Y is classified by the principal Gm,S-bundle P = Spec B \ V (B+) over Y , which gives us that P = Spec A for a Z-graded OY -algebra A by Example 5.5.4. The functor of point description of Y gives us a map  :  B  A0, which is universal in the sense that  : T  Y corresponds to the T -point of Y given by pulling back  along .
We can now also make sense of OY (1) as the universal line bundle. In fact, the underlying Z-graded OY -module of A is dZ OY (d). To see this, observe that on an affine patch of the form Spec B(f)  Y we have
OY (d)(D+(f )) = (Bf (d))0 = (Bf )d = Ad(D+(f ))
where the last equality follows from P = Spec B \ V (B+) and the proof of Theorem 5.1.3.

Example 5.5.7. Let us compare our functor of points description of Proj B with the classical one. So suppose that S, B are classical, and let f : T  S be a scheme over S, also classical. Write Y for the functor described in [Stcks, Lem. 01O4]. We will see that Y and Y are equivalent.
As we shall see below in Lemma 5.2.1, it holds that Proj B is classical. Thus Y(T ) is 0-truncated. It thus suffices to show 0Y(T ) = Y(T ).
Any line bundle on T is classical, since T is. Hence Sym L is classical, for any line bundle L on T , by [SAG, Cor. 25.2.3.2]. Thus a morphism f B  M in AlgN(T ) where M is freely generated in degree 1 by a line bundle L is equivalent to a morphism 0f B  d0 Ld of discrete N-graded OT -algebras. Now two such f B  M and f B  M are equal in 0Y(T ) if and only if there is a graded OT -algebra isomorphism M  M under f B. This gives 0Y(T ) = Y(T ), as we wanted.
Example 5.5.8. We return to the derived scheme S. Let E  QCoh(S) be locally free of finite rank. Recall that the projective bundle of E over S is defined as the scheme PS(E) with the following functor of points. For f : T  S, it holds that
32

PS(E)(T ) is the space of pairs (L, ), with L  Pic(T ) and  : f E  L a surjective map of OT -modules. Such a map is equivalent to a graded map f  Sym E  Sym L which is surjective in degree 1, and hence PS(E)  Proj(Sym E).
6. The Rees algebra of a closed immersion
The goal of this section is to describe the (extended) Rees algebra of a closed immersion, which will be our input for defining blow-ups in the next section.
The strategy will be as follows. For any given map Z  X, we will define a stack DZ/X over A1X with a Gm,X action which satisfies a universal property closely related to the one described for the classical case in §6.11. Then we will show that for Z  X a closed immersion, DZ/X is representable by a scheme affine over A1X .
The stack DZ/X will be defined using Weil restrictions, which we will first review. The advantage of this approach is that D(-)/X is functorial by construction, which will allow us to work locally when checking representability in the proof of Theorem 6.3.3.
6.1. Weil restrictions. We recall the relevant theory on Weil restrictions. Let Y  St and X, Z  St/Y . If it exists, we write Map/Y (X, Z) for the in-
ternal mapping object, i.e., an object in St/Y together with an evaluation map e : Map/Y (X, Z) ×Y X  Z such that the induced map
St/Y (T, Map/Y (X, Z))  St/Y (T ×Y X, Z)
is an equivalence, for all T  St/Y . For us, a morphism of stacks f : X  Y is affine if for all Spec A  Y the
fibre product XA is representable by an affine scheme. If X, Y are algebraic, this coincides with f being affine in the sense of Remark 2.4.3. In general, f being affine implies that it is representable in the sense of [SAG, Con. §19.1.2].5
Example 6.1.1. The map f : BGm  [A1/Gm] induced by the zero section is affine. Indeed, let g : Spec A  [A1/Gm] be given. Pulling back g along A1  [A1/Gm] gives an affine scheme Spec B, where B is a graded algebra endowed with a graded map Z[t]  B. Let b be the image of t in B. Then the pullback of g along f is Spec((B/(b))0).
Proposition 6.1.2 ([SAG, Prop. 19.1.2.2]). Let morphisms X  Y  Z in St be given, with X  Y affine. Then Map/Y (X, Z) exists as a stack.
The proof of this proposition involves two things. First, it is shown that the assignment T  St/Y (T ×Y X, Z) is in fact valued in (small) spaces. Second, it is shown that this is a sheaf.
Proposition 6.1.3 ([SAG, Con. 19.1.2.3]). Let f : X  Y be an affine morphism of stacks. Then the pullback functor f  : St/Y  St/X has a right adjoint, given by
ResX/Y : St/X  St/Y Z  Map/Y (X, Z) ×Map/Y (X,X) Y
We call ResX/Y the Weil restriction along f . When convenient, we write Resf for ResX/Y .
5In fact, the theory of Weil restriction is developed in [SAG, Con. §19.1.2] for representable morphisms, but we do not need this generality.
33

Remark 6.1.4. Let X  Y  Z be morphisms of schemes. Observe that for any scheme f : T  Y , we indeed have that

ResX/Y (Z)(T ) = Map/Y (X, Z)(T ) ×Map/Y (X,X)(T ) Y (T ) = St/Y (T ×Y X, Z) ×St/Y (T ×Y X,X) {f }  St/X (T ×Y X, Z)

In particular, we always have a map ResX/Y (Z) ×Y X  Z over X induced by the identity on ResX/Y (Z).

The following shows that Weil restrictions commute with pulling back.

Lemma 6.1.5. Let f : X  Y and f  : X  Y  be affine morphisms of stacks. Suppose that we are given a commutative square in St

(6.1)

Z

X f Y 

g

Z

XfY

with the square on the right Cartesian. Then the universal property of ResX/Y (Z) induces a map ResX/Y  (Z)  ResX/Y (Z) over Y . If both squares are Cartesian, then this map exhibits ResX/Y (Z) as the pullback of ResX/Y (Z) along g.

Proof. Observe that ResX/Y (Z)(ResX/Y  (Z))  St/X (ResX/Y  (Z) ×Y  X , Z)
Hence, composing the map ResX/Y  (Z) ×Y  X  Z with Z  Z induces a map ResX/Y  (Z)  ResX/Y (Z) over Y , and thus a map
h : ResX/Y  (Z)  ResX/Y (Z) ×Y Y 

Now if both squares in (6.1) are Cartesian, then h is an equivalence. Indeed, for given T   St/Y , it holds that h(T ) is the map St/X (T  ×Y  X, Z)  St(T , ResX/Y (Z)) ×Y (T ) {T   Y }  St/X (T  ×Y X, Z)
which is an equivalence.

6.2. The functor GA. We first describe a functor GA, which is used in the construction of the Rees algebra. It will turn out that this functor GA is right adjoint to taking the Rees algebra when restricted to the appropriate categories.
Notation 6.2.1. For X a scheme and B a Z-graded OX [t-1]-algebra, where deg(t-1) = -1, we write B for the tensor product BOX[t-1]OX of Z-graded OX -algebras, given by the zero section OX [t-1]  OX : t-1  0.
Taking the degree-zero part of the map OX [t-1]  B gives us a canonical map OX  (B)0. This gives us a functor GX : AlgZ(A1X )  Alg(X) which sends B to GX (B) := (B)0. In the case that X = Spec A we write GA := GX .
An object x in a category C is compact if C(x, -) preserves filtered colimits.

Lemma 6.2.2. For any A  Alg, the functor GA preserves filtered colimits.
Proof. The functor GA factorizes as AlgZA[t-1] -(---)-A-[-t--1-]A AlgZA -(---)0 AlgA
Since the first arrow is cocontinuous, it suffices to show that (-)0 preserves filtered colimits.
34

Since the forgetful functor U : AlgA  S is conservative, it suffices to show that the composition U  (-)0 preserves filtered colimits. But this is the functor AlgZA(A[x(0)], -), which preserves filtered colimits since A[x(0)] is compact by
Lemma 2.2.6.

Remark 6.2.3. The functor GA does not preserve all colimits. Indeed, consider the tensor product
A[t-1, u] A[t-1] A[t-1, s]  A[t-1, s, u]
in AlgZA[t-1], where u is in degree -1 and s in degree 1. Then it holds
GA(A[t-1, s, u])  A[su]  A A A  GA(A[t-1, u]) GA(A[t-1]) GA(A[t-1, s])
6.3. Construction. Let Z  X be a closed immersion. Consider X as scheme over A1X via the zero section. Identify A1X with Spec OX [t-1], and endow OX [t-1] with the grading where t-1 is of degree -1.
Write X for the map BGm,X  [A1X /Gm,X] induced by the zero section.
Definition 6.3.1. Define DZ/X via the following pullback square.

(6.2)

DZ/X

ResX ([Z/Gm,X ])

A1X

[A1X /Gm,X ]

We endow DZ/X with the Gm,X-action such that the map DZ/X  ResX ([Z/Gm,X]) induces an equivalence [DZ/X /Gm,X]  ResX ([Z/Gm,X]). If Z  X is of the form Spec B  Spec A, we write DB/A := DZ/X .

Definition 6.3.2. If DZ/X is affine over A1X , then by Theorem 4.6.2 it holds that DZ/X = Spec R, where R is a Z-graded OX [t-1]-algebra. In this case, we call R the extended Rees algebra of Z  X, and write ReZx/tX := R and RZ/X := R0. If Z  X is of the form Spec B  Spec A, then we let RBex/tA and RB/A be the Z-graded A-algebras corresponding to ReZx/tX and RZ/X .

Observe that D(-)/X is functorial on the category of closed immersions Z  X for which DZ/X  A1X is affine. In extension, R(e-xt)/A is functorial on the category of A-algebras B for which Spec B  Spec A is a closed immersion and for which
DB/A is affine over A1A. The main goal of this chapter is to show the following:

Theorem 6.3.3. The stack DZ/X is affine over A1X .

Observe that the question is local on X. We will therefore for now assume that Z  X is of the form Spec B  Spec A, where A  B is a surjective ring map.
Throughout, we endow Z with trivial Gm,X-action. As such, it holds that [Z/Gm,X]  Z × BGm. We will stick to the notation [Z/Gm,X] to emphasize that this stack lives over [X/Gm,X] = BGm,X .
Let Q be a Z-graded algebra over A[t-1], and write T := [Spec Q/Gm,X]. We make the following key observation:

(6.3)

StGm,X
/A1X

(Spec

Q,

DZ/X )



St/[A1X /Gm,X ](T ,

ResX ([Z/Gm,X ]))

 St/BGm,X (T ×[A1X /Gm,X ] BGm,X , [Z/Gm,X ])

 AlgZA(B, Q)

 AlgA(B, GA(Q))

35

We used the universal property of the Weil restriction mentioned in Remark 6.1.4, and the fact that taking the zeroth degree of a graded algebra is right adjoint to the functor that endows an algebra with trivial grading.
Remark 6.3.4. The question of representability of mapping stacks and of Weil restrictions has a history of different incarnations. We mention one that seems closest to our situation.
In [HLP19, Prop. 5.1.14] the following is shown. For a flat morphism  : X  Y of algebraic stacks, satisfying a formal requirement generalizing properness, with Y Noetherian, the Weil restriction Res(Z) is affine over Y for Z affine over X.
In our case, we are interested in a Weil restriction Res(Z) where  is not flat, namely where  is the map BGm,X  [A1X /Gm,X]. Without the flatness assumption, [HLP19] only gives us results on the question of algebraicity of Res(Z), meanwhile we are interested in affineness. Our approach is thus independent of theirs.
Definition 6.3.5. Write HB for the functor AlgZA[t-1]  S that sends Q to AlgA(B, GA(Q)).
Remark 6.3.6. Observe that HB is corepresentable if and only if HB preserves limits and -filtered colimits for some regular cardinal  by [HTT, Prop. 5.5.2.7].
Lemma 6.3.7. The functor HB is corepresentable by a Z-graded A[t-1]-algebra R if and only if DB/A is affine over Spec A[t-1], in which case DB/A  Spec R.
Proof. This follows from the observation made in (6.3).
Corollary 6.3.8. Suppose that B is compact in AlgA. Then DB/A is affine over Spec A[t-1] if and only if HB preserves limits.
Proof. Combine Remark 6.3.6 with Lemma 6.3.7 and the fact that GA(-) preserves filtered colimits by Lemma 6.2.2.
We will first do two separate cases of the proof of Theorem 6.3.3. We will then do the general case in §6.6.
6.4. Rees algebra of a finite quotient. A map A  B is a finite quotient if B is obtained from A by attaching cells induced by a finite number of pointed maps i : Sni  A, with ni  0 for all i. Using multi-index notation, we write the induced map i Sni  A as , and B as A/(). See §B.6 for details.
Proposition 6.4.1. Suppose that B is a finite quotient over A. Then DB/A is affine over Spec A[t-1].
Proof. Write B = A/() for  : Sn  A the pointed map associated to B. Since B is compact over A, by Corollary 6.3.8 it suffices to show that HB preserves limits.
Let Q  AlgZA[t-1], and write q for the image of t-1 under the structure map A[t-1]  Q. Also, write (Q) for the composition of  with A  Q.
We have a fibre sequence Q -×-q Q  Q, and thus a fibre sequence Q1  Q0  GA(Q). Therefore, in the following commutative diagram

AlgA(B, GA(Q)) {(Q)}

S(Sn, Q1)
S(Sn, Q0)
36

{0} S(Sn, GA(Q))

the square on the right is Cartesian. By the universal property of B (Lemma B.6.4), the outer square is Cartesian as well. It follows that there is a dashed arrow as indicated that makes the square on the left Cartesian.
We just saw that
AlgA(B, GA(-))  {(-)} ×S(Sn,(-)0) S(Sn, (-)1)
as functor AlgZA[t-1]  S. Since limits in AlgZA[t-1] are computed degree-wise, this functor thus preserves limits, which was to be shown.
6.5. Quasi-smooth A-algebras and their Rees algebras. Recall that a closed immersion Z  X is quasi-smooth if locally on X it is a pullback of the map {0}  An, for some n, along some map X  An. A surjection A  B is quasismooth if the corresponding map on spectra is.
Example 6.5.1. Any surjection of the form A  B = A[X]/(f ), where f = f1, . . . , fn is a sequence of points in A[X] = A[X1, . . . , Xk], is quasi-smooth. Indeed, by [KR18, Prop. 2.3.8], it suffices to show that the shifted cotangent complex LB/A[-1] is a locally free B-module of finite rank. But this follows from [KR18, Prop. 2.3.14] and its proof.
Proposition 6.5.2. If A  B is a quasi-smooth surjection, then DB/A is affine over Spec A[t-1].
Proof. Since the question is local on Spec A, we may assume that A  B is of the form A  A/(a1, . . . , an) for certain points ai  A. Then the claim follows from Proposition 6.4.1.
6.6. Rees algebra of a closed immersion. We now show the general case of any closed immersion Z  X. Recall that we may assume Z  X to be of the form Spec B  Spec A. The strategy is roughly as follows. We can obtain B from A by attaching an infinite number of cells, in order of dimension. We show that in each intermediate step A  B  B, it holds that DB/A will be affine over Spec A[t-1]. The corresponding RBext/A will then assemble into RBex/tA, as the B assemble into B.
Lemma 6.6.1. Suppose that DB/A is affine over Spec A[t-1]. Let  : Sn  B be a given pointed map, for n > 0, and put B := B/(). Then DB/A is affine over Spec A[t-1].
Proof. By Remark 6.3.6 and Lemma 6.3.7, we need to show that HB preserves limits and -filtered colimits for some regular . This functor can be written as
HB : AlgZA[t-1]  S Q  AlgA(B, GA(Q)) ×AlgA(A[Sn],GA(Q)) {0}
Since DB/A is affine over Spec A[t-1], it suffices to show that DA[Sn]/A is so as well. Since A[Sn]  A/(Sn-1 -0 A), this is indeed so by Proposition 6.4.1.
Clearly, the proof of Lemma 6.6.1 uses that n > 0. Luckily, it will turn out that this is exactly the case that we need, essentially since in assembling B from A by attaching k-cells, we can work in order of the dimension k.
Lemma 6.6.2. Suppose that B is a colimit of A-algebras B such that DB/A is affine over Spec A[t-1], for all . Then DB/A is affine over Spec A[t-1].
37

Proof. By Lemma 6.3.7, it suffices to show that HB is corepresentable. Let Q  AlgZA[t-1] be given. Then we have natural equivalences
HB(Q) = AlgA(B, GA(Q))  lim AlgA(B, GA(Q))  lim AlgZA[t-1](RBext/A, GA(Q))  AlgZA[t-1](colim RBext/A, GA(Q))
Hence DB/A is affine over Spec A[t-1], and in fact DB/A = Spec(colim RBext/A).
Lemma 6.6.3. For any map A  B, there is a sequence A = B0  B1  · · ·  Bn  . . . in AlgA/B, indexed by n  N, such that the map colim Bn  B is an equivalence, and with all Bk  Bk+1 obtained by attaching infinitely many k-cells to Bk.
Proof. This follows by a small objects type of argument, which is essentially the same as in [EKMM97, Thm. 2.10].
Proof of Theorem 6.3.3. Using Lemma 6.6.3, take a sequence A = B0  B1  · · ·  Bn  . . . , indexed by n  N, such that Bk  Bk+1 is obtained by attaching k-cells to Bk, and with B = colim Bn.
We will first show that DB2/A is affine over A1X . As before, we observe that A  B2 is surjective. Moreover, by assumption this map is of the form A  A[X]/(f ) for variables X = X1, X2, . . . and relations f = f1, f2, . . . (both possibly infinite).
Let C be the category of sets of the form {Xi1 , . . . , Xin , fj1 , . . . , fjm }, where all the fjk are in A[Xi1 , . . . , Xin ], and for which the map A  A[Xi1 , . . . , Xin ]/(fj1 , . . . , fjm ) is surjective. Morphisms in C are the inclusions. For each such object, we have a factorization of A  B2 as A  A[Xi1 , . . . , Xin ]/(fj1, . . . , fjm )  B2. Now the induced map
colim{Xi1 ,...,Xin ,fj1 ,...,fjm }C A[Xi1 , . . . , Xin ]/(fj1 , . . . , fjm )  B2 is an equivalence of A-algebras. Indeed, we can write
A[Xi1 , . . . , Xin ]/(fj1 , . . . , fjm )  A[Xi1 , . . . , Xin ] A[Fj1 ,...,Fjm ] A from which the claim follows by the fact that colimits commute with tensor products.
Since all the maps A  A[Xi1 , . . . , Xin ]/(fj1 , . . . , fjm ) are quasi-smooth by Example 6.5.1, we have that D(A[Xi1 ,...,Xin ]/(fj1 ,...,fjm ))/A is affine over A1X by Proposition 6.5.2, and thus that DB2/A is affine over A1X by Lemma 6.6.2.
Now let k  2, and assume that DBk/A is affine over A1X . We will show that DBk+1/A is as well. With a similar argument as before, we write Bk+1 as a colimit of Bk-algebras B, which are each obtained from Bk by attaching a finite number of k-cell. By Lemma 6.6.1, each DB/A is affine over A1X , hence by Lemma 6.6.2 so is DBk+1/A.
By induction, we conclude that DBn/A is affine over A1X , for all n  0. Since B = colim Bn, the statement follows from another application of Lemma 6.6.2.
6.7. Structural induction. We will isolate the proof strategy used in Theorem 6.3.3, since we will have chance to use it again on several occasions.
Definition 6.7.1. For A  Alg, write SurA for the full subcategory of AlgA spanned by the surjections.
Let P be a property of closed immersions Z  X. For A  Alg, write PA for the corresponding property of objects in the category SurA.
Lemma 6.7.2. Suppose that P satisfies the following properties:
38

(1) It is local on X. (2) It holds for any Spec B  Spec A for which A  B is a finite quotient. (3) The property PA is stable under filtered colimits in SurA, for any A  Alg. (4) If PA holds for a surjection A  B, then it also holds for A  B/(), for
any pointed map  : Sn  B with n  1.
Then P holds for any closed immersion Z  X.
Proof. From (1) and (2) it follows that P holds for any quasi-smooth map Z  X. By (1), we can and will assume that Z  X is of the form Spec B  Spec A.
Now write A  B as A = B0  · · ·  Bn  · · ·  B, with Bk  Bk+1 obtained by attaching k-cells, and B = colim Bn. By (3), it suffices to show that PA holds for all A  Bn, n  2.
From the proof of Theorem 6.3.3 it follows that B2 is in fact a filtered colimit of A-algebras B, such that each A  B is surjective and quasi-smooth. It follows that PA holds for all A  B, and hence for A  B2 by (3).
Now suppose that PA holds for A  Bk with k  2. Again we can write Bk+1 as a filtered colimit of Bk-algebras B, each obtained from Bk by attaching a finite number of k-cells. Since   B is a filtered diagram, it also holds that Bk+1  colim B as A-algebras. Hence, by (3), and by induction on the number of k-cells, we may assume that Bk+1 is of the form Bk/() for certain  : Sk-1  Bk. By (4), PA now also holds for A  Bk+1.
By induction, PA holds for all A  Bn, n  2, which was to be shown.
6.8. Base change of Rees algebras. Let still Z  X be a closed immersion, let f : X  X be a map of schemes, put Z := Z ×X X. Recall the map X : BGm,X  [A1X /Gm,X] induced by the zero section from §6.3. Letting X vary in this notation, it holds that X is the pullback of X . Observe that we then have a map
k : DZ/X  DZ/X
induced by the maps DZ/X  ResX ([Z/Gm,X])  ResX ([Z/Gm,X ]) and DZ/X  A1X  A1X .
Proposition 6.8.1. The map k exhibits DZ/X as pullback of DZ/X along A1X  A1X . Consequently, we have an equivalence ReZxt/X  f ReZx/tX of Z-graded OX algebras.
Proof. This follows from Lemma 6.1.5.
Corollary 6.8.2. The map k induces an equivalence ReZxt/X  f ReZx/tX of Zgraded OX -algebras.
Proof. Use Proposition 6.8.1 and the pasting law for pullbacks.
In fact, in §6.10 we will see that OX [t-1]  ReZx/tX is an equivalence in degree  0. It follows that ReZx/tX is N-graded.
6.9. An explicit formula for the Rees algebra of a finite quotient. The proof of Theorem 6.3.3 shows that for any closed immersion Z  X, the Rees algebra ReZx/tX is locally on X a colimit of Rees algebras of finite quotients. Here we will give an explicit formula for the Rees algebra of finite quotients.
Lemma 6.9.1. For a surjection A  B, we have equivalences
AlgZA[t-1](RBex/tA, Q)  St/[A1X /Gm,X](Spec Q, DZ/X )  AlgA(B, GA(Q))
natural in Q  AlgZA[t-1] and B  AlgA.
39

Proof. This follows from Theorem 6.3.3 and the equivalences in (6.3).
Recall that we can adjoin a simplicial set K to an algebra A to get a new algebra A[K]. There is also a graded version of this available. Using this, we define an Aalgebra A[v] with v free of degree d and level n, see §B.5 for details. This has the universal property that AlgZA(A[v], B) is equivalent to the space of pointed maps Sn  Bd, for any graded A-algebra B.
Notation 6.9.2. For B  AlgZ and  : Sm  Bd a pointed map, we write B/( ) for the pushout in AlgZ of A[v]  B along the map A[v]  A induced by 0 : Sm  A, where v is free of level m, degree d. Similarly for multi-index notation.
Proposition 6.9.3. Let A  B be a finite quotient, say B = A/() for  = 1, . . . , k, with i : Sni  A pointed maps. We then have an equivalence
RBex/tA  A[v, t-1]/(vt-1 - )
of Z-graded A[t-1]-algebras, where v = v1, . . . , vk with the vi free of degree 1 in level ni.
Proof. By Lemma 6.9.1 and the proof of Proposition 6.4.1, we have an equivalence
AlgZA[t-1](RBex/tA, -)  {(-)} ×S(Sn,(-)0) S(Sn, (-)1)
as functors AlgZA[t-1]  S, where as before (Q) means the composition of  with the structure map A  Q.
On the other hand, by construction we have a pullback square

AlgZA[t-1](A[v, t-1]/(vt-1 - ), Q)

S(Sn, Q1)

(id,×t-1-)

S(Sn, Q1)
(id,0)
S(Sn, Q1) × S(Sn, Q0)

of spaces, for each Q  AlgZA[t-1]. We therefore also have an equivalence
AlgZA[t-1](A[v, t-1]/(vt-1 - ), -)  {(-)} ×S(Sn,(-)0) S(Sn, (-)1)
as functors AlgZA[t-1]  S, from which the claim follows.
Corollary 6.9.4. The Rees algebra RZ/X is generated in degree 1.
Proof. Say that a closed immersion Z  X has property P if RZ/X is generated in degree 1. We will check that P satisfies the conditions of Lemma 6.7.2.
Clearly, P is local on X. Observe that the case where Z  X corresponds to a finite quotient A  B immediately follows from the explicit formula in Proposition 6.9.3. Also, when X = Spec A, then P is stable under filtered colimits in the category SurA of surjections A  B.
Now suppose that P holds for Spec B  Spec A, and let  : Sn  B with n  1 be a pointed map. Put B := B/(). From the proof of Lemma 6.6.1 it follows that RBext/A  RBex/tA ReAxt/A A[t-1], where A = A/(Sn-1 -0 A). Hence by assumption on B and by the case of finite quotients, RBext/A is generated in degree 1.
6.10. The Rees algebra adjunction.
Definition 6.10.1. Let ReesA be the full subcategory of AlgZA[t-1] = (AlgZA)A[t-1]/ spanned by those Z-graded A-algebra maps A[t-1]  R for which the induced Z0graded map A[t-1]  R0 is an equivalence. Objects of ReesA are called extended Rees algebras over A.
40

Remark 6.10.2. Neither the category SurA nor ReesA is presentable, since these categories do not have all products.

Remark 6.10.3. Notwithstanding Remark 6.2.3, the restriction GA : ReesA  AlgA does preserves all colimits. Indeed, by [HTT, Prop. 4.4.2.7], it suffices to show that GA preserves pushouts and coproducts of extended Rees algebra.
For the claim on pushouts, let R, R, R be extended Rees algebras. Then since (-) A[t-1] A preserves colimits, it holds that
GA(R R R)  (R R R)0  GA(R) GA(R) GA(R)
where in the last equivalence we have used that, by Proposition 2.8.1, (BB B)0  B0 B0 B0 for Z-graded algebra B, B, B concentrated in degrees  0.
The claim on coproducts is similar, using that also (-)0 commutes with coproducts of Z-graded algebras concentrated in degree  0, again by Proposition 2.8.1.
The reason that this argument does not work in the general case GA : AlgZA[t-1]  AlgA is because Q A[t-1] A may not be concentrated in degree  0 for Q  AlgZA[t-1], as seen in Remark 6.2.3.
Proposition 6.10.4. We have an adjunction R(e-xt)/A  GA(-) : SurA  ReesA.
Proof. By Lemma 6.9.1, it suffices to show that R(e-xt)/A(SurA)  ReesA and that GA(ReesA)  SurA.
To show that R(e-xt)/A(SurA)  ReesA, we use the obvious affine version of Lemma 6.7.2. Clearly, the question is local on Spec A and stable under filtered colimits in SurA. The case where A  B is a finite quotient follows from Proposition 6.9.3. The case where A  B is of the form A  B0/(), for certain B0  AlgA for which RBex0t/A  ReesA and with  : Sn  B0, n  1 a pointed map, follows from a similar argument as in Corollary 6.9.4.
Conversely, let R  ReesA. Then 0GA(R) is the underived quotient 0A/0R1, since 0R is the underived quotient 0R/(t-1), and since (-)0 commutes with 0. It follows that A  GA(R) is surjective.
Next we want to show that R(e-xt)/A is fully faithful. We first record the following variation on the well-know fact that a left adjoint F is fully faithful if and only if the corresponding unit  is an equivalence. The variation seems folklore in the setting of -categories, but see e.g. [Stcks, Tag 07RB] for the corresponding statement on 1-categories.

Lemma 6.10.5. Let F  G : C  D be an adjunction with unit . Then F is fully faithful if there is some equivalence idC  GF .

Proof. Suppose that idC  GF , so that GF is fully faithful. Then for x, x  C it holds that in the following sequence

(6.4)

C(x, x) -F D(F x, F x) -G C(GF x, GF x) -x C(x, GF x)

the composition of the first two arrows is an equivalence. By adjunction, the composition of the second two arrows is also an equivalence. By two-out-of-six, we conclude that all arrows in the diagram are equivalences. In particular, the first arrow is an equivalence, i.e., F is fully faithful.

Proposition 6.10.6. The functor R(e-xt)/A : SurA  ReesA is fully faithful.
Proof. Let B  SurA be given. By Lemma 6.10.5, it suffices to give some equivalence B : B  GA(RBex/tA), natural in B. Write Spec B  Spec A as Z  X.
41

Let  be the structure map BGm,X  X. Recall that  : Alg(BGm,X )  AlgZ(X)  Alg(X) corresponds to (-)0, and  to endowing an algebra with the
trivial action. Also recall, from Remark 2.4.3, that the relative spectrum functor furnishes an equivalence from Alg(BGm,X)op to the category Aff/BGm,X of algebraic stacks affine over BGm,X . The inverse of Spec is given by the global sections functors, denoted .
Write  : [X ×A1X X/Gm,X]  BGm,X for the pullback of X along itself. By Lemma 6.1.5, and since [DZ/X /Gm,X]  ResX ([Z/Gm,X ]), it holds

(6.5)

GA (RBex/tA )



 [DZ/X

×A1 X

X/Gm,X ]



 Res [Z

×A1 X

X/Gm,X ]

Recall from Proposition 2.8.1 that the functors ,  restricted to N-graded algebras also give an adjunction    : AlgN(S)  Alg(S). Observe that Res [Z ×A1X X/Gm,X] is affine over BGm,X , since DZ/X ×A1X X is affine over A1X . Therefore, for any A-algebra Q, it holds

AlgA( Res [Z ×A1X X/Gm,X], Q)  AlgNA( Res [Z ×A1X X/Gm,X], Q)  Aff/BGm,X (Spec Q, Res [Z ×A1X X/Gm,X])
Now combining this with (6.5) and using the universal property of the Weil restriction, we get that

AlgA(GA(RBex/tA), Q)  AlgZAA[t]A(B A[t] A, Q A[t] A)  AlgNA(B, Q A[t] A)

Now since (-)0 : AlgNA  AlgA is a left adjoint, it commutes with pushouts. It follows that

AlgA(GA(RBex/tA), Q)  AlgA(B, (Q A[t] A)0)  AlgA(B, Q)

By naturality in Q, we thus have an equivalence GA(RBex/tA)  B. Since all of the above equivalences are also natural in Z, the claim follows.

Remark 6.10.7. By what we have just seen, the essential image of the functor R(e-xt)/A : SurA  ReesA captures the theory of closed immersions into Spec A. In the classical case, the latter is equivalent to the theory of ideals of A, as is wellknown. In the derived setting, for a closed immersion A  B, we do have an exact sequence
RBex/tA -×-t--1 RBex/tA  RBex/tA
from which it follows that (RB/A)1 is the fibre of A  B. But observe that in the derived setting there is no obvious way of defining ideals of A, let alone recover B from this.

6.11. Example: Classical Rees algebra of a regular embedding. Let A be

classical, a = a1, . . . , an  A a regular sequence, and B := A/(a). Recall that a

being regular is equivalent and that it coincides with

ttoheBclbaesisnicgacl leaxsstiecnadl.edWRe ewesillaslgheobwrathoaftARBex/tA0isBd=iscBre.te,

By Proposition 6.9.3, we know that RBex/tA is the quotient A[v, t-1]/(vt-1 - a).

Now observe that {vit-1-ai}i is a regular sequence in A[v, t-1] by [Stcks, Tag 0625],

since a, v is regular. It follows that the quotient is isomorphic to the underived,

hence discrete, quotient.

Let I be the (underived) kernel of A  B. Then the map A[It, t-1]  RBex/tA of A[t-1]-algebras, defined by sending ait to vi, is an isomorphism. It follows that RBex/tA coincides with the classical extended Rees algebra.

42

We also make the following observation:

RBex/tA 

n0 In/In+1  Symcl NB/A

where the quotient In/In+1, the symmetric algebra, and the conormal sheaf are classical. The first equivalence follows from the fact that t-1 is regular, and the second from the fact that Spec B  Spec A is a regular embedding in the classical
sense.

7. Blow-ups
We will define the blow-up of an arbitrary closed immersion Z  X using the corresponding Rees algebra, and recover the construction from [KR18] in the quasismooth case. We close with the deformation to the normal cone, which generalizes [KR18, Thm. 4.1.13] to arbitrary closed immersions.
7.1. Blow-ups via Rees algebras. Recall that we defined the projective spectrum for quasi-coherent, N-graded algebras generated in degree 1. Since RZ/X is generated in degree 1 by Corollary 6.9.4, the following thus makes sense.
Definition 7.1.1. Let Z  X be a closed immersion. Define the blow-up of Z in X as the scheme BlZ X := Proj RZ/X over X.
For Z  X classical, we write BlcZl X for the classical blow-up of Z in X. The following example show that in general we do not have BlcZlcl Xcl  (BlZ X)cl. However, if Z, X are classical, then Proposition 7.1.4 does give us BlcZl X  (BlZ X)cl.
Example 7.1.2. Let A be a discrete ring and B := A/(0) the derived quotient. Then R := RBex/tA is the discrete graded ring A[st, t-1]/(s) with deg s = 0 and deg t = 1, since s is regular on the discrete ring A[st, t-1]. However, t-1 is not a regular element of R, and therefore R is not discrete. Indeed, in degree d > 0, we have a fibre sequence Rd -×-t--1 Rd-1  Rd-1 of A-modules, which is just the fibre sequence A -0 A  B. Hence the underlying A-module of R is d0 B.
To compute the blow-up of Spec B in Spec A, write R as A[v, t-1]/(vt-1), where deg(v) = 1. Then R0 = A[v], and hence
BlSpec B Spec A = Proj R0 = Proj A[v] = Spec A,
since the derived projective spectrum of a discrete ring is given by the classical Proj-construction. Observe that this result is what we expect according to [KR18, Thm. 4.1.5.viii].
Example 7.1.3. Let Z  X be a regular embedding of classical schemes. Then BlZ X is classical, and coincides with BlcZl X. This follows from the example in §6.11, together with the fact that the projective spectrum of a discrete algebra R coincides with the classical projective spectrum of 0R.
Proposition 7.1.4. Let Z  X be a closed immersion of classical schemes. Then the underlying classical scheme of BlZ X is BlcZl X.
Proof. The question is local, so let a surjection A  B of discrete rings be given. Then it suffices to show that 0RBex/tA coincides with the classical extended Rees algebra of B over A.
Let Q be a discrete Z-graded A[t-1]-algebra for which t-1 is not a zero-divisor. Write clAlgA(-, -) for the hom-set of discrete A-algebras, and similarly for the
43

graded version. Note that Q and hence GA(Q) are discrete. We thus have isomorphisms
clAlgZA[t-1](0RBex/tA, Q) = AlgA(B, GA(Q)) = clAlgA(B, GA(Q))
where we have used that 0 is a left adjoint and Lemma 6.9.1. The claim now follows from the universal property of the classical extended Rees algebra from §1.3.
Proposition 7.1.5. Blow-ups commute with pullbacks. That is, for Z  X a closed immersion and X  X any map, we have BlZ×X X X  (BlZ X) ×X X.
Proof. This follows from Proposition 6.8.1, together with the fact the Proj(-) commutes with pullbacks.
Corollary 7.1.6. For any closed immersion Z  X, the map BlZ X  X is an equivalence on X \ Z.
Proof. Note that (BlZ X) ×X (X \ Z)  Bl(X \ Z) by Proposition 7.1.5. It thus suffices to show that for any scheme X, it holds that Bl X  X is an equivalence. The latter follows from the explicit formula in Proposition 6.9.3. Namely, the map A  0 is equivalent to the quotient A  A/(1). Hence R0/A  A[t], and thus Bl Spec A  Proj A[t]  Spec A.
Recall that a diagram Z  X  X of classical schemes is called Tor independent if the fibre product Z ×X X is classical.
Corollary 7.1.7. Let Z  X  X be a Tor independent diagram of classical schemes. Then BlcZl×XX X = (BlcZl X) ×X X.
Proof. Use Proposition 7.1.5 and 7.1.4, and continuity of (-)cl.
Example 7.1.8. For X  Sch it holds that BlX X = . To see this, by Proposition 7.1.5, we may assume that X = Spec A. Now RAex/tA = A[t-1], and Proj A = , from which the claim follows.
7.2. Naturality in the target. Suppose we have a commutative diagram of schemes of the form
ZhW
XfY where the vertical arrows are closed immersions. Recall that X : BGm,X  [A1X /Gm,X] is the map induced by the zero section, likewise for Y . Then, by Lemma 6.1.5, we have a map
 : ResX ([Z/Gm,X ])  ResY ([Z/Gm,Y ])
Lemma 7.2.1. The map  induces an equivariant map DZ/X  DW/Y over A1Y .
Proof. We have maps DZ/X  ResX ([Z/Gm,X ])  ResY ([Z/Gm,Y ]) and DZ/X  A1X  A1Y that make the obvious square commute, which gives us the map DZ/X  DW/Y over A1Y . It is equivariant because it is induced by equivariant maps.
Proposition 7.2.2. Suppose f : X  Y is a closed immersion and that h is the identity. Then DZ/X  DZ/Y induces a closed immersion BlZ X  BlZ Y over Y.
44

Proof. The question is local on Y , so we may assume that Z  X  Y is of the
form Spec B  Spec A  Spec C. Write  : RB/C  RB/A for the graded map of C-algebras induced by Lemma 7.2.1. We claim that  is surjective, and that the
induced map on projective spectra gives us the closed immersion BlZ X  BlZ Y .
For surjectivity, since RB/A is generated in degree 1, and since  is the surjection C  A in degree 0, it suffices to show that  is surjective in degree 1. Recall from Remark 6.10.7 that multiplication with t-1 induces a fibre sequence (RB/A)1  A  B. Write (RB/A)1 := FB/A, and likewise FB/C for the fibre of C  B.
The long exact sequence associated to FB/C  C  B lives over the sequence associated to FB/A  A  B via obvious maps. From a diagram chase on the resulting diagram, it follows that 0FB/C  0FB/A is surjective.
It is clear from the construction of the relative spectrum that ProjY (RB/A)  ProjX (RB/A), since X, Y are affine. Hence, since  is surjective, it induces a closed immersion g : BlZ X  BlZ Y over Y by §5.2.

7.3. Virtual Cartier divisors. We review the notion of virtual Cartier divisors, which is used in [KR18] to define blow-ups in quasi-smooth centres.

Definition 7.3.1. Let S be a scheme.
· A virtual Cartier divisor on S is a closed immersion D  S of virtual codimension one, that is, it is Zariski locally on S given as Spec A/f  Spec A for some point f  A.
· A generalized Cartier divisor on S is a line bundle L  Pic(S), together with a map L  OS in QCoh(S).
If i : D  S is a virtual Cartier divisor on S, then the fibre L  OS  iOD gives a generalized Cartier divisor on S. And in fact, this construction gives an equivalence of the space of virtual Cartier divisors to the space of generalized Cartier divisors.

Definition 7.3.2. Let i : Z  X be a closed immersion. The conormal sheaf of i is the shifted cotangent bundle NZ/X := LZ/X [-1].
Now let S be a scheme over X. Then a virtual Cartier divisor on S over (X, Z),
written (S, D), is a commutative square

(7.1)

D

S

g

Z

X

such that:
(1) D  S is a virtual Cartier divisor; (2) the square is Cartesian in the classical sense on the underlying classical
schemes; (3) gNZ/X  ND/S is surjective.
Write vDivZ X(S  X) for the space of virtual Cartier divisors on S over (X, Z).

Observe that virtual Cartier divisors on S over (X, Z) pull back along maps S  S over X, since ND/S is stable under pull-backs. Thus vDivZ X gives a functor dScho/pX  S. One of the main results in [KR18, Thm. 4.1.5] is the following: if Z  X is quasi-smooth, then vDivZ X is representable by a scheme.
Lemma 7.3.3. Virtual Cartier divisors over (X, Z) pull back along maps X  X. That is, for Z := X ×X Z and (S, D) a virtual Cartier divisor over (X, Z), the pullback D  S of D  S is a virtual Cartier divisor over (X, Z).
45

Proof. The first two conditions from Definition 7.3.2 are clear. The third condition follows from the fact that the conormal sheaf commutes with base change and the fact that pulling back quasi-coherent sheaves is exact.

7.4. A virtual Cartier divisor over (X, Z). Let B be the OX -algebra corresponding to the quasi-smooth closed immersion i : Z  X. Consider ReZx/tX
as a graded OZ-algebra via the map B  ReZx/tX . Throughout, put EZ/X :=
ProjZ (ReZx/tX ). We will first give a virtual Cartier divisor over (X, Z) of the form (BlZ X, EZ/X ), and in the next section show that the map BlZ X  vDivZ X thus induced by the universal property of vDivZ X is an equivalence in the case that Z  X is quasi-smooth.
To get a commutative square as in (7.1), with (S, D) = (BlZ X, EZ/X ), by Proposition 7.1.5 it suffices to give a map k : EZ/X  BlZ×XZ/Z of schemes over Z. By §5.2, it thus suffices to give a surjective map

 : iRZ/X  RZ×X Z/Z  ReZx/tX of graded OZ-algebras. We define  to be the adjoint of the map
RZ/X  ReZx/tX  ReZx/tX  iReZx/tX Lemma 7.4.1. The map  is a surjective map of graded OZ-algebras.

Proof. The question is local on X, so we assume that Z  X corresponds to a surjection A  B. Then  is the composition of the map RBAB/B  RBext AB/B with the map

 : RBext AB/B  RBex/tA A B  RBex/tA
induced by the inclusion of B as the degree-zero part of RBex/tA and by the quotient map RBex/tA  RBex/tA.
To see that  is surjective, notice that RBex/tA  RBex/tA is surjective, hence that  is surjective. Since RBex/tA is concentrated in positive degrees and the map RBAB/B  RBext AB/B is the identity in positive degrees, the claim follows.

Consider now the square

(7.2)

EZ/X k BlZ X
g

Z

X

induced by .

Lemma 7.4.2. The map k is a virtual Cartier divisor.

Proof. The question is local on X, so we assume that Z  X corresponds to a surjection A  B. Let f be a point in (RB/A)1, and write f  for the image of f in RBex/tA. The map (RB/A)f  (RBex/tA)f is an equivalence in degree 0. By exactness of localization, it follows that locally k corresponds to the ring map
(RB/A)(f)  (RBex/tA/(t-1))(f)  (RBex/tA)(f)/(t-1)
from which it follows that k is a virtual Cartier divisor.

Lemma 7.4.3. The underlying square of (7.2) of classical schemes is Cartesian.
46

Proof. Again we assume that Z  X is of the form Spec B  Spec A. Write Projcl(-) for the classical projective spectrum. To see that the square (7.2) is Cartesian on the underlying classical schemes, it suffices to show that the natural map
 : 0RB/A 0A 0B  0RBex/tA
is an isomorphism, where the tensor product on the left is underived. Let I be the kernel of 0A  0B. Let  be the map 0(RBex/tA)1  0A given
by multiplication with t-1. Then I = im( ). It follows that  is the graded map of N-graded rings
0(RB/A)/(im( )0(RB/A))  0(RBex/tA)/(t-1)
induced by the inclusion 0(RB/A)  0(RBex/tA). To show that this is an isomorphism, it suffices to check this on each degree d  0. And indeed  is an isomorphism in degree d, since
t-1(0RBex/tA)d+1 = t-1(0RBex/tA)1(0RBex/tA)d = im( )(0RB/A)d,
since 0(RB/A) is generated in degree 1.
Remark 7.4.4. Let K - L - M be a sequence of spaces. We then have a fibre sequence fib()  fib()  fib(), where fib(-) means the fibre. It follows that if S  S and T  T  are maps of R-algebras with connected fibres, then so is the map S R T  S R T , since it factorizes as
S R T  S R T   S R T ,
both of which have connected fibres.
Proposition 7.4.5. The square (7.2) is a virtual Cartier divisor over (X, Z).
Proof. It remains to show that gNZ/X  NEZ/X/ BlZ X is surjective on 1. With the same argument as in [KR18, Rem. 4.1.3.iii] -- which also works in the nonquasi-smooth case -- under the facts that we have already shown, it holds that (7.2) is a virtual Cartier divisor over (X, Z) if and only if OBlZ×X Z/Z  hOE is surjective on 1, for the obvious map h : E  BlZ×XZ/Z .
Say that a closed immersion Z  X has property P if the corresponding map OBlZ×X Z/Z  hOE is surjective on 1. We will verify that P satisfies the conditions of Lemma 6.7.2, and thus conclude that all closed immersions satisfy P. Clearly, P is local on X and stable under pullbacks.
Now let Z  X be a closed immersion corresponding to a finite quotient A  B, say where B = A/() for certain  = 1, . . . , k, with i : Sni  A pointed maps. Let K be the pointed space Sn1  · · ·  Snk . Put AK := Spec(Z[K]). Observe that Z  X is a pullback of {0}  AK along the map X  AK induced by . To show that P holds for Z  X, it thus suffices to show that P holds for {0}  AK , by Lemma 7.3.3.
Put W := Spec(Z Z[K] Z). It suffices to show that  : RW/{0}  R{ex0t}/AK is surjective on 1. By Proposition 6.9.3,  is the obvious map
Z[v, t-1]/(vt-1) 0  Z[s, v, t-1]/(vt-1 - s, t-1)
where v = v1, . . . , vk and s = s1, . . . , sk are variables with vi, si free in degree 1 and level ni. Now the map
Z[s, v, t-1]/(vt-1 - s, t-1)  Z[v, t-1]/(vt-1) 0
of Z[v]-algebras, defined by si  vit-1 and t-1  0, is a section of . The claim follows.
47

Property P on any closed immersion Spec B  Spec A is equivalent to the property that

(f ) : (RBAB/B )(f )  RBex/tA (f )
is surjective on 1, for any f  (RBAB/B)1 and f  := (f ). This, in turn, is equivalent to the fibre of (f) being connected, for all f , because (f) is an isomorphism on 0. From the fact that taking fibres commutes with filtered colimits, it now follows that P is stable under filterd colimits in SurA.
Finally, suppose that P holds for a closed immersion Z  X of the form Spec B  Spec A, and let  : Sn  B be given with n  1. We need to show that P holds for Spec B  Spec A, where B := A/().
By twice applying Proposition 6.8.1, we see that

RBAB/B  RBAB/B B B B B

Also, since R(e-xt)/A is a left-adjoint, we see that

RBext/A  RBex/tA ReAx[tSn]/A A

Now let f  (RBAB/B )1, put f  := (f ). We need to show that the fibre of (f) is connected.

For simplicity, assume that f is of the form g  , with g  RBAB/B. By

assumption, the map (RBAB/B )(g) 

RBex/tA

has a connected fibre, where g
(g )

is the image of g. Also, the map B B B  B is an isomorphism on 0 and is

surjective on 1, since it has a section, and thus has a connected fibre. It follows

that, upon tensoring these two maps, we obtain the map

(f ) : (RBAB/B B B B B)(f )  RBex/tA B B (f )
which has connected fibre by Remark 7.4.4, where f  is the image of f . We can write
RBex/tA B B  RBex/tA A[Sn,t-1] A  RAex[tSn]/A A[Sn,t-1] RBex/tA ReAx[tSn]/A A
This description gives us a map
 : RBex/tA B B  RBex/tA ReAx[tSn]/A A  RBext/A
such that (f)  (f)  (f). Hence, since the fibre of (f) is connected, by Remark 7.4.4, it suffices to show that so is the fibre of (f). The latter follows from the fact that 0((f)) is injective and that (f) has a section.

7.5. The functor of points of BlZ X in the quasi-smooth case.

Definition 7.5.1. Write hZ/X : BlZ X  vDivZ X for the map induced by the virtual Cartier divisor (BlZ X, EZ/X ) from Proposition 7.4.5.

Lemma 7.5.2. The map hZ/X commutes with base change. X  X and Z := Z ×X X, the following diagram
BlZ X  hZ/X vDivZ X 

That is, for given

f

g

BlZ X hZ/X vDivZ X

where the vertical arrows are induced by Lemma 7.1.5 and [KR18, Thm. 4.1.5.2], commutes.

48

Proof. Both ways around the square are induced by the virtual Cartier divisor (BlZ X, EZ/X ) over (X, Z). The case g  hZ/X follows from the fact that g is
defined by composing a virtual Cartier divisor (S, D) over (X, Z) with the pullback square of (X, Z) over (X, Z). The case hZ/X  f follows since f is defined via
pulling back, together with Corollary 6.8.2.

Theorem 7.5.3. If Z  X is quasi-smooth, then the map hZ/X : BlZ X  vDivZ X is an equivalence.

Proof. The question is local on X, so we may assume that Z  X is a base change of the map {0}  An along a map X  An. By Lemma 7.5.2, Proposition 7.1.5 and [KR18, Thm. 4.1.5.ii], we may assume that Z  X is of the form {0}  An. In this case hZ/X is the equivalence Bl{0} An  Blc{l0} An  vDiv{0} An.

7.6. Deformation to the normal cone. The following is an application of the construction of the blow-up, although it does not use the actual blow-up. The goal is to generalize [KR18, Thm. 4.1.13]. We return to an arbitrary closed immersion Z  X, and let B the OX -algebra such that Z = Spec B.

Definition 7.6.1. The normal cone CZ/X of Z in X is the pullback of DZ/X along the zero section X  A1X .
Observe that CZ/X  DZ/X is a virtual Cartier divisor. Since GX (ReZx/tX )  B,
the map B  ReZx/tX , that includes B as the degree-zero part of ReZx/tX , has a canonical retraction by §2.8. We call the corresponding map j0 : Z  CZ/X the zero-section of CZ/X .
By the proof of Theorem 6.3.3, it follows that we have an equivalence

(7.3)

AlgZ(A1X )(ReZx/tX , Q)  Alg(X)(B, GX (Q))

natural in Q  AlgZ(A1X ). Let j : A1Z  DZ/X be the canonical map corresponding to the identity on B via the equivalence (7.3). Write p : DZ/X  A1X for the canonical projection. We call the sequence

(7.4)

A1Z -j DZ/X -p A1X

the deformation to the normal cone.

Proposition 7.6.2. The deformation to the normal cone satisfies the following properties:

(1) It is stable under base change.
(2) The map j is a closed immersion. (3) Restricting to Gm gives us the canonical sequence Gm,Z  Gm,X  Gm,X. (4) Restricting to 0 gives us Z -j0 CZ/X -p0 X, where j0 is the zero-section
and p0 the projection.

Proof. The first point is Corollary 6.8.2. Observe that the sequence (7.4) corresponds to a sequence

(7.5)

OX [t-1]  ReZx/tX  B[t-1]

in AlgZ(X). In degrees  0, this is OX [t-1]  OX [t-1]  B[t-1]. The second map is clearly surjective, as this can be checked locally on X. Thus j is a closed immersion.
For the restriction to Gm, let Gm,Z  U  Gm,X be the pullback of (7.4) to Gm,X . Define

W := ResX ([Z/Gm,X ]) ×[A1X/Gm,X ] [Gm,X /Gm,X ] By construction of DZ/X and the pullback lemma, we have a Cartesian square
49

U
k
Gm,X

W
h
[Gm,X /Gm,X]

which is the pullback of the Cartesian square (6.2) that defines DZ/X along Gm,X  A1X . We will show that h  idX , so that k  idGm,X .
We know that [Gm,X /Gm,X]  X. Observe that we have pullback squares





[Gm,X /Gm,X ]

[Z/Gm,X ]

BGm,X

[A1X /Gm,X ]

By Lemma 6.1.5, it thus holds that W  Res/X (). As a right adjoint, Res/X preserves terminal objects, hence sends  to X. The claim follows.
For the last point, we may simply quotient out t-1 in the sequence (7.5) to obtain OX  ReZx/tX  B.
Lemma 7.6.3. The commutative square

(7.6)

CZ/X

DZ/X

Z × {0}

A1X

is a virtual Cartier divisor over Z × {0}  A1X .
Proof. The statement is local on X, so we may assume that Z  X is of the form Spec B  Spec A. It is clear that (7.6) is classically Cartesian on the underlying classical schemes, and we already know that CZ/X  DZ/X is a virtual Cartier divisor. Write F := RBex/tA A B. By [KR18, Rem. 4.1.3.iii], it remains to show that the map F  RBex/tA induced by (7.6) is surjective on 1. This follows from the fact that the composition RBex/tA  F  RBex/tA is the identity.

Proposition 7.6.4. In the case that Z  X is quasi-smooth, we recover the deformation to the normal cone from [KR18, Thm. 4.1.13]. In particular, in this case we have that CZ/X is equivalent to the normal bundle Spec Sym NZ/X .
Proof. Let BZ/X be BlZ×{0}(X × A1) \ BlZ×{0}(X × {0}). We will give an equivalence DZ/X  BZ/X over A1X , which suffices by [KR18, Thm. 4.1.13] and Proposition 7.6.2.
By the universal property of the blow-up, we have a map
h : DZ/X  BlZ×{0}(X × A1)
over A1X induced by the virtual Cartier divisor on DZ/X over (A1X , Z × {0}) from Lemma 7.6.3. We claim that h induces an equivalence DZ/X  BZ/X .
The statement is local on X and stable under base change. Hence, we may assume that Z  X is of the form {0}  An. In this case, it follows from the fact that for a surjection A  B of discrete rings, the deformation space BlcZl×{0}(X × A1) \ BlcZl×{0}(X × {0}) is isomorphic to the spectrum of the classical extended Rees algebra via the map h, see e.g. [Ful98, §5.1]. In our case, these classical constructions coincide with the derived construction by §6.11.
50

Appendix A. M -graded R-algebras as product-preserving presheaves

Fix a ring R and a commutative monoid M . We present a proof of the fact that AlgM R  P(PolyM R ), as announced in §2.2. We keep the notation from §2.2. Our situation can then be summarized in the following commutative diagram:

Poly  PolyM

(A.1)



e

PolyR d PolyM R

E h

D

AlgM R

consisting of functors which preserve finite coproducts, where e and E send Z[x(d)] to R[x(d)], d and D send R[x] to R[x(0)], h is the inclusion,  sends Z[x] to Z[x(0)], and  sends Z[x] to R[x].
Recall that for any category C with a full subcategory C0  C, we have a restricted Yoneda functor C  P(C0), given by composing the Yoneda embedding C  P(C) with the restriction functor P(C)  P(C0). Since representable functors preserve limits, we in fact get a map C  P(C0). Applying this to PolyM R  AlgM R gives us a functor  : AlgM R  P(PolyM R ) which sends B  AlgM R to
(B) : (PolyM R )op  S
R[x(d1), . . . , x(dn)]  Bd1 × · · · × Bdn
Let  be the colimit-preserving map P(PolyM R )  AlgM R induced by the inclusion PolyM R  AlgM R via [HTT, Prop. 5.5.8.15]. We will show that  is a two-sided inverse of .

Lemma A.0.1. The composition  is equivalent to the identity on P(PolyR).
Proof. Observe that  preserves sifted colimits by Lemma 2.2.6. Therefore,  preserves sifted colimits. Since  is the identity on PolyM R , it follows that  is the identity on all of P(PolyM R ) by [HTT, Prop. 5.5.8.15].
Lemma A.0.2. In the case M = {0}, the functor  : P(PolyR)  AlgR is a two-sided inverse of .

Proof. Consider the adjunction
Sym : cnModR  AlgR : G
from [SAG, §25.2.2], where G is the forgetful functor. Then G preserves sifted colimits by the fact that R[x] is compact projective and since AlgR  S factors through the conservative functor cnModR  S via G. We can thus apply [HA, Prop. 7.1.4.12] to this adjunction. Now since R is a compact projective generator of cnModR by [HA, 7.1.4.15], the object R[x] is thus a compact projective generator of AlgR by [HA, Prop. 7.1.4.12].
By [HTT, Prop. 5.5.8.25], it now follows that  is an equivalence. By Lemma A.0.1 it has two-sided inverse .
Proposition A.0.3. The functor  : AlgM R  P(PolyM R ) is an equivalence of categories with inverse .

Proof. Keep the notation as in diagram (A.1). By Lemma A.0.1, it suffices to show   idAlgM R . Let p : AlgM R  AlgM and q : AlgM R  AlgR be the projections. By definition of AlgM R , it suffices to show that p  p and q  q.
51

For p, consider the following diagram

AlgM R  P(PolyM R )  AlgM R  P(PolyM R )

p

e

p

e

AlgM  P(PolyM )  AlgM  P(PolyM )

where ,  are defined similarly as , . Note that  is the two-sided inverse of . Since the square on the left commutes, it suffices to show that the middle square commutes. Because  is invertible, the latter holds if the rectangle made up
from the middle and the right square commutes. And indeed this holds, since  
idP(PolyM R ). For q one uses a similar diagram, together with Lemma A.0.2.

Appendix B. Cell attachments and finiteness conditions
We collect some additional results that came up on the road to the current constructions and arguments. Even though only §B.5 and §B.6 have been used in the main text -- namely in the explicit formula of the Rees algebra in §6.9, which is non-essential for the construction -- it seems that these results are interesting in their own right. Although most of what follows is well-known, there did not seem to be a satisfactory account in the literature of everything that follows.

B.1. E-algebras. Write E-Alg for the category of E-infinity algebras, and Ecn-Alg 
E-Alg for the full subcategory of spanned by the connective objects. Let  : Alg  Ecn-Alg the functor induced by Poly  Ecn-Alg, as in [SAG, Con. 25.1.2.1]. For R  Alg, write E-AlgR for the category E-Alg(R)/ of E-R-algebras, likewise Ecn-AlgR := Ecn-Alg(R)/.
The functor  induces a functor AlgR  Ecn-AlgR, which we also write as . This functor has a left adjoint L : Ecn-AlgR  AlgR by [SAG, Prop. 25.1.2.4].

B.2. Spectral Yoneda lemma. Write Sp for the category of spectra, and Sp(-) for the stabilization construction. Let C be a stable category. The Yoneda embedding C  P(C) into the category of space-valued presheaves on C induces an embedding
C  Sp(C)  Sp(P(C))  Fun(Cop, Sp)
which induces a functor
MapC(-, -) : Cop × C  Sp
See e.g. [BGT13, §2.3]. For x, y  C, we call MapC(x, y) the mapping spectrum. It has the property that

(B.1)

n MapC(x, y) =

nC(x, y) 0C(x, -ny)

if n  0 if n  0

Notation B.2.1. We write MapR(-, -) for MapModR(-,-) and Map(-, -) for MapSp(-, -).
B.3. Tensoring modules and algebras over spectra and spaces. Throughout, fix R  Alg. Let FreeR : ModR  nf tynf tyR be the functor left adjoint to the forgetful functor U : E-AlgR  ModR, see e.g. [Gep19, §4.4] for explicit details. By [EKMM97, §III.1], the forgetful functor V : ModR  Sp also has a left adjoint R  (-).
52

Lemma B.3.1. The adjunction R  (-)  V induces equivalences
MapR(R  K, M )  Map(K, V (M )) natural in K  Sp and M  ModR.
Proof. Let K : K  V (R  K) be the unit of the adjunction R  (-)  V . We then have a map
MapR(R  K, M ) -V Map(V (R  K), V (M )) --K  Map(K, V (M )), which is an equivalence by (B.1), since V (-) commutes with n for all n.
Example B.3.2. Let n  Z, and put Sn := nS, where S is the sphere spectrum. We claim that R  Sn is R[n], where R[n] is the shifted R-module nR in the stable category ModR. To this end, observe that
MapR(R  Sn, M )  Map(Sn, M )  Map(S, nM )  nM  MapR(R[n], M ) for all R-modules M , where we have used Lemma B.3.1 in the first equivalence.

The example shows that the adjunction R(-)  V restricts to an adjunction on

connective objects. We can thus summarize the situation in the following diagram,

where the horizontal arrows commute with the vertical ones



R(-)

FreeR

S



Sp



V



ModR



E-AlgR

U



R(-)

FreeR

L

S



Spcn



ModcRn



Ecn-AlgR



AlgR



V

U



From the proof of [SAG, Prop. 25.1.2.2], it follows that U  is the forgetful functor AlgR  ModcRn. Therefore, the composition L FreeR is SymR.

Notation B.3.3. For a pointed space K, write R  K as R  K, and put R[K] := SymR(R  K).

Proposition B.3.4. We have an equivalences AlgR(R[K], A)  S(K, A), natural in A  AlgR and K  S.

Proof. Immediate.

Corollary B.3.5. For all R  Alg, A  AlgR, K  S and n  N it holds
(1) 0AlgR(R[Sn], A)  n(A); (2) A[K]  A Z Z[K]; (3) R[S0]  R[x]; (4) R[n]  R

Proof. Straightforward.

B.4. Attaching n-cells. Throughout, fix A  AlgR.
Construction B.4.1. Let  : Sn  A be a given map of pointed spaces. By Proposition B.3.4,  corresponds to a map  : R[Sn]  A of R-algebras. Consider the pushout

R[Sn]

R[n+1]  R



A

B

We say that B is obtained from A by attaching an (n + 1)-cell along . We say that A[x] is obtained from A by attaching a 0-cell.

53

B.5. Graded n-cells. Let n  0. Since AlgA(A[Sn], B)  S(Sn, B), we can think of A[Sn] as attaching a free cell to A in level n. We want to generalize this to graded rings, and attach free cells of level n in degree d. We need the following:

Lemma B.5.1. The forgetful functor G : AlgZA  cnModZA has a left adjoint.
Proof. By the adjoint functor theorem, it suffices to show that G preserves limits
and -filtered colimits for some regular cardinal . Recall that the embedding AlgZA  P(PolyZA)  P(PolyZA) is a right adjoint
([HTT, Prop. 5.5.8.10]), where we have used Proposition A.0.3 in the first equivalence. Hence limits in AlgZA are computed as limits of presheaves, i.e., point-wise. It follows that AlgZA  cnModZA preserves limits.
Since the forgetful functor cnModZA  cnModA is conservative, it suffices to show that  : AlgZA  cnModA preserves -filtered colimits, for some . But  factorizes as the forgetful map AlgZA  AlgA, which is a left adjoint, followed by the map AlgA  cnModA, which preserves -filtered colimits for some . The claim follows.

Notation B.5.2. Write the left adjoint of the forgetful functor AlgZA  cnModZA as SymZA(-).
Since the forgetful functor AlgZA  AlgA is a left adjoint as well, the underlying A-algebra of SymZ(M ) is Sym(M ).

Example B.5.3. If M is concentrated in degree 0, i.e., M = M (0) for M  ModA, then it holds SymZA(M )  SymA(M )(0).

Construction B.5.4. For K  S and d  Z, we have a Z-graded A-algebra A[K(d)] with the universal property that

AlgZA(A[K(d)], B)  S(K, Bd)

For existence, observe that we have adjunctions

A(-)

(-)(0)

(-)·-d

S
 V

  

ModA

(-)0

ModZA

ModZA

(-)·+d

Here, M·+f is the Z-graded A-module which has Md+f in degree d for any Zgraded A-module M , and N (0) is the Z-graded A-module which is N concentrated

in degree 0, for N  ModA.
Now write A d K := ((A  K)(0))·-d for any K  S, and define A[K(d)] := SymZA(A d K). Then we have

AlgZA(A[K(d)], B)  ModZA(A d K, B)  S(K, Bd)

Notation B.5.5. We will write A[Sn(d)] as A[u], and say with words that u is a free variable of level n in degree d. More generally, we write

A[Sn1 (d1), Sn2 (d2), · · · , Snk (dk)]

as A[u1, . . . , uk], and say that ui is free in level ni in degree di.

B.6. Finite quotients.

Notation B.6.1. We will use the following multi-index notation:
· We write n for a sequence of numbers n1, . . . , nk, and let n + 1 be n1 + 1, . . . , nk + 1;
· For such given n, we write Sn for the pointed space Sn1  · · ·  Snk ; · A collection of maps i : Sni  A of pointed spaces is written as  : Sn 
A;
54

· A collection of free variables u1, . . . , uk in level ni and degree di is written u.

Definition B.6.2. A finite quotient is a cell attachment of the form

A[Sn]

A[n+1]



A

A/()

for some i : Sni  A with ni  0.

Remark B.6.3. Let  : Sn  A with n  0 be a given pointed map, and B := A/(). Then 0(B) = 0(A)/([]), where [] is the image of  in 0(A). Hence, if n > 0, then 0(B) = 0(A).
In fact, for all m < n it holds that the map m(A)  m(B) is an isomorphism. To see this, let m be the truncation functor. Then since m is a left adjoint, we have m(B)  m(A) m(A[Sn]) m(A). Then the claim follows from the fact that m(A[Sn])  m(A), since
AlgA(m(A[Sn]), B)  AlgA(A[Sn], B)    AlgA(m(A), B)
for any m-truncated B  AlgA.

Lemma B.6.4. Let A  A/() be a finite quotient. Then this map enjoys the following universal property: for A-algebras B with structure map f : A  B, it holds

AlgA(A/(), B)  {f} ×S(Sn,B) {0} where {f} and {0} are the points (f 1, . . . , f k) and {0, . . . , 0} in S(Sn, B).

Proof. This follows directly from the universal property of A/() as a pushout, together with Proposition B.3.4.

Corollary B.6.5. If ,  : Sn  A are pointed maps which are identical as elements of n(A), then A/  A/.

Proof. This follows from the universal property from Lemma B.6.4.

Example B.6.6. Write  for the unique map 0 : Sn  A. Then A/()  A[Sn+1], since for any A-algebra B we have
AlgA(A/(), B)  S(Sn, B)  S(Sn+1, B)  AlgA(A[Sn+1], B) by Lemma B.6.4 and Proposition B.3.4.

B.7. Finite cellular maps. A map A  B is called finite cellular if B is obtained from A by a finite number of cell attachments, including 0-cells. Observe that being finite cellular is stable under base change and under composition. Also observe that the notion of being finite cellular does not depend on any possible base ring R: if B is obtained from A by attaching an n-cell in AlgR, then it is also obtained from A by attaching an n-cell in AlgR , for any R  R. In particular, we might as well work over Z.

Lemma B.7.1. Let B be a finite cellular A-algebra. Then the multiplication map µ : B A B  B is also finite cellular.
Proof. We induct on the number of cells attached to A to obtain B. So first suppose that B = A/() for certain  : Sn  A.
Let Sn  Sn  1  Sn be the map that sends one copy of Sn to {0} × Sn, and the other copy to {1} × Sn. Using this map, consider the following commutative diagram
55

A[Sn  Sn]

A[n+1  n+1]

A[1  Sn]

A[S n+1 ]

A[n+2]

A

B A B

B

The top left square is a pushout since A[-] is a left adjoint. The two left squares together form a pushout by assumption on B. Hence the bottom left square is a pushout. Now the two bottom squares together from a pushout since A[-] preserves equivalences an by assumption on B, and thus the bottom right square is a pushout. It follows that B A B  B is finite cellular.
The case B = A[x] is straightforward. Now suppose that we have a finite cellular map A  B for which B A B  B is finite cellular, and some  : Sm  B. Put B := B/( ). Then since B A B  B is finite cellular, so is f : B A B  B, since this notion is stable under taking pushouts. Now µ : B A B  B factorizes as
B A B  B B B A B -id--f B B B  B
where the last map is the multiplication map of B as B algebra. As such, this map is finite cellular by the first case. Also, id f is finite cellular since f is, and since this notion is stable under base change. It follows that µ is finite cellular.

B.8. Finitely presented A-algebras.
Definition B.8.1. Let B  AlgA be given. · We say that B is finitely presented if it belongs to the smallest full subcategory of AlgA which contains A[x] and is closed under finite colimits. · We say that B is finite cellular in AlgA if the structure map A  B is finite cellular.
Write AlgfAp for the full subcategory of AlgA spanned by the finitely presented A-algebras.
Lemma B.8.2. Let  : B  C be a map between finite cellular A-algebras. Then C is a finite cellular B-algebra.
Proof. Consider the following commutative diagram

A

B

B

B A B

B

C

B A C

C

consisting of pushout squares. Since B A B  B is finite cellular by Lemma B.7.1, so is B A C  C. Likewise, since A  C is finite cellular, so is B  B A C. It follows that B  C is finite cellular. Also, since the composition B  B in the middle row is homotopic to the identity, the composition B  C is homotopic to
.

Proposition B.8.3. An A-algebra B is finitely presented if and only if it is finite cellular.
56

Proof. It is clear that if B is finite cellular, then it is of finite presentation. For
the converse, let C be the full subcategory of AlgA spanned by the finite cellular A-algebras. Then A[x]  C  AlgfAp. Hence, by definition of AlgfAp, it suffices to show that C is closed under finite colimits.
By [HTT, Cor. 4.4.2.4], it suffices to show that C is closed under pushouts. First observe that for finite cellular A-algebras B, B, the fibre product B A B is finite cellular over A as well. This follows again from the fact that being finite
cellular is stable under pushouts and under composition. Now for the general case, suppose we have maps B  B, B  B with B, B, B
finite cellular. By Lemma B.8.2, we may assume that B, B are finite cellular B-algebras. By the previous case, we know that B B B is a finite cellular Balgebra as well, and thus we have a sequence B = B0  · · ·  Bn = B B B where each Bk  Bk+1 is obtained by attaching a finite number of cells of any dimension. Composing this sequence with a sequence which established A  B as
finite cellular gives us what we want.

Remark B.8.4. There is also the notion of a locally finitely presented A-algebra. This is an A-algebra B which is a retract of a finitely presented A-algebra. Classically, for a retract X -i Y -p X it holds that X is the coequalizer of ip and idY , hence the difference between finitely presented and locally finitely presented disappears in this context. In the -setting this approach does not work, essentially because p need not be an epimorphism in this setting.
Locally finitely presented A-algebras are precisely the compact objects in AlgA, i.e., those A-algebras B for which AlgA(B, -) commutes with filtered colimits.
Proposition B.8.5. Let B be a finitely presented A-algebra. Then we can arrange the sequence A = B0  · · ·  Bn = B of cell attachments in such a way that each Bk  Bk+1 is obtained by attaching a finite number of k-cells to Bk.
Proof. Let a sequence of cell attachments A = B0  B1  · · ·  Bn = B be given. First suppose that there is some i such that Bi-1  Bi  Bi+1 is of the
form Bi-1  Bi-1/()  (Bi-1/())[x] for some pointed map  : Sn  Bi-1 and x = x1, . . . , xm. Write also  for the composition Sn  Bi-1  Bi-1[x]. Then (Bi-1/())[x]  Bi-1[x]/(). We can therefore replace Bi-1  Bi-1/()  (Bi-1/())[x] by Bi-1  Bi-1[x]  Bi-1[x]/(). Repeating this procedure gives us that we can arrange the sequence in such a way that B0  B1 is of the form A  A[y] for certain y = y1 . . . yl and that no other Bk  Bk+1, k > 0 is of this form.
Now suppose that there is some i such that Bi-1  Bi  Bi+1 is of the form Bi-1  Bi-1/()  (Bi-1/())/( ), with  : Sn  Bi-1 and  : Sm  (Bi-1)/() with n > m. Using that m(Bi-1) = m(Bi-1/()), take some   : Sm  Bi-1 such that the composition Sm  Bi-1  Bi-1/() is equivalent to  . Write  for the composition Sn  Bi-1  Bi-1/( ). Consider the following diagram consisting of pushout squares

Bi-1 [S m ]
0
Bi-1

Bi-1 [S n ]





Bi-1

Bi-1/( )
57

0

Bi-1

Bi-1/()

C

where we denote a map Bi-1[K]  Bi-1 induced by some  : K  Bi-1 simply by . Then the two bottom squares and the two right squares establish equivalences
(Bi-1/())/( )  C  (Bi-1/( ))/()
In the given sequence B0  · · ·  Bn, we can thus interchange all cell attachments which are in the wrong order to get what we want.

References

[BGT13] A. J. Blumberg, D. Gepner, and G. Tabuada. A universal characterization of higher

algebraic K-theory. Geometry and Topology, 17(2), Apr 2013.

[BS18]

C. Barwick and J. Shah. Fibrations in ­category theory. In 2016 MATRIX Annals.

Springer, 2018.

[Cis19]

D.-C. Cisinski. Higher Categories and Homotopical Algebra. Cambridge Studies in

Advanced Mathematics. Cambridge University Press, 2019.

[DAGV] J. Lurie. Derived Algebraic Geometry V: Structured Spaces. arXiv e-print, 2009,

0905.0459.

[EKMM97] A. D. Elmendorf, I. Kriz, M. A. Mandell, and J. May. Rings, modules, and algebras

in stable homotopy theory. Number 47. American Mathematical Soc., 1997.

[Ful98]

W. Fulton. Intersection theory. Springer, 1998.

[Gep19] D. Gepner. An introduction to higher categorical algebra, 2019, 1907.02904.

[GHN20] D. Gepner, R. Haugseng, and T. Nikolaus. Lax colimits and free fibrations in -

categories. arXiv e-prints, 2020, 1501.02161.

[Gla13] S. Glasman. Day convolution for -categories. arXiv e-prints, 2013, 1308.4940.

[GR17] D. Gaitsgory and N. Rozenblyum. A Study in Derived Algebraic Geometry: Corre-

spondences and Duality, volume 1. American Mathematical Soc., 2017.

[GW10] U. G¨ortz and T. Wedhorn. Algebraic geometry I. Springer, 2010.

[HA]

J. Lurie. Higher Algebra. Preprint, available at math.ias.edu/~lurie, 2016.

[HAGI] B. To¨en and G. Vezzosi. Homotopical algebraic geometry I: Topos theory. Advances

in mathematics, 193(2), 2005.

[Hin16] V. Hinich. Dwyer­Kan localization revisited. Homology, Homotopy and Applications,

18(1), 2016.

[HLP19] D. Halpern-Leistner and A. Preygel. Mapping stacks and categorical notions of proper-

ness, 2019, 1402.3204.

[HTT]

J. Lurie. Higher Topos Theory. Princeton University Press, 2006.

[KR18] A. A. Khan and D. Rydh. Virtual Cartier divisors and blow-ups. arXiv e-prints, 2018,

1802.05702.

[NSS15] T. Nikolaus, U. Schreiber, and D. Stevenson. Principal -bundles: General theory.

Journal of Homotopy and Related Structures, 10(4), 2015.

[RV18]

E. Riehl and D. Verity. Elements of -category theory. Preprint, available at

math.jhu.edu/~eriehl/elements.pdf, 2018.

[SAG]

J. Lurie. Spectral Algebraic Geometry. Preprint, available at math.ias.edu/~lurie,

2016.

[Stcks]

The Stacks Project Authors. Stacks Project. https://stacks.math.columbia.edu,

2018.

[To¨e14] B. To¨en. Derived Algebraic Geometry. arXiv e-print, 2014, 1401.1044.

58

